<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Editor Bank Soal (Perbaikan Final)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4A90E2;
            --primary-hover: #357ABD;
            --secondary-color: #6c757d;
            --secondary-hover: #5a6268;
            --success-color: #28a745;
            --success-hover: #218838;
            --purple-color: #8e44ad;
            --purple-hover: #732d91;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --background-color: #F7F9FC;
            --card-background: #FFFFFF;
            --text-color: #333;
            --label-color: #555;
            --border-color: #DDE2E8;
            --error-bg-color: #F8D7DA;
            --error-text-color: #721C24;
            --error-border-color: #f5c6cb;
            --info-bg-color: #e2f0ff;
        }

        body.dark-mode {
            --background-color: #121212;
            --card-background: #1E1E1E;
            --text-color: #E0E0E0;
            --label-color: #B0B0B0;
            --border-color: #333333;
            --error-bg-color: #4d2b30;
            --error-text-color: #f4a9b0;
            --error-border-color: #6e3a41;
            --info-bg-color: #1c2a38;
        }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            line-height: 1.6; 
            margin: 0;
            padding: 15px; 
            background-color: var(--background-color); 
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }
        
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease-in-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 30px);
        }
        .card {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.07);
            width: 100%;
            max-width: 450px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .card-header { text-align: center; margin-bottom: 30px; }
        .card-header h2 { margin: 0 0 10px 0; font-size: 1.6em; font-weight: 700; color: var(--text-color); }
        .card-header p { margin: 0; color: var(--label-color); }

        .spinner-container { text-align: center; }
        .spinner {
            width: 50px;
            height: 50px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner-container p { font-size: 1.1em; color: var(--label-color); }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--label-color); font-size: 0.9em; }
        .form-control {
            width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px;
            font-size: 1em; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s, color 0.3s;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .form-control:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); outline: none; }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border: none; border-radius: 8px;
            background-color: var(--primary-color); color: white; font-size: 0.9em; font-weight: 700;
            cursor: pointer; text-align: center; transition: background-color 0.3s, transform 0.2s, opacity 0.3s; text-decoration: none;
            box-sizing: border-box;
        }
        .btn:hover:not([disabled]) { background-color: var(--primary-hover); transform: translateY(-2px); }
        .btn:active:not([disabled]) { transform: translateY(0); }
        .btn-full { width: 100%; }
        
        .btn:disabled, .btn.disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
            pointer-events: none;
        }
        body.dark-mode .btn:disabled, body.dark-mode .btn.disabled {
            background-color: #444;
            color: #888;
        }

        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--secondary-hover); }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover:not(:disabled) { background-color: var(--success-hover); }
        .btn-purple { background-color: var(--purple-color); }
        .btn-purple:hover:not(:disabled) { background-color: var(--purple-hover); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-hover); }


        .error-message { color: var(--danger-color); text-align: center; margin-top: 15px; font-size: 0.9em; display: none; }

        .title-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #editor-view .main-title {
            text-align: center;
            font-weight: 700;
            font-size: 1.8em;
            margin: 0;
            flex-grow: 1;
        }
        
        .editor-header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background-color: var(--card-background);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .identitas-item {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--label-color);
        }

        .identitas-item strong {
            font-weight: 700;
            color: var(--text-color);
        }

        .header-btn {
            width: 220px;
            justify-content: flex-start;
            flex-shrink: 0;
        }
        
        #file-input { display: none; }
        
        .soal-container {
            background-color: var(--card-background); border: 1px solid var(--border-color); border-radius: 8px;
            padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
            position: relative;
        }
        .soal-container.disabled {
            pointer-events: none !important;
        }
        .soal-container.is-editing {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.4), 0 4px 12px rgba(0,0,0,0.1);
        }
        .soal-container.invalid-soal {
            border-color: var(--danger-color);
            box-shadow: 0 0 8px rgba(220, 53, 69, 0.4);
        }
        .soal-validation-error {
            color: var(--danger-color);
            font-size: 0.85em;
            font-weight: 500;
            margin-top: 15px;
            padding: 8px;
            background-color: var(--error-bg-color);
            border-radius: 4px;
            display: none;
        }
        .soal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; gap: 10px; }
        .soal-nomor-container { display: flex; align-items: center; gap: 5px; }
        .soal-nomor-input { width: 60px; padding: 4px 8px; font-size: 1em; border: 1px solid var(--border-color); border-radius: 4px; }
        .drag-handle { display: grid; grid-template-columns: repeat(3, 6px); gap: 4px; padding: 10px; cursor: grab; border-radius: 5px; transition: background-color 0.2s; }
        .soal-actions { display: flex; gap: 8px; align-items: center; pointer-events: auto; }
        .edit-btn, .save-btn, .cancel-edit-btn { font-size: 0.85em; padding: 6px 12px; font-weight: 500; }
        .save-btn { background-color: var(--success-color); }
        .save-btn:hover:not(:disabled) { background-color: var(--success-hover); }
        .delete-btn { font-size: 0.85em; padding: 6px 12px; font-weight: 500; }

        [contenteditable="true"] { outline: none; background-color: #f8f9fa; padding: 2px 4px; border-radius: 3px; }
        body.dark-mode [contenteditable="true"] { background-color: #2c2c2c; }
        [contenteditable="true"]:focus { box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.25); }
        
        [contenteditable][data-placeholder]:empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
            pointer-events: none;
            display: block;
        }

        .soal-container ul { list-style-type: none; padding-left: 0; margin-top: 15px; margin-bottom: 0; }
        .soal-container li { padding: 8px 12px; margin-bottom: 5px; border-radius: 4px; display: flex; align-items: baseline; word-break: break-word; }
        .soal-container li b { margin-right: 12px; min-width: 20px; }
        .soal-container li div, .soal-container .soal-pertanyaan { width: 100%;}
        
        .soal-kunci-jawaban { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); display: flex; align-items: center; font-weight: 700; }
        .soal-kunci-jawaban span { margin-right: 10px; color: var(--success-color); }

        .soal-container.review-mode ul { margin-top: 10px; }
        .soal-container.review-mode li { padding: 2px 12px; margin-bottom: 0; }
        .soal-container.review-mode .soal-kunci-jawaban { margin-top: 10px; padding-top: 10px; }

        .img-inline { max-height: 2.5em; width: auto; vertical-align: middle; cursor: pointer; }
        .img-block { display: block; height: auto; margin: 0.8em 0; cursor: pointer; max-width: 100%; }
        .resizable-wrapper { position: relative; display: inline-block; outline: 2px dashed var(--primary-color); line-height: 0; user-select: none; -webkit-user-select: none; vertical-align: middle; }
        .resizable-wrapper img { display: block; cursor: default !important; width: 100%; height: 100%; max-height: none; }
        
        .resizer { 
            position: absolute; width: 6px; height: 6px;
            background-color: var(--primary-color); border: 1px solid var(--card-background);
            border-radius: 2px; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .resizer.top-left { top: -3px; left: -3px; cursor: nwse-resize; }
        .resizer.top-right { top: -3px; right: -3px; cursor: nesw-resize; }
        .resizer.bottom-left { bottom: -3px; left: -3px; cursor: nesw-resize; }
        .resizer.bottom-right { bottom: -3px; right: -3px; cursor: nwse-resize; }

        .sortable-ghost { opacity: 0.4; background-color: #c8ebfb; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s; }
        .modal-content { background-color: var(--card-background); padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: left; max-width: 450px; width: 90%; transform: scale(0.95); animation: zoomIn 0.3s forwards; }
        .modal-content h3 { margin-top: 0; text-align: center; }
        .modal-content p { margin-bottom: 25px; line-height: 1.6; }
        .modal-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-actions button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 0; }
        .btn-confirm { background-color: var(--danger-color); color: white; }
        .btn-cancel { background-color: var(--secondary-color); color: white; }
        .confirmation-input-container { margin: 20px 0; }
        #delete-modal .modal-content { text-align: center; }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast { background-color: #333; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(-100%); transition: opacity 0.3s, transform 0.3s; font-size: 0.9em; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }

        .settings-btn { background: none; border: none; cursor: pointer; padding: 5px; }
        .settings-btn svg { width: 24px; height: 24px; stroke: var(--label-color); }
        .theme-options { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .theme-options button { flex-grow: 1; }
        
        #processing-modal .spinner-container p { font-size: 1.2em; color: white; font-weight: 500; }
        #processing-modal .spinner { border-top-color: white; border-left-color: white; }
        
        .instructions-box {
            background-color: var(--info-bg-color); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 20px; margin-top: 30px; font-size: 0.95em;
        }
        .instructions-box h3 { margin-top: 0; color: var(--text-color); font-size: 1.1em; }
        .instructions-box ol { padding-left: 20px; margin-bottom: 0; }
        .instructions-box li { margin-bottom: 10px; }
        
        .editor-toolbar {
            position: absolute; background-color: #2D3748; color: white; border-radius: 8px;
            padding: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1001;
            display: none; align-items: center; gap: 4px; transition: opacity 0.1s;
        }
        .editor-toolbar button {
            background: transparent; border: none; color: white; padding: 7px;
            cursor: pointer; border-radius: 5px; display: flex; align-items: center; justify-content: center;
        }
        .editor-toolbar button:hover { background-color: #4A5568; }
        .editor-toolbar button svg { width: 20px; height: 20px; fill: currentColor; }
        .editor-toolbar .separator { width: 1px; height: 20px; background-color: #4A5568; margin: 0 4px; }

        @media (max-width: 768px) {
            .header-row { flex-direction: column; align-items: stretch; gap: 10px; }
            .identitas-item { text-align: center; }
            .header-btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

<div class="container">

    <div id="editor-toolbar" class="editor-toolbar">
        <button data-command="undo" title="Undo (Ctrl+Z)"><svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg></button>
        <button data-command="redo" title="Redo (Ctrl+Y)"><svg viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 9 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.72.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg></button>
        <div class="separator"></div>
        <button data-command="bold" title="Bold (Ctrl+B)"><svg viewBox="0 0 24 24"><path d="M15.6 10.79c.97-.67 1.65-1.77 1.65-2.79 0-2.26-1.75-4-4-4H7v14h7.04c2.09 0 3.71-1.7 3.71-3.79 0-1.52-.86-2.82-2.15-3.42zM10 6.5h3c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-3v-3zm3.5 9H10v-3h3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z"/></svg></button>
        <button data-command="italic" title="Italic (Ctrl+I)"><svg viewBox="0 0 24 24"><path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z"/></svg></button>
        <button data-command="underline" title="Underline (Ctrl+U)"><svg viewBox="0 0 24 24"><path d="M12 17c3.31 0 6-2.69 6-6V3h-2.5v8c0 1.93-1.57 3.5-3.5 3.5S8.5 12.93 8.5 11V3H6v8c0 3.31 2.69 6 6 6zm-7 2v2h14v-2H5z"/></svg></button>
        <div class="separator"></div>
        <button data-command="insertImage" title="Upload Gambar"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></button>
    </div>
    <input type="file" id="toolbar-image-input" accept="image/*" style="display: none;">

    <div id="loading-view" class="view active">
        <div class="card-wrapper">
            <div class="spinner-container">
                <div class="spinner"></div>
                <p id="loading-text">Mempersiapkan Aplikasi & Login...</p>
                <p id="loading-error" class="error-message"></p>
            </div>
        </div>
    </div>

    <div id="selection-view" class="view">
        <div class="card-wrapper">
            <div class="card">
                <div class="card-header">
                    <h2>IDENTITAS SOAL</h2>
                    <p>Lengkapi semua informasi di bawah</p>
                </div>
                <form id="selection-form">
                    <div class="form-group">
                        <label for="ujian-select">Ujian</label>
                        <select id="ujian-select" class="form-control" required>
                            <option value="" disabled selected>Pilih jenis asesmen...</option>
                            <option value="ASTS 1">ASTS 1 (Asesmen Sumatif Tengah Semester 1)</option>
                            <option value="ASAT 1">ASAT 1 (Asesmen Sumatif Akhir Semester 1)</option>
                            <option value="ASTS 2">ASTS 2 (Asesmen Sumatif Tengah Semester 2)</option>
                            <option value="ASAT 2">ASAT 2 (Asesmen Sumatif Akhir Tahun)</option>
                            <option value="Lainnya">Lainnya...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tahun-ajaran-select">Tahun Ajaran</label>
                        <select id="tahun-ajaran-select" class="form-control" required></select>
                    </div>
                    <div class="form-group">
                        <label for="kelas-select">Kelas</label>
                        <select id="kelas-select" class="form-control" required>
                             <option value="" disabled selected>Pilih kelas...</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mapel-select">Mata Pelajaran</label>
                        <select id="mapel-select" class="form-control" required>
                            <option value="" disabled selected>Pilih mata pelajaran...</option>
                            <option>Pendidikan Agama Islam</option>
                            <option>Pendidikan Pancasila</option>
                            <option>Matematika</option>
                            <option>Bahasa Indonesia</option>
                            <option>Bahasa Inggris</option>
                            <option>IPA</option>
                            <option>IPS</option>
                            <option>PJOK</option>
                            <option>Bahasa Jawa</option>
                            <option>Seni Budaya dan Prakarya</option>
                            <option>Informatika</option>
                            <option value="Lainnya">Lainnya...</option>
                        </select>
                    </div>
                    <button id="save-selection-btn" class="btn btn-full" disabled>Simpan & Lanjutkan</button>
                </form>
            </div>
        </div>
    </div>

    <div id="editor-view" class="view">
        <div class="title-container">
            <h1 class="main-title">EDITOR BANK SOAL</h1>
            <button class="settings-btn" id="settings-btn" title="Pengaturan Tampilan"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
        </div>
        
        <div class="editor-header">
            <div class="header-row">
                <div class="identitas-item">Ujian: <strong id="info-ujian"></strong></div>
                <button id="add-soal-btn" class="btn btn-success header-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg><span>Tambah Soal</span></button>
            </div>
            <div class="header-row">
                <div class="identitas-item">Tahun Ajaran: <strong id="info-ta"></strong></div>
                 <a href="https://drive.google.com/uc?export=download&id=1ASkItWXmUfAuJGKML-oX-4RT_2qusVD-" target="_blank" id="template-zip-btn" class="btn btn-purple header-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg><span>Template ZIP</span></a>
            </div>
            <div class="header-row">
                <div class="identitas-item">Kelas: <strong id="info-kelas"></strong></div>
                <button id="upload-btn" class="btn btn-primary header-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg><span>Unggah ZIP</span></button>
            </div>
            <div class="header-row">
                <div class="identitas-item">Mata Pelajaran: <strong id="info-mapel"></strong></div>
                <button id="clear-data-btn" class="btn btn-danger header-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg><span>Hapus Semua</span></button>
            </div>
        </div>
        
        <input id="file-input" type="file" accept=".zip" />
        <div id="soal-list-container"></div>
        <div class="instructions-box">
            <h3>Petunjuk</h3>
            <ol>
                <li><strong>Tambah Soal:</strong> Klik untuk membuat soal baru dari awal.</li>
                <li><strong>Template ZIP:</strong> Unduh berkas ZIP yang berisi file HTML sebagai template.</li>
                <li><strong>Unggah ZIP:</strong> Unggah file ZIP yang sudah Anda perbarui untuk diproses.</li>
            </ol>
        </div>
    </div>
</div>

<div id="ujian-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Manajemen Jenis Ujian Kustom</h3>
        <div class="form-group">
            <label for="custom-ujian-select">Pilih Ujian yang Sudah Ada</label>
            <select id="custom-ujian-select" class="form-control">
                <option value="">-- Pilih dari daftar --</option>
            </select>
        </div>
        <div class="modal-actions" style="justify-content: flex-start; margin-bottom: 20px;">
             <button id="select-custom-ujian-btn" class="btn btn-success">Gunakan Ujian Ini</button>
        </div>
        <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
        <div class="form-group">
            <label for="new-ujian-input">Atau, Buat Jenis Ujian Baru</label>
            <input type="text" id="new-ujian-input" class="form-control" placeholder="Contoh: Ujian Praktik">
        </div>
        <div class="modal-actions">
            <button id="modal-cancel-ujian" class="btn-cancel">Batal</button>
            <button id="save-new-ujian-btn" class="btn btn-primary">Simpan & Gunakan</button>
        </div>
    </div>
</div>

<div id="mapel-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Manajemen Mata Pelajaran Kustom</h3>
        <div class="form-group">
            <label for="custom-mapel-select">Pilih Mapel yang Sudah Ada</label>
            <select id="custom-mapel-select" class="form-control">
                <option value="">-- Pilih dari daftar --</option>
            </select>
        </div>
        <div class="modal-actions" style="justify-content: flex-start; margin-bottom: 20px;">
             <button id="select-custom-mapel-btn" class="btn btn-success">Gunakan Mapel Ini</button>
        </div>
        <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
        <div class="form-group">
            <label for="new-mapel-input">Atau, Buat Mapel Baru</label>
            <input type="text" id="new-mapel-input" class="form-control" placeholder="Contoh: Bahasa Mandarin">
        </div>
        <div class="modal-actions">
            <button id="modal-cancel-mapel" class="btn-cancel">Batal</button>
            <button id="save-new-mapel-btn" class="btn btn-primary">Simpan & Gunakan</button>
        </div>
    </div>
</div>

<div id="delete-modal" class="modal-overlay">
    <div class="modal-content">
        <p id="delete-modal-text"></p>
        <div class="confirmation-input-container" style="display: none;">
            <label for="confirmation-input">Ketik "<strong id="confirmation-word"></strong>" untuk konfirmasi:</label>
            <input type="text" id="confirmation-input" class="form-control">
        </div>
        <div class="modal-actions">
            <button id="modal-confirm-delete" class="btn-confirm">Ya, Hapus</button>
            <button id="modal-cancel-delete" class="btn-cancel">Batal</button>
        </div>
    </div>
</div>

<div id="info-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="info-modal-title"></h3>
        <p id="info-modal-text"></p>
        <div class="modal-actions">
            <button id="info-modal-close" class="btn">Saya Mengerti</button>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Pengaturan Tampilan</h3>
        <div class="theme-options">
            <button class="btn" id="light-theme-btn">Mode Terang</button>
            <button class="btn" id="dark-theme-btn">Mode Gelap</button>
        </div>
    </div>
</div>

<div id="processing-modal" class="modal-overlay">
    <div class="spinner-container">
        <div class="spinner"></div>
        <p id="processing-text">Sedang memproses...</p>
    </div>
</div>

<div id="toast-container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script type="module">
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
    
    const firebaseConfigs = {
        '7ABC': { apiKey: "AIzaSyBAKwT7JY_HGnvK6h3u30-dfgRPXfef8l8", authDomain: "abc-a13ea.firebaseapp.com", databaseURL: "https://abc-a13ea-default-rtdb.firebaseio.com", projectId: "abc-a13ea", storageBucket: "abc-a13ea.appspot.com", messagingSenderId: "1052966795599", appId: "1:1052966795599:web:d4d331199ca9081321ed3a" },
        '7DEF': { apiKey: "AIzaSyBkhBZw3oADXUAJ9FXY9-g7XBsSmQhzZVk", authDomain: "def-ab5ee.firebaseapp.com", databaseURL: "https://def-ab5ee-default-rtdb.firebaseio.com", projectId: "def-ab5ee", storageBucket: "def-ab5ee.appspot.com", messagingSenderId: "129712840107", appId: "1:129712840107:web:ab10576fed95f735dd46ee" },
        '8ABC': { apiKey: "AIzaSyAwilwwwEJ2MAdSf09BotxNH-z6RiXaHXY", authDomain: "abc-43e73.firebaseapp.com", databaseURL: "https://abc-43e73-default-rtdb.firebaseio.com", projectId: "abc-43e73", storageBucket: "abc-43e73.appspot.com", messagingSenderId: "1043754727577", appId: "1:1043754727577:web:56c3732bf2a6ac900c2008" },
        '8DEF': { apiKey: "AIzaSyBeCI57lmZ4-8DAKYJ7nvYjnXOfvy0vqrk", authDomain: "def-efcb2.firebaseapp.com", databaseURL: "https://def-efcb2-default-rtdb.firebaseio.com", projectId: "def-efcb2", storageBucket: "def-efcb2.appspot.com", messagingSenderId: "12569956361", appId: "1:12569956361:web:fea36c4e034e65f33ba8d8" },
        '9ABC': { apiKey: "AIzaSyBZ6JR3ggnUiZFQ-wdrewbfhzMUwFaGGzQ", authDomain: "abc-d272a.firebaseapp.com", databaseURL: "https://abc-d272a-default-rtdb.firebaseio.com", projectId: "abc-d272a", storageBucket: "abc-d272a.appspot.com", messagingSenderId: "1036605132828", appId: "1:1036605132828:web:2b59f91290d50afe304fd9" },
        '9DEF': { apiKey: "AIzaSyC2iwuDMWTaJIG8g464Wt0En3CXI2DZiz4", authDomain: "def-85f32.firebaseapp.com", databaseURL: "https://def-85f32-default-rtdb.firebaseio.com", projectId: "def-85f32", storageBucket: "def-85f32.appspot.com", messagingSenderId: "82670626048", appId: "1:82670626048:web:f5fdfda8fe078245b6bfe5" },
        'SETUP': { apiKey: "AIzaSyBbXJ4VuACXyHJhl2eVSB2vHiT6hrx-XnE", authDomain: "setup-73809.firebaseapp.com", databaseURL: "https://setup-73809-default-rtdb.firebaseio.com", projectId: "setup-73809", storageBucket: "setup-73809.appspot.com", messagingSenderId: "843995999446", appId: "1:843995999446:web:7fd92546f2d0bea73fed77" }
    };

    const firebaseApps = {};
    function initializeFirebaseApps() {
        for (const appName in firebaseConfigs) {
            if (!getApps().find(app => app.name === appName)) {
                firebaseApps[appName] = initializeApp(firebaseConfigs[appName], appName);
            } else {
                firebaseApps[appName] = getApp(appName);
            }
        }
    }

    const GITHUB_USERNAME = "speropa";
    const GITHUB_REPO = "gambarbanksoal";
    let githubToken = null;

    let soalToDelete = null;
    let activeResizer = null;
    let currentSoalData = {}; 
    let isEditing = false;
    let originalMapelValue = '';
    let originalUjianValue = '';

    const editorToolbar = document.getElementById('editor-toolbar');
    const toolbarImageInput = document.getElementById('toolbar-image-input');
    let lastFocusedEditable = null;
    let savedSelection = null;
    let imageTargetElement = null;

    const loadingView = document.getElementById('loading-view');
    const loadingText = document.getElementById('loading-text');
    const loadingError = document.getElementById('loading-error');
    const selectionView = document.getElementById('selection-view');
    const editorView = document.getElementById('editor-view');
    const selectionForm = document.getElementById('selection-form');
    const ujianSelect = document.getElementById('ujian-select');
    const tahunAjaranSelect = document.getElementById('tahun-ajaran-select');
    const kelasSelect = document.getElementById('kelas-select');
    const mapelSelect = document.getElementById('mapel-select');
    const saveSelectionBtn = document.getElementById('save-selection-btn');
    const addSoalBtn = document.getElementById('add-soal-btn');
    const templateZipBtn = document.getElementById('template-zip-btn');
    const uploadBtn = document.getElementById('upload-btn');
    const clearDataBtn = document.getElementById('clear-data-btn');
    const fileInput = document.getElementById('file-input');
    const outputEl = document.getElementById('soal-list-container');
    const instructionsBox = document.querySelector('.instructions-box');
    const deleteModal = document.getElementById('delete-modal');
    const confirmDeleteBtn = document.getElementById('modal-confirm-delete');
    const cancelDeleteBtn = document.getElementById('modal-cancel-delete');
    const modalText = document.getElementById('delete-modal-text');
    const confirmationInputContainer = document.querySelector('.confirmation-input-container');
    const confirmationInput = document.getElementById('confirmation-input');
    const confirmationWord = document.getElementById('confirmation-word');
    const toastContainer = document.getElementById('toast-container');
    const processingModal = document.getElementById('processing-modal');
    const processingText = document.getElementById('processing-text');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const lightThemeBtn = document.getElementById('light-theme-btn');
    const darkThemeBtn = document.getElementById('dark-theme-btn');
    const infoModal = document.getElementById('info-modal');
    const infoModalTitle = document.getElementById('info-modal-title');
    const infoModalText = document.getElementById('info-modal-text');
    const infoModalCloseBtn = document.getElementById('info-modal-close');
    
    const mapelModal = document.getElementById('mapel-modal');
    const customMapelSelect = document.getElementById('custom-mapel-select');
    const newMapelInput = document.getElementById('new-mapel-input');
    const selectCustomMapelBtn = document.getElementById('select-custom-mapel-btn');
    const saveNewMapelBtn = document.getElementById('save-new-mapel-btn');
    const cancelMapelBtn = document.getElementById('modal-cancel-mapel');

    const ujianModal = document.getElementById('ujian-modal');
    const customUjianSelect = document.getElementById('custom-ujian-select');
    const newUjianInput = document.getElementById('new-ujian-input');
    const selectCustomUjianBtn = document.getElementById('select-custom-ujian-btn');
    const saveNewUjianBtn = document.getElementById('save-new-ujian-btn');
    const cancelUjianBtn = document.getElementById('modal-cancel-ujian');

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }
    
    function showProcessing(message) {
        processingText.textContent = message;
        processingModal.style.display = 'flex';
    }

    function hideProcessing() {
        processingModal.style.display = 'none';
    }
    
    function setGlobalActionsState(disabled) {
        addSoalBtn.disabled = disabled;
        uploadBtn.disabled = disabled;
        clearDataBtn.disabled = disabled;
        templateZipBtn.classList.toggle('disabled', disabled);
    }

    function showInfoOverlay(title, message) {
        infoModalTitle.textContent = title;
        infoModalText.innerHTML = message;
        infoModal.style.display = 'flex';
    }

    function getDbPath(data) {
        const { tahunAjaran, kelas, mapel, ujian } = data;
        const safeTA = tahunAjaran.replace(/[\.\#\$\[\]\/]/g, '-');
        const safeUjian = ujian.replace(/\s+/g, '-');
        const safeMapel = mapel.replace(/\s+/g, '-');
        return `ujian/${safeTA}/${safeUjian}/${safeMapel}/Kelas-${kelas}`;
    }

    async function fetchGithubToken() {
        try {
            const setupDb = getDatabase(firebaseApps['SETUP']);
            const tokenRef = ref(setupDb, 'github/token');
            const snapshot = await get(tokenRef);
            if (snapshot.exists()) {
                githubToken = snapshot.val();
                console.log("GitHub token successfully fetched.");
                return true;
            } else {
                throw new Error("Token GitHub tidak ditemukan di database 'SETUP'.");
            }
        } catch (error) {
            console.error("Gagal mengambil token GitHub:", error);
            loadingError.textContent = `Gagal mengambil token GitHub: ${error.message}`;
            loadingError.style.display = 'block';
            return false;
        }
    }

    async function performAutoLogin() {
        const email = "speropa@gmail.com";
        const password = "Pajangan201184*";
        loadingError.style.display = 'none';

        try {
            loadingText.textContent = 'Login ke semua layanan...';
            const loginPromises = Object.keys(firebaseApps).map(appName => {
                const appAuth = getAuth(firebaseApps[appName]);
                return signInWithEmailAndPassword(appAuth, email, password);
            });
            
            await Promise.all(loginPromises);
            console.log("Successfully logged in to all 7 projects.");

            loadingText.textContent = 'Mengambil konfigurasi keamanan...';
            const tokenFetched = await fetchGithubToken();
            if (tokenFetched) {
                loadingText.textContent = 'Memuat daftar kustom...';
                await Promise.all([
                    populateCustomMapelsInMainSelect(),
                    populateCustomUjiansInMainSelect()
                ]);
                showView('selection-view');
            }

        } catch (error) {
            loadingError.textContent = `Login Otomatis Gagal: ${error.message}`;
            loadingError.style.display = 'block';
            console.error("Auto-login failed:", error);
        }
    }

    function populateTahunAjaranDropdown() {
        const selectElement = document.getElementById('tahun-ajaran-select');
        const date = new Date();
        const currentYear = date.getFullYear();
        const currentMonth = date.getMonth();

        let latestAcademicYearStart = currentYear;
        if (currentMonth < 6) { 
            latestAcademicYearStart = currentYear - 1;
        }
        
        const firstYear = 2025;
        
        selectElement.innerHTML = '<option value="" disabled>Pilih tahun ajaran...</option>';

        for (let year = latestAcademicYearStart; year >= firstYear; year--) {
            const academicYearString = `${year}/${year + 1}`;
            const option = document.createElement('option');
            option.value = academicYearString;
            option.textContent = academicYearString;
            selectElement.appendChild(option);
        }

        const latestOptionValue = `${latestAcademicYearStart}/${latestAcademicYearStart + 1}`;
        selectElement.value = latestOptionValue;
    }

    function validateSelectionForm() {
        saveSelectionBtn.disabled = !selectionForm.checkValidity();
    }

    selectionForm.addEventListener('input', validateSelectionForm);

    ujianSelect.addEventListener('change', async () => {
        if (ujianSelect.value === 'Lainnya') {
            await showUjianModal();
        } else {
            originalUjianValue = ujianSelect.value;
            validateSelectionForm();
        }
    });

    mapelSelect.addEventListener('change', async () => {
        if (mapelSelect.value === 'Lainnya') {
            await showMapelModal();
        } else {
            originalMapelValue = mapelSelect.value;
            validateSelectionForm();
        }
    });

    saveSelectionBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        validateSelectionForm();
        if (saveSelectionBtn.disabled) {
            showToast('Harap lengkapi semua isian identitas soal.', 'error');
            return;
        }

        const ujian = ujianSelect.value;
        const tahunAjaran = tahunAjaranSelect.value;
        const kelas = kelasSelect.value;
        const mapel = mapelSelect.value;
        
        currentSoalData = { ujian, tahunAjaran, kelas, mapel };
        
        document.getElementById('info-ujian').textContent = ujian;
        document.getElementById('info-ta').textContent = tahunAjaran;
        document.getElementById('info-kelas').textContent = kelas;
        document.getElementById('info-mapel').textContent = mapel;
        
        showView('loading-view');
        loadingText.textContent = 'Mencari data soal yang sudah ada...';
        
        await fetchAndRenderSoal();

        showView('editor-view');
    });

    // --- MANAJEMEN UJIAN KUSTOM ---
    
    async function fetchCustomUjians() {
        try {
            const setupDb = getDatabase(firebaseApps['SETUP']);
            const ujiansRef = ref(setupDb, 'customUjians');
            const snapshot = await get(ujiansRef);
            return snapshot.exists() ? snapshot.val() : [];
        } catch (error) {
            console.error("Gagal mengambil daftar ujian kustom:", error);
            showToast("Gagal memuat daftar ujian kustom.", "error");
            return [];
        }
    }

    async function populateCustomUjiansInMainSelect() {
        const customUjians = await fetchCustomUjians();
        const lainnyaOption = ujianSelect.querySelector('option[value="Lainnya"]');
        ujianSelect.querySelectorAll('.custom-ujian-option').forEach(opt => opt.remove());
        customUjians.sort().forEach(ujianName => {
            const option = document.createElement('option');
            option.value = ujianName;
            option.textContent = ujianName;
            option.className = 'custom-ujian-option';
            ujianSelect.insertBefore(option, lainnyaOption);
        });
    }

    async function showUjianModal() {
        originalUjianValue = ujianSelect.value;
        ujianSelect.value = '';
        customUjianSelect.innerHTML = '<option value="">-- Pilih dari daftar --</option>';
        newUjianInput.value = '';
        const customUjians = await fetchCustomUjians();
        if (customUjians.length > 0) {
            customUjians.sort().forEach(ujianName => {
                const option = document.createElement('option');
                option.value = ujianName;
                option.textContent = ujianName;
                customUjianSelect.appendChild(option);
            });
        }
        ujianModal.style.display = 'flex';
    }

    function addAndSelectCustomUjian(ujianName) {
        let existingOption = ujianSelect.querySelector(`option[value="${ujianName}"]`);
        if (!existingOption) {
            const lainnyaOption = ujianSelect.querySelector('option[value="Lainnya"]');
            const newOption = document.createElement('option');
            newOption.value = ujianName;
            newOption.textContent = ujianName;
            newOption.className = 'custom-ujian-option';
            ujianSelect.insertBefore(newOption, lainnyaOption);
        }
        ujianSelect.value = ujianName;
        originalUjianValue = ujianName;
        ujianModal.style.display = 'none';
        validateSelectionForm();
    }

    selectCustomUjianBtn.addEventListener('click', () => {
        const selectedUjian = customUjianSelect.value;
        if (selectedUjian) {
            addAndSelectCustomUjian(selectedUjian);
        } else {
            showToast("Pilih salah satu jenis ujian dari daftar.", "error");
        }
    });

    saveNewUjianBtn.addEventListener('click', async () => {
        const newUjianName = newUjianInput.value.trim();
        if (!newUjianName) {
            showToast("Nama ujian baru tidak boleh kosong.", "error");
            return;
        }
        showProcessing("Menyimpan ujian baru...");
        const customUjians = await fetchCustomUjians();
        if (customUjians.some(u => u.toLowerCase() === newUjianName.toLowerCase())) {
            hideProcessing();
            showToast("Jenis ujian ini sudah ada.", "error");
            return;
        }
        customUjians.push(newUjianName);
        try {
            const setupDb = getDatabase(firebaseApps['SETUP']);
            await set(ref(setupDb, 'customUjians'), customUjians);
            addAndSelectCustomUjian(newUjianName);
            showToast("Ujian baru berhasil disimpan!", "success");
        } catch (error) {
            showToast("Gagal menyimpan ujian baru.", "error");
        } finally {
            hideProcessing();
        }
    });

    cancelUjianBtn.addEventListener('click', () => {
        ujianSelect.value = originalUjianValue || '';
        ujianModal.style.display = 'none';
        validateSelectionForm();
    });

    // --- MANAJEMEN MAPEL KUSTOM ---
    
    async function fetchCustomMapels() {
        try {
            const setupDb = getDatabase(firebaseApps['SETUP']);
            const mapelsRef = ref(setupDb, 'customMapels');
            const snapshot = await get(mapelsRef);
            return snapshot.exists() ? snapshot.val() : [];
        } catch (error) {
            console.error("Gagal mengambil daftar mapel kustom:", error);
            showToast("Gagal memuat daftar mapel kustom.", "error");
            return [];
        }
    }
    
    async function populateCustomMapelsInMainSelect() {
        const customMapels = await fetchCustomMapels();
        const lainnyaOption = mapelSelect.querySelector('option[value="Lainnya"]');
        mapelSelect.querySelectorAll('.custom-mapel-option').forEach(opt => opt.remove());
        customMapels.sort().forEach(mapelName => {
            const option = document.createElement('option');
            option.value = mapelName;
            option.textContent = mapelName;
            option.className = 'custom-mapel-option';
            mapelSelect.insertBefore(option, lainnyaOption);
        });
    }

    async function showMapelModal() {
        originalMapelValue = mapelSelect.value;
        mapelSelect.value = '';
        customMapelSelect.innerHTML = '<option value="">-- Pilih dari daftar --</option>';
        newMapelInput.value = '';
        const customMapels = await fetchCustomMapels();
        if (customMapels.length > 0) {
            customMapels.sort().forEach(mapelName => {
                const option = document.createElement('option');
                option.value = mapelName;
                option.textContent = mapelName;
                customMapelSelect.appendChild(option);
            });
        }
        mapelModal.style.display = 'flex';
    }
    
    function addAndSelectCustomMapel(mapelName) {
        let existingOption = mapelSelect.querySelector(`option[value="${mapelName}"]`);
        if (!existingOption) {
            const lainnyaOption = mapelSelect.querySelector('option[value="Lainnya"]');
            const newOption = document.createElement('option');
            newOption.value = mapelName;
            newOption.textContent = mapelName;
            newOption.className = 'custom-mapel-option';
            mapelSelect.insertBefore(newOption, lainnyaOption);
        }
        mapelSelect.value = mapelName;
        originalMapelValue = mapelName;
        mapelModal.style.display = 'none';
        validateSelectionForm();
    }

    selectCustomMapelBtn.addEventListener('click', () => {
        const selectedMapel = customMapelSelect.value;
        if (selectedMapel) {
            addAndSelectCustomMapel(selectedMapel);
        } else {
            showToast("Pilih salah satu mapel dari daftar.", "error");
        }
    });

    saveNewMapelBtn.addEventListener('click', async () => {
        const newMapelName = newMapelInput.value.trim();
        if (!newMapelName) {
            showToast("Nama mapel baru tidak boleh kosong.", "error");
            return;
        }
        showProcessing("Menyimpan mapel baru...");
        const customMapels = await fetchCustomMapels();
        if (customMapels.some(m => m.toLowerCase() === newMapelName.toLowerCase())) {
            hideProcessing();
            showToast("Mata pelajaran ini sudah ada.", "error");
            return;
        }
        customMapels.push(newMapelName);
        try {
            const setupDb = getDatabase(firebaseApps['SETUP']);
            await set(ref(setupDb, 'customMapels'), customMapels);
            addAndSelectCustomMapel(newMapelName);
            showToast("Mapel baru berhasil disimpan!", "success");
        } catch (error) {
            showToast("Gagal menyimpan mapel baru.", "error");
        } finally {
            hideProcessing();
        }
    });

    cancelMapelBtn.addEventListener('click', () => {
        mapelSelect.value = originalMapelValue || '';
        mapelModal.style.display = 'none';
        validateSelectionForm();
    });
    
    async function fetchAndRenderSoal() {
        const dbPath = getDbPath(currentSoalData);
        let primaryDbName;
        if (currentSoalData.kelas == '7') primaryDbName = '7ABC';
        else if (currentSoalData.kelas == '8') primaryDbName = '8ABC';
        else if (currentSoalData.kelas == '9') primaryDbName = '9ABC';
        
        if (!primaryDbName) {
            showToast('Kelas tidak valid.', 'error');
            return;
        }
        
        const db = getDatabase(firebaseApps[primaryDbName]);
        const snapshot = await get(ref(db, dbPath));

        outputEl.innerHTML = ''; 

        if (snapshot.exists()) {
            const data = snapshot.val();
            renderSoalFromData(data);
            showToast(`Data berhasil dimuat. ${data.soal ? Object.keys(data.soal).length : 0} soal ditemukan.`, 'success');
        } else {
            showToast('Tidak ada data ditemukan. Silakan unggah file ZIP untuk memulai.', 'info');
        }
        updateUIForSoalPresence();
    }
    
    function renderSoalFromData(data) {
        if (!data.soal) return;
        
        const isOldStructure = data.kunciJawaban && typeof data.kunciJawaban === 'string';
        const kunciArray = isOldStructure ? data.kunciJawaban.split(',') : [];
        if (isOldStructure) {
            showToast("Struktur data lama terdeteksi. Disarankan untuk menyimpan ulang.", "info");
        }

        Object.keys(data.soal).sort((a, b) => parseInt(a) - parseInt(b)).forEach(nomor => {
            const soalDetail = data.soal[nomor];
            let kunci;
            if (isOldStructure) {
                kunci = kunciArray[parseInt(nomor) - 1] || '';
            } else {
                kunci = soalDetail.kunciJawaban || '';
            }
            const soalDiv = createSoalElement(soalDetail, kunci, nomor);
            outputEl.appendChild(soalDiv);
        });
        initializeSortable();
    }

    async function uploadImageToGithub(file, base64Content) {
        if (!githubToken) {
            showToast('Token keamanan tidak valid. Operasi dibatalkan.', 'error');
            throw new Error('GitHub token is not available.');
        }
        const fileName = `${Date.now()}-${file.name}`;
        const { tahunAjaran, kelas, mapel, ujian } = currentSoalData;
        const safePath = `${tahunAjaran.replace('/', '-')}/${kelas}/${mapel.replace(/\s+/g, '-')}/${ujian.replace(/\s+/g, '-')}`;
        const path = `${safePath}/${fileName}`;

        const data = {
            message: `Upload gambar soal: ${fileName}`,
            content: base64Content,
        };
        const response = await fetch(
            `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${path}`,
            {
                method: 'PUT',
                headers: { 'Authorization': `token ${githubToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            }
        );
        const result = await response.json();
        if (!response.ok) throw new Error(`Gagal mengunggah ke GitHub: ${result.message}`);
        return result.content.download_url;
    }

    async function deleteImageFromGithub(imageUrl) {
        if (!githubToken) {
            showToast('Token keamanan tidak valid. Operasi dibatalkan.', 'error');
            throw new Error('GitHub token is not available.');
        }
        if (!imageUrl || !imageUrl.includes('raw.githubusercontent.com')) return;
        
        const path = imageUrl.split(`${GITHUB_USERNAME}/${GITHUB_REPO}/main/`)[1];
        if (!path) return;

        try {
            const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${path}`, {
                headers: { 'Authorization': `token ${githubToken}` }
            });
            const fileData = await res.json();
            if (!res.ok) {
                if (res.status === 404) {
                     console.log(`Gambar sudah tidak ada di GitHub: ${imageUrl}`);
                     return;
                }
                throw new Error(`Gagal mendapatkan SHA file: ${fileData.message}`);
            }

            const deleteRes = await fetch(fileData.url, {
                method: 'DELETE',
                headers: { 'Authorization': `token ${githubToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Hapus gambar: ${fileData.name}`, sha: fileData.sha })
            });
            if (!deleteRes.ok) throw new Error(`Gagal menghapus file dari GitHub.`);
            console.log(`Gambar ${fileData.name} berhasil dihapus.`);

        } catch (error) {
            console.error(`Gagal menghapus gambar dari GitHub: ${imageUrl}`, error);
        }
    }

    async function deleteGithubDirectory(path) {
        if (!githubToken) {
            showToast('Token keamanan tidak valid. Operasi dibatalkan.', 'error');
            throw new Error('GitHub token is not available.');
        }
        try {
            const response = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${path}`, {
                headers: { 'Authorization': `token ${githubToken}` }
            });

            if (!response.ok) {
                if (response.status === 404) {
                    console.log(`Folder ${path} tidak ditemukan, tidak perlu dihapus.`);
                    return;
                }
                throw new Error(`Gagal mendapatkan konten folder: ${response.statusText}`);
            }

            const contents = await response.json();
            if (!Array.isArray(contents)) return;

            for (const item of contents) {
                if (item.type === 'dir') {
                    await deleteGithubDirectory(item.path);
                } else if (item.type === 'file') {
                    await deleteImageFromGithub(item.download_url);
                }
            }
        } catch (error) {
            console.error(`Gagal memproses penghapusan folder ${path}:`, error);
        }
    }

    function validateAllSoal() {
        let isAllValid = true;
        
        function isContentEmpty(element) {
            const hasText = element.textContent.trim() !== '';
            const hasImage = element.querySelector('img') !== null;
            return !hasText && !hasImage;
        }

        document.querySelectorAll('.soal-container').forEach(soalDiv => {
            const errorMessages = [];
            const pertanyaanEl = soalDiv.querySelector('.soal-pertanyaan');
            const pilihanAEl = soalDiv.querySelector('li:nth-child(1) div');
            const pilihanBEl = soalDiv.querySelector('li:nth-child(2) div');
            const pilihanCEl = soalDiv.querySelector('li:nth-child(3) div');
            const pilihanDEl = soalDiv.querySelector('li:nth-child(4) div');
            const kunciEl = soalDiv.querySelector('.soal-kunci-jawaban div');

            if (isContentEmpty(pertanyaanEl)) errorMessages.push('Pertanyaan tidak boleh kosong.');
            if (isContentEmpty(pilihanAEl)) errorMessages.push('Pilihan A tidak boleh kosong.');
            if (isContentEmpty(pilihanBEl)) errorMessages.push('Pilihan B tidak boleh kosong.');
            if (isContentEmpty(pilihanCEl)) errorMessages.push('Pilihan C tidak boleh kosong.');
            if (isContentEmpty(pilihanDEl)) errorMessages.push('Pilihan D tidak boleh kosong.');
            if (!kunciEl.textContent.trim()) errorMessages.push('Kunci Jawaban tidak boleh kosong.');

            const errorEl = soalDiv.querySelector('.soal-validation-error');
            if (errorMessages.length > 0) {
                isAllValid = false;
                soalDiv.classList.add('invalid-soal');
                errorEl.innerHTML = errorMessages.join('<br>');
                errorEl.style.display = 'block';
            } else {
                soalDiv.classList.remove('invalid-soal');
                errorEl.style.display = 'none';
            }
        });
        return isAllValid;
    }

    async function saveAllSoalToDatabase(manageSpinner = true) {
        if (!validateAllSoal()) {
            showToast('Terdapat soal yang tidak valid. Perubahan tidak disimpan.', 'error');
            const firstInvalid = document.querySelector('.invalid-soal');
            if (firstInvalid) {
                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            throw new Error("Validasi soal gagal.");
        }
        
        if (manageSpinner) showProcessing('Menyimpan semua perubahan...');

        try {
            const soalElements = document.querySelectorAll('.soal-container');
            
            if (soalElements.length === 0) {
                 await clearAllDataFromDB();
                 if (manageSpinner) showToast('Semua soal telah dihapus dan data dikosongkan.', 'success');
                 return;
            }

            const soalObject = {};
            soalElements.forEach((soalDiv, index) => {
                const nomorSoal = index + 1;
                soalObject[nomorSoal] = {
                    pertanyaan: soalDiv.querySelector('.soal-pertanyaan').innerHTML,
                    pilihanA: soalDiv.querySelector('li:nth-child(1) div').innerHTML,
                    pilihanB: soalDiv.querySelector('li:nth-child(2) div').innerHTML,
                    pilihanC: soalDiv.querySelector('li:nth-child(3) div').innerHTML,
                    pilihanD: soalDiv.querySelector('li:nth-child(4) div').innerHTML,
                    kunciJawaban: soalDiv.querySelector('.soal-kunci-jawaban div').textContent.trim().toUpperCase()
                };
            });

            const finalData = { ...currentSoalData, terakhirUpdate: new Date().toISOString(), soal: soalObject };
            delete finalData.kunciJawaban;

            const dbPath = getDbPath(finalData);
            
            const targetDbNames = [];
            if (finalData.kelas == '7') targetDbNames.push('7ABC', '7DEF');
            else if (finalData.kelas == '8') targetDbNames.push('8ABC', '8DEF');
            else if (finalData.kelas == '9') targetDbNames.push('9ABC', '9DEF');

            if (targetDbNames.length === 0) throw new Error("Kelas tidak valid.");

            const writePromises = targetDbNames.map(appName => {
                const targetDb = getDatabase(firebaseApps[appName]);
                return set(ref(targetDb, dbPath), finalData);
            });

            await Promise.all(writePromises);
            
            if (manageSpinner) showToast('Perubahan berhasil disimpan!', 'success');
            
        } catch (error) {
            if (error.message !== "Validasi soal gagal.") {
                showToast(`Penyimpanan Gagal: ${error.message}`, 'error');
            }
            console.error("Save all error:", error);
            throw error;
        } finally {
            if (manageSpinner) hideProcessing();
        }
    }

    async function clearAllDataFromDB() {
        const dbPath = getDbPath(currentSoalData);
        const targetDbNames = [];
        if (currentSoalData.kelas == '7') targetDbNames.push('7ABC', '7DEF');
        else if (currentSoalData.kelas == '8') targetDbNames.push('8ABC', '8DEF');
        else if (currentSoalData.kelas == '9') targetDbNames.push('9ABC', '9DEF');
        
        if (targetDbNames.length === 0) return;

        const deletePromises = targetDbNames.map(appName => {
            const targetDb = getDatabase(firebaseApps[appName]);
            return remove(ref(targetDb, dbPath));
        });
        await Promise.all(deletePromises);
    }

    addSoalBtn.addEventListener('click', () => {
        if (isEditing) {
            showToast('Harap simpan atau batalkan perubahan pada soal yang sedang diedit.', 'error');
            return;
        }

        const nomorSoalBaru = document.querySelectorAll('.soal-container').length + 1;
        const soalDetailKosong = { pertanyaan: '', pilihanA: '', pilihanB: '', pilihanC: '', pilihanD: '' };
        const kunciKosong = '';

        const soalDivBaru = createSoalElement(soalDetailKosong, kunciKosong, nomorSoalBaru);
        soalDivBaru.dataset.isNew = 'true';
        outputEl.appendChild(soalDivBaru);

        enterEditMode(soalDivBaru);
        soalDivBaru.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });

    clearDataBtn.addEventListener('click', () => {
        if (isEditing) {
            showToast('Harap simpan perubahan pada soal yang sedang diedit terlebih dahulu.', 'error');
            return;
        }
        modalText.textContent = "Apakah Anda YAKIN ingin menghapus SEMUA data dan gambar untuk ujian ini? Tindakan ini tidak bisa dibatalkan.";
        confirmationInputContainer.style.display = 'block';
        confirmationWord.textContent = "HAPUS";
        confirmationInput.value = '';
        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.onclick = executeClearData;
        deleteModal.style.display = 'flex';
    });
    
    confirmationInput.addEventListener('input', () => {
        confirmDeleteBtn.disabled = confirmationInput.value !== "HAPUS";
    });

    async function executeClearData() {
        deleteModal.style.display = 'none';
        showProcessing('Memulai proses penghapusan...');

        const { tahunAjaran, kelas, mapel, ujian } = currentSoalData;
        const githubFolderPath = `${tahunAjaran.replace('/', '-')}/${kelas}/${mapel.replace(/\s+/g, '-')}/${ujian.replace(/\s+/g, '-')}`;
        let dotInterval;

        try {
            await new Promise(resolve => setTimeout(resolve, 500)); 
            
            processingText.textContent = 'Menghapus data soal dari server...';
            await clearAllDataFromDB();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            processingText.textContent = 'Menghapus file gambar... Proses ini mungkin memakan waktu lama.';
            
            const baseText = 'Menghapus file gambar... Proses ini mungkin memakan waktu lama';
            dotInterval = setInterval(() => {
                if (processingModal.style.display === 'none') {
                    clearInterval(dotInterval);
                    return;
                }
                const currentText = processingText.textContent;
                if (currentText.endsWith('...')) {
                    processingText.textContent = baseText;
                } else {
                    processingText.textContent += '.';
                }
            }, 600);

            await deleteGithubDirectory(githubFolderPath);
            clearInterval(dotInterval);

            showToast('Semua data dan gambar berhasil dihapus!', 'success');
            outputEl.innerHTML = ''; 
            updateUIForSoalPresence();

        } catch(error) {
            if(dotInterval) clearInterval(dotInterval);
            showToast(`Gagal menghapus data: ${error.message}`, 'error');
            console.error("Clear data error:", error);
        } finally {
            hideProcessing();
        }
    }

    uploadBtn.addEventListener('click', () => {
        if (isEditing) {
            showToast('Harap simpan perubahan pada soal yang sedang diedit terlebih dahulu.', 'error');
            return;
        }
        fileInput.click();
    });
    
    fileInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        showProcessing(`Memproses file: ${file.name}...`);
        try {
            await processZipFile(file);
            updateUIForSoalPresence();

            if (outputEl.children.length > 0) {
                await processAndSaveUploadedSoal();
                hideProcessing();
                showInfoOverlay("Proses Selesai!", "Semua soal dan gambar telah berhasil diunggah dan disimpan. Silahkan review dan edit setiap soal apabila belum sesuai.");
            } else {
                hideProcessing();
            }
        } catch (error) {
            console.error("Gagal memproses file ZIP:", error);
            hideProcessing();
        } finally {
            fileInput.value = '';
        }
    });

    async function processAndSaveUploadedSoal() {
        const soalElements = document.querySelectorAll('.soal-container');
        const imagesToUpload = [];
        soalElements.forEach(soalDiv => {
            soalDiv.querySelectorAll('img').forEach(img => {
                if (img.src.startsWith('data:image')) {
                    imagesToUpload.push(img);
                }
            });
        });

        const totalImages = imagesToUpload.length;
        if (totalImages > 0) {
            let uploadedCount = 0;
            for (const img of imagesToUpload) {
                uploadedCount++;
                processingText.textContent = `Mengunggah gambar ${uploadedCount} dari ${totalImages}...`;
                try {
                    const base64String = img.src.split(',')[1];
                    const fileName = img.dataset.fileName || 'pasted-image.png';
                    const githubUrl = await uploadImageToGithub({ name: fileName }, base64String);
                    img.src = githubUrl;
                } catch (error) {
                    showToast(`Gagal mengunggah gambar: ${error.message}`, 'error');
                    console.error("Image upload failed:", error);
                    throw error;
                }
            }
        }
        
        processingText.textContent = 'Menyimpan data ke server...';
        await saveAllSoalToDatabase(false);
    }

    async function processZipFile(file) {
        outputEl.innerHTML = '';
        if (activeResizer) removeResizer();

        try {
            const zip = await JSZip.loadAsync(file);
            const htmlFile = zip.file(/.+\.html?$/i)[0];
            if (!htmlFile) throw new Error("File .html tidak ditemukan di dalam ZIP.");
            
            const fileContentAsArray = await htmlFile.async('uint8array');
            const decoder = new TextDecoder('windows-1252');
            let htmlContent = decoder.decode(fileContentAsArray);
            const tempDoc = new DOMParser().parseFromString(htmlContent, 'text/html');
            
            const imagesInDoc = Array.from(tempDoc.getElementsByTagName('img'));
            
            for (const img of imagesInDoc) {
                const src = img.getAttribute('src');
                if (src && !src.startsWith('data:') && !src.startsWith('http')) {
                    try {
                        const decodedSrc = decodeURIComponent(src);
                        const imageFile = zip.file(decodedSrc);
                        if (imageFile) {
                            const base64Content = await imageFile.async('base64');
                            const extension = imageFile.name.split('.').pop().toLowerCase();
                            img.src = `data:image/${extension};base64,${base64Content}`;
                            img.dataset.fileName = imageFile.name;
                        }
                    } catch (e) { console.warn(`Gagal memuat gambar: ${src}`, e); }
                }
            }
            
            parseHtmlAndDisplay(tempDoc.body);
        } catch (err) {
            showToast("Gagal fatal saat memproses file ZIP.", 'error');
            console.error(err);
        }
    }
    
    function createSoalElement(soalDetail, kunci, nomor) {
        const soalDiv = document.createElement('div');
        soalDiv.className = 'soal-container disabled review-mode';
        
        soalDiv.innerHTML = `
            <div class="soal-header">
                <div class="soal-nomor-container">
                    <h3 class="soal-nomor" style="display: flex; align-items: center; gap: 5px;">Soal <span>${nomor}</span></h3>
                    <input type="number" class="soal-nomor-input" value="${nomor}" style="display: none;" min="1">
                </div>
                <div class="drag-handle" title="Seret untuk mengubah urutan"><span></span><span></span><span></span><span></span><span></span><span></span></div>
                <div class="soal-actions">
                    <button class="btn edit-btn">Edit Soal</button>
                    <button class="btn delete-btn btn-danger">Hapus</button>
                    <button class="btn save-btn btn-success" style="display: none;">Simpan</button>
                    <button class="btn cancel-edit-btn btn-secondary" style="display: none;">Batal</button>
                </div>
            </div>
            <div class="soal-pertanyaan" contenteditable="false" data-placeholder="Ketik pertanyaan di sini...">${soalDetail.pertanyaan}</div>
            <ul>
                <li><b>A.</b> <div contenteditable="false" dir="auto">${soalDetail.pilihanA}</div></li>
                <li><b>B.</b> <div contenteditable="false" dir="auto">${soalDetail.pilihanB}</div></li>
                <li><b>C.</b> <div contenteditable="false" dir="auto">${soalDetail.pilihanC}</div></li>
                <li><b>D.</b> <div contenteditable="false" dir="auto">${soalDetail.pilihanD}</div></li>
            </ul>
            <div class="soal-kunci-jawaban">
                <span>Kunci Jawaban:</span>
                <div contenteditable="false" dir="auto">${kunci}</div>
            </div>
            <div class="soal-validation-error"></div>
        `;
        
        classifyImages(soalDiv);
        return soalDiv;
    }

    function parseHtmlAndDisplay(bodyElement) {
        const tables = bodyElement.getElementsByTagName('table');
        if (tables.length === 0) {
            showToast("Error: Tidak ada tabel format soal ditemukan di dalam file.", 'error');
            return;
        }
        let soalDitemukan = 0;
        
        function cleanHtmlString(html) {
            if (!html) return '';
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            return cleanHtml(tempDiv, false); 
        }

        for (const table of tables) {
            const rows = table.rows;
            for (let i = 0; i < rows.length; i += 2) {
                const firstCell = rows[i]?.cells[0];
                if (!firstCell || isNaN(parseInt(firstCell.textContent.trim(), 10))) continue;

                if (i + 1 >= rows.length) continue;

                const mainContentCell = rows[i]?.cells[1];
                const keyCell = rows[i + 1]?.cells[1];

                if (!mainContentCell || !keyCell) {
                    console.warn(`Skipping incomplete question block at row index ${i}`);
                    continue;
                }
                
                if (!mainContentCell.textContent.trim() && !mainContentCell.querySelector('img')) {
                    continue;
                }

                try {
                    soalDitemukan++;
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = mainContentCell.innerHTML;

                    const questionParts = [];
                    const optionParts = new Map([['A', []], ['B', []], ['C', []], ['D', []]]);
                    let currentOptionKey = null;
                    let foundOptions = false;

                    for (const node of Array.from(tempDiv.childNodes)) {
                        const nodeText = node.textContent.trim();
                        const match = nodeText.match(/^([A-D])\.\s*/);

                        if (match) {
                            foundOptions = true;
                            currentOptionKey = match[1];
                            
                            const tempNode = node.cloneNode(true);
                            const markerRegex = new RegExp(`^\\s*${currentOptionKey}\\.\\s*`);
                            
                            const walker = document.createTreeWalker(tempNode, NodeFilter.SHOW_TEXT, null, false);
                            let textNodeToModify = walker.nextNode();
                            while(textNodeToModify && textNodeToModify.nodeValue.trim() === '') {
                                textNodeToModify = walker.nextNode();
                            }
                            
                            if (textNodeToModify) {
                                textNodeToModify.nodeValue = textNodeToModify.nodeValue.replace(markerRegex, '').trim();
                            }

                            const contentToAdd = tempNode.innerHTML.trim();
                            if (contentToAdd) {
                                optionParts.get(currentOptionKey).push(contentToAdd);
                            }
                        } else if (foundOptions && currentOptionKey) {
                            optionParts.get(currentOptionKey).push(node.outerHTML || node.textContent);
                        } else {
                            questionParts.push(node.cloneNode(true));
                        }
                    }

                    const questionContainer = document.createElement('div');
                    questionParts.forEach(part => questionContainer.appendChild(part));

                    const soalDetail = {
                        pertanyaan: cleanHtml(questionContainer, true),
                        pilihanA: cleanHtmlString(optionParts.get('A')?.join(' ') || ''),
                        pilihanB: cleanHtmlString(optionParts.get('B')?.join(' ') || ''),
                        pilihanC: cleanHtmlString(optionParts.get('C')?.join(' ') || ''),
                        pilihanD: cleanHtmlString(optionParts.get('D')?.join(' ') || '')
                    };
                    
                    const kunci = cleanHtml(keyCell, false).trim().toUpperCase();
                    
                    const soalDiv = createSoalElement(soalDetail, kunci, soalDitemukan);
                    outputEl.appendChild(soalDiv);
                } catch (e) {
                    console.error(`Gagal memproses blok soal pada baris ${i}.`, e);
                }
            }
        }
        if (soalDitemukan > 0) {
            showToast(`Selesai! ${soalDitemukan} soal berhasil dibaca.`, 'success');
            initializeSortable();
        } else {
            showToast(`Selesai, namun tidak ada soal yang cocok formatnya atau semua soal kosong.`, 'error');
        }
    }

    function cleanHtml(element, allowParagraphs) {
        if (!element) return '';
        const clone = element.cloneNode(true);

        clone.querySelectorAll('style, script').forEach(el => el.remove());
        clone.querySelectorAll('*').forEach(child => {
            child.removeAttribute('class');
            child.removeAttribute('lang');
            if (child.tagName === 'IMG' && child.hasAttribute('style')) {
                const width = child.style.width;
                const height = child.style.height;
                child.removeAttribute('style');
                if (width) child.style.width = width;
                if (height) child.style.height = height;
            } else if (child.tagName !== 'IMG') {
                 child.removeAttribute('style');
            }
        });
        
        if (!allowParagraphs) {
            clone.querySelectorAll('p').forEach(p => {
                if (p.innerHTML.trim() === '' || p.innerHTML.trim() === '&nbsp;') {
                    p.remove();
                } else {
                    p.replaceWith(...p.childNodes, document.createElement('br'));
                }
            });
        }
        
        let html = clone.innerHTML;
        html = html.replace(/&nbsp;/g, ' ');
        html = html.replace(/(<br\s*\/?>\s*){2,}/gi, '<br>'); 
        html = html.trim().replace(/^<br\s*\/?>|<br\s*\/?>$/gi, '').trim();

        return html;
    }

    function classifyImages(containerElement) {
        containerElement.querySelectorAll('img').forEach(img => {
            if (img.style.width) {
                if (!img.style.height) {
                    img.style.height = 'auto';
                }
                return;
            }

            const wrapper = img.closest('.resizable-wrapper');
            const elementToCheck = wrapper || img;
            const p = elementToCheck.closest('p, div');

            if (!p) {
                img.classList.add('img-inline');
                img.classList.remove('img-block');
                return;
            }
            
            const hasMeaningfulSiblings = Array.from(p.childNodes).some(sibling => {
                if (sibling === elementToCheck) return false;
                if (sibling.nodeType === 3 && sibling.textContent.trim().length > 0) return true; // Text node
                if (sibling.nodeType === 1 && sibling.tagName !== 'BR' && !sibling.contains(elementToCheck)) return true; // Element node
                return false;
            });


            if (hasMeaningfulSiblings) {
                img.classList.add('img-inline');
                img.classList.remove('img-block');
                img.style.maxWidth = '';
            } else {
                img.classList.add('img-block');
                img.classList.remove('img-inline');
                img.style.maxWidth = '100%';
            }
        });
    }
    
    function resetSoalContainerUI(soalContainer) {
        soalContainer.classList.add('review-mode');
        soalContainer.classList.remove('is-editing');
        soalContainer.querySelectorAll('[contenteditable]').forEach(el => el.setAttribute('contenteditable', 'false'));

        soalContainer.querySelector('.soal-nomor').style.display = 'flex';
        soalContainer.querySelector('.soal-nomor-input').style.display = 'none';

        soalContainer.querySelector('.edit-btn').style.display = 'inline-flex';
        soalContainer.querySelector('.delete-btn').style.display = 'inline-flex';
        soalContainer.querySelector('.save-btn').style.display = 'none';
        soalContainer.querySelector('.cancel-edit-btn').style.display = 'none';

        document.querySelectorAll('.soal-container').forEach(container => {
            container.classList.add('disabled');
        });
    }

    function enterEditMode(soalContainer) {
        isEditing = true;
        setGlobalActionsState(true);
        soalContainer.classList.remove('review-mode');

        const nomorDisplay = soalContainer.querySelector('.soal-nomor');
        const nomorInput = soalContainer.querySelector('.soal-nomor-input');
        const totalSoal = document.querySelectorAll('.soal-container').length;

        soalContainer.dataset.originalNumber = nomorDisplay.querySelector('span').textContent;
        nomorInput.value = soalContainer.dataset.originalNumber;
        nomorInput.max = soalContainer.dataset.isNew === 'true' ? totalSoal : totalSoal;

        nomorDisplay.style.display = 'none';
        nomorInput.style.display = 'block';

        if (soalContainer.dataset.isNew !== 'true') {
            const originalContent = {
                pertanyaan: soalContainer.querySelector('.soal-pertanyaan').innerHTML,
                pilihanA: soalContainer.querySelector('li:nth-child(1) div').innerHTML,
                pilihanB: soalContainer.querySelector('li:nth-child(2) div').innerHTML,
                pilihanC: soalContainer.querySelector('li:nth-child(3) div').innerHTML,
                pilihanD: soalContainer.querySelector('li:nth-child(4) div').innerHTML,
                kunci: soalContainer.querySelector('.soal-kunci-jawaban div').innerHTML,
            };
            soalContainer.dataset.originalContent = JSON.stringify(originalContent);
        }
        
        const initialImages = Array.from(soalContainer.querySelectorAll('img')).map(img => img.src);
        soalContainer.dataset.initialImages = JSON.stringify(initialImages);

        document.querySelectorAll('.soal-container').forEach(container => {
            if (container !== soalContainer) {
                container.classList.add('disabled');
            } else {
                container.classList.remove('disabled');
                container.classList.add('is-editing');
            }
        });

        soalContainer.querySelectorAll('[contenteditable]').forEach(el => el.setAttribute('contenteditable', 'true'));
        
        soalContainer.querySelector('.edit-btn').style.display = 'none';
        soalContainer.querySelector('.delete-btn').style.display = 'none';
        soalContainer.querySelector('.save-btn').style.display = 'inline-flex';
        soalContainer.querySelector('.cancel-edit-btn').style.display = 'inline-flex';
        
        const firstEditable = soalContainer.querySelector('.soal-pertanyaan');
        if (firstEditable) {
            firstEditable.focus();
            showToolbar(firstEditable);
        }
    }

    async function exitEditMode(soalContainer) {
        if (activeResizer) removeResizer();
        
        const nomorInput = soalContainer.querySelector('.soal-nomor-input');
        const newPosition = parseInt(nomorInput.value, 10);
        const totalSoal = document.querySelectorAll('.soal-container').length;

        if (isNaN(newPosition) || newPosition < 1 || newPosition > totalSoal) {
            showToast(`Nomor soal tidak valid. Harus antara 1 dan ${totalSoal}.`, 'error');
            nomorInput.value = soalContainer.dataset.originalNumber;
            return;
        }

        const kunciJawabanEl = soalContainer.querySelector('.soal-kunci-jawaban div');
        const kunciJawaban = kunciJawabanEl.textContent.trim().toUpperCase();
        if (!['A', 'B', 'C', 'D'].includes(kunciJawaban)) {
            showToast('Kunci Jawaban tidak valid. Harap isi dengan A, B, C, atau D.', 'error');
            return;
        }
        
        hideToolbar();
        showProcessing('Memvalidasi perubahan...');

        try {
            kunciJawabanEl.textContent = kunciJawaban;

            const allSoal = Array.from(outputEl.querySelectorAll('.soal-container'));
            const originalIndex = allSoal.indexOf(soalContainer);
            if ((newPosition - 1) !== originalIndex) {
                const [movedItem] = allSoal.splice(originalIndex, 1);
                allSoal.splice(newPosition - 1, 0, movedItem);
                outputEl.innerHTML = '';
                allSoal.forEach(el => outputEl.appendChild(el));
            }

            const imagesToUpload = Array.from(soalContainer.querySelectorAll('img')).filter(img => img.src.startsWith('data:image'));
            const initialImages = JSON.parse(soalContainer.dataset.initialImages || '[]');
            const finalImageSrcs = [];

            if (imagesToUpload.length > 0) {
                let uploadedCount = 0;
                for (const img of imagesToUpload) {
                    uploadedCount++;
                    processingText.textContent = `Mengunggah gambar baru ${uploadedCount} dari ${imagesToUpload.length}...`;
                    const base64String = img.src.split(',')[1];
                    const fileName = img.dataset.fileName || 'pasted-image.png';
                    const githubUrl = await uploadImageToGithub({ name: fileName }, base64String);
                    img.src = githubUrl;
                }
            }
            
            soalContainer.querySelectorAll('img').forEach(img => finalImageSrcs.push(img.src));

            const imagesToDelete = initialImages.filter(src => src.includes('github') && !finalImageSrcs.includes(src));
            if (imagesToDelete.length > 0) {
                processingText.textContent = `Menghapus ${imagesToDelete.length} gambar lama...`;
                for (const imageUrl of imagesToDelete) {
                    await deleteImageFromGithub(imageUrl);
                }
            }
            
            processingText.textContent = 'Menyimpan data soal...';
            renumberSoal();
            await saveAllSoalToDatabase(false);
            
            isEditing = false;
            delete soalContainer.dataset.isNew;
            resetSoalContainerUI(soalContainer);
            setGlobalActionsState(false);
            showToast("Perubahan berhasil disimpan.", "success");

        } catch (error) {
            showToast(`Gagal menyimpan: ${error.message}`, 'error');
            console.error("Error on saving from edit mode:", error);
        } finally {
            hideProcessing();
        }
    }

    function cancelEditMode(soalContainer) {
        if (activeResizer) removeResizer();

        if (soalContainer.dataset.isNew === 'true') {
            soalContainer.remove();
            renumberSoal();
        } else {
            const originalContent = JSON.parse(soalContainer.dataset.originalContent);
            soalContainer.querySelector('.soal-pertanyaan').innerHTML = originalContent.pertanyaan;
            soalContainer.querySelector('li:nth-child(1) div').innerHTML = originalContent.pilihanA;
            soalContainer.querySelector('li:nth-child(2) div').innerHTML = originalContent.pilihanB;
            soalContainer.querySelector('li:nth-child(3) div').innerHTML = originalContent.pilihanC;
            soalContainer.querySelector('li:nth-child(4) div').innerHTML = originalContent.pilihanD;
            soalContainer.querySelector('.soal-kunci-jawaban div').innerHTML = originalContent.kunci;
            resetSoalContainerUI(soalContainer);
        }
        
        isEditing = false;
        hideToolbar();
        setGlobalActionsState(false);
        updateUIForSoalPresence();
    }

    outputEl.addEventListener('click', function(e) {
        const soalContainer = e.target.closest('.soal-container');
        if (!soalContainer) return;

        const editBtn = e.target.closest('.edit-btn');
        const saveBtn = e.target.closest('.save-btn');
        const deleteBtn = e.target.closest('.delete-btn');
        const cancelBtn = e.target.closest('.cancel-edit-btn');

        if (editBtn) {
            if (isEditing) {
                showToast('Harap simpan perubahan pada soal lain terlebih dahulu.', 'error');
                return;
            }
            enterEditMode(soalContainer);
            return;
        }

        if (saveBtn) {
            exitEditMode(soalContainer);
            return;
        }
        
        if (cancelBtn) {
            cancelEditMode(soalContainer);
            return;
        }

        if (deleteBtn) {
             if (isEditing) {
                return;
             }
             soalToDelete = soalContainer;
             modalText.textContent = "Apakah Anda yakin ingin menghapus soal ini? Perubahan akan langsung disimpan.";
             confirmationInputContainer.style.display = 'none';
             confirmDeleteBtn.disabled = false;
             confirmDeleteBtn.onclick = executeDeleteSoal;
             deleteModal.style.display = 'flex';
             return;
        }

        if (soalContainer.classList.contains('disabled')) {
            return;
        }
        
        const isImage = e.target.tagName === 'IMG' && !e.target.closest('.resizable-wrapper');
        if (isImage) {
            makeImageResizable(e.target);
            e.stopPropagation();
        }
    });

    document.addEventListener('click', function(e) { if (activeResizer && !activeResizer.wrapper.contains(e.target)) removeResizer(); });
    cancelDeleteBtn.addEventListener('click', () => { deleteModal.style.display = 'none'; });
    infoModalCloseBtn.addEventListener('click', () => { infoModal.style.display = 'none'; });

    async function executeDeleteSoal() {
        if (!soalToDelete) return;
        deleteModal.style.display = 'none';
        showProcessing('Menghapus soal...');

        const imagesToDelete = Array.from(soalToDelete.querySelectorAll('img')).map(img => img.src);
        for (const imageUrl of imagesToDelete) {
            await deleteImageFromGithub(imageUrl);
        }

        soalToDelete.remove();
        renumberSoal();
        await saveAllSoalToDatabase();
        soalToDelete = null;
        updateUIForSoalPresence();
    }
    
    function makeImageResizable(img) { 
        if (activeResizer) removeResizer();
        const wrapper = document.createElement('div'); 
        wrapper.className = 'resizable-wrapper'; 
        
        wrapper.style.width = img.style.width || `${img.offsetWidth}px`;
        wrapper.style.height = img.style.height || `${img.offsetHeight}px`;

        img.parentNode.insertBefore(wrapper, img); 
        wrapper.appendChild(img); 
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.maxHeight = 'none'; 
        ['top-left', 'top-right', 'bottom-left', 'bottom-right'].forEach(c => { 
            const h = document.createElement('div'); 
            h.className = 'resizer ' + c; 
            wrapper.appendChild(h); 
            h.addEventListener('mousedown', startResize, { passive: false }); 
            h.addEventListener('touchstart', startResize, { passive: false }); 
        }); 
        activeResizer = { wrapper, img }; 
    }
    
    function removeResizer() { 
        if (activeResizer) { 
            const { wrapper, img } = activeResizer; 
            img.style.width = wrapper.style.width;
            img.style.height = wrapper.style.height; 
            img.classList.remove('img-inline', 'img-block');
            img.style.verticalAlign = 'middle';
            img.style.maxHeight = '';
            if (wrapper.parentNode) {
                wrapper.parentNode.insertBefore(img, wrapper); 
                wrapper.remove(); 
            }
            activeResizer = null; 
        } 
    }

    function startResize(e) { 
        e.preventDefault(); 
        e.stopPropagation(); 
        const { wrapper, img } = activeResizer; 
        const aspectRatio = img.naturalWidth / img.naturalHeight;
        const handle = e.target; 
        const startX = e.clientX || e.touches[0].clientX; 
        const startWidth = wrapper.offsetWidth; 
        function doResize(e) { 
            const currentX = e.clientX || e.touches[0].clientX; 
            let newWidth = handle.classList.contains('bottom-right') || handle.classList.contains('top-right') ? startWidth + (currentX - startX) : startWidth - (currentX - startX); 
            if (newWidth > 20) {
                wrapper.style.width = newWidth + 'px';
                wrapper.style.height = `${newWidth / aspectRatio}px`;
            }
        } 
        function stopResize() { 
            document.removeEventListener('mousemove', doResize); 
            document.removeEventListener('mouseup', stopResize); 
            document.removeEventListener('touchmove', doResize); 
            document.removeEventListener('touchend', stopResize); 
        } 
        document.addEventListener('mousemove', doResize); 
        document.addEventListener('mouseup', stopResize); 
        document.addEventListener('touchmove', doResize); 
        document.addEventListener('touchend', stopResize); 
    }
    function renumberSoal() {
        document.querySelectorAll('.soal-container').forEach((soal, index) => {
            const newNumber = index + 1;
            soal.querySelector('.soal-nomor span').textContent = newNumber;
            const input = soal.querySelector('.soal-nomor-input');
            if (input) {
                input.value = newNumber;
                input.max = document.querySelectorAll('.soal-container').length;
            }
            soal.dataset.originalNumber = newNumber;
        });
    }
    function initializeSortable() { 
        new Sortable(outputEl, { 
            animation: 150, 
            ghostClass: 'sortable-ghost', 
            handle: '.drag-handle', 
            onEnd: async function() {
                renumberSoal();
                await saveAllSoalToDatabase();
            } 
        }); 
    }

    function saveSelection() {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            savedSelection = selection.getRangeAt(0);
        }
    }

    function restoreSelection() {
        if (savedSelection) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(savedSelection);
        }
    }

    function showToolbar(element) {
        if (activeResizer) removeResizer();
        const rect = element.getBoundingClientRect();
        editorToolbar.style.display = 'flex';
        
        let top = window.scrollY + rect.top - editorToolbar.offsetHeight - 8;
        if (top < window.scrollY) {
            top = window.scrollY + rect.bottom + 8;
        }

        let left = window.scrollX + rect.left + (rect.width / 2) - (editorToolbar.offsetWidth / 2);
        if (left < 0) left = 5;
        if (left + editorToolbar.offsetWidth > window.innerWidth) {
            left = window.innerWidth - editorToolbar.offsetWidth - 5;
        }

        editorToolbar.style.top = `${top}px`;
        editorToolbar.style.left = `${left}px`;
    }

    function hideToolbar() {
        editorToolbar.style.display = 'none';
        lastFocusedEditable = null;
        savedSelection = null;
    }

    function initializeToolbar() {
        outputEl.addEventListener('focusin', (e) => {
            if (e.target.getAttribute('contenteditable') === 'true') {
                lastFocusedEditable = e.target;
                showToolbar(e.target);
            }
        });

        outputEl.addEventListener('focusout', (e) => {
            if (e.target.getAttribute('contenteditable') === 'true') {
                saveSelection();
            }
        });

        editorToolbar.addEventListener('mousedown', (e) => {
            e.preventDefault();
            const button = e.target.closest('button');
            if (!button) return;

            const command = button.dataset.command;
            const targetElement = lastFocusedEditable;
            
            if (!targetElement) {
                showToast('Silakan klik di dalam area teks terlebih dahulu.', 'error');
                return;
            }

            if (command === 'insertImage') {
                imageTargetElement = targetElement;
                toolbarImageInput.click();
            } else {
                targetElement.focus();
                restoreSelection();
                document.execCommand(command, false, null);
            }
        });

        toolbarImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file || !imageTargetElement) {
                imageTargetElement = null;
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                const imgHTML = `<img src="${event.target.result}" data-file-name="${file.name}">`;
                
                imageTargetElement.focus();
                restoreSelection();
                document.execCommand('insertHTML', false, imgHTML);
                
                const container = imageTargetElement.closest('.soal-container');
                if (container) {
                    classifyImages(container);
                }

                setTimeout(() => {
                    imageTargetElement.focus();
                    showToolbar(imageTargetElement);
                    imageTargetElement = null;
                }, 100);
            };
            reader.readAsDataURL(file);
            toolbarImageInput.value = '';
        });
    }

    function updateUIForSoalPresence() {
        const hasSoal = outputEl.children.length > 0;
        instructionsBox.style.display = hasSoal ? 'none' : 'block';
        clearDataBtn.disabled = !hasSoal;
        uploadBtn.disabled = hasSoal;
    }

    settingsBtn.addEventListener('click', () => settingsModal.style.display = 'flex');
    settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) settingsModal.style.display = 'none'; });
    lightThemeBtn.addEventListener('click', () => { document.body.classList.remove('dark-mode'); localStorage.setItem('theme', 'light'); settingsModal.style.display = 'none'; });
    darkThemeBtn.addEventListener('click', () => { document.body.classList.add('dark-mode'); localStorage.setItem('theme', 'dark'); settingsModal.style.display = 'none'; });

    function loadTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') document.body.classList.add('dark-mode');
        else document.body.classList.remove('dark-mode');
    }
    
    function initialize() {
        populateTahunAjaranDropdown();
        initializeFirebaseApps();
        performAutoLogin();
        initializeToolbar();
    }
    
    loadTheme();
    initialize();
</script>
</body>
</html>
