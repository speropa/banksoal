<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Editor Bank Soal (Perbaikan Final)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4A90E2;
            --primary-hover: #357ABD;
            --secondary-color: #6c757d;
            --secondary-hover: #5a6268;
            --success-color: #28a745;
            --success-hover: #218838;
            --purple-color: #8e44ad;
            --purple-hover: #732d91;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --background-color: #F7F9FC;
            --card-background: #FFFFFF;
            --text-color: #333;
            --label-color: #555;
            --border-color: #DDE2E8;
            --error-bg-color: #F8D7DA;
            --error-text-color: #721C24;
            --error-border-color: #f5c6cb;
            --info-bg-color: #e2f0ff;
        }

        body.dark-mode {
            --background-color: #121212;
            --card-background: #1E1E1E;
            --text-color: #E0E0E0;
            --label-color: #B0B0B0;
            --border-color: #333333;
            --error-bg-color: #4d2b30;
            --error-text-color: #f4a9b0;
            --error-border-color: #6e3a41;
            --info-bg-color: #1c2a38;
        }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            line-height: 1.6; 
            margin: 0;
            padding: 15px; 
            background-color: var(--background-color); 
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }
        
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease-in-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 30px);
        }
        .card {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.07);
            width: 100%;
            max-width: 450px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .card-header { text-align: center; margin-bottom: 30px; }
        .card-header h2 { margin: 0 0 10px 0; font-size: 1.6em; font-weight: 700; color: var(--text-color); }
        .card-header p { margin: 0; color: var(--label-color); }

        .spinner-container { text-align: center; }
        .spinner {
            width: 50px;
            height: 50px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner-container p { font-size: 1.1em; color: var(--label-color); }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--label-color); font-size: 0.9em; }
        .form-control {
            width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px;
            font-size: 1em; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s, color 0.3s;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .form-control:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); outline: none; }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border: none; border-radius: 8px;
            background-color: var(--primary-color); color: white; font-size: 0.9em; font-weight: 700;
            cursor: pointer; text-align: center; transition: background-color 0.3s, transform 0.2s, opacity 0.3s; text-decoration: none;
        }
        .btn:hover:not([disabled]) { background-color: var(--primary-hover); transform: translateY(-2px); }
        .btn:active:not([disabled]) { transform: translateY(0); }
        .btn-full { width: 100%; }
        
        .btn:disabled, .btn.disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
            pointer-events: none;
        }
        body.dark-mode .btn:disabled, body.dark-mode .btn.disabled {
            background-color: #444;
            color: #888;
        }

        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--secondary-hover); }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover:not(:disabled) { background-color: var(--success-hover); }
        .btn-purple { background-color: var(--purple-color); }
        .btn-purple:hover:not(:disabled) { background-color: var(--purple-hover); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-hover); }


        .error-message { color: var(--danger-color); text-align: center; margin-top: 15px; font-size: 0.9em; display: none; }

        .title-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #editor-view .main-title {
            text-align: center;
            font-weight: 700;
            font-size: 1.8em;
            margin: 0;
            flex-grow: 1;
        }
        
        .editor-header {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: start;
            background-color: var(--card-background);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .identitas-container {
            display: grid;
            grid-template-columns: max-content 1fr;
            gap: 8px 12px;
            align-items: center;
            font-size: 0.95em;
        }

        .identitas-label {
            font-weight: 500;
            color: var(--label-color);
        }

        .identitas-value {
            font-weight: 700;
            color: var(--text-color);
        }

        .actions-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: stretch;
        }
        
        .actions-container .btn {
            justify-content: flex-start;
        }
        
        #file-input { display: none; }
        
        .soal-container {
            background-color: var(--card-background); border: 1px solid var(--border-color); border-radius: 8px;
            padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
            position: relative;
        }
        .soal-container.disabled {
            pointer-events: none !important; /* The ultimate lock */
        }
        .soal-container.is-editing {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.4), 0 4px 12px rgba(0,0,0,0.1);
        }
        .soal-container.invalid-soal {
            border-color: var(--danger-color);
            box-shadow: 0 0 8px rgba(220, 53, 69, 0.4);
        }
        .soal-validation-error {
            color: var(--danger-color);
            font-size: 0.85em;
            font-weight: 500;
            margin-top: 15px;
            padding: 8px;
            background-color: var(--error-bg-color);
            border-radius: 4px;
            display: none;
        }
        .soal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; gap: 10px; }
        .soal-nomor-container { display: flex; align-items: center; gap: 5px; }
        .soal-nomor-input { width: 60px; padding: 4px 8px; font-size: 1em; border: 1px solid var(--border-color); border-radius: 4px; }
        .drag-handle { display: grid; grid-template-columns: repeat(3, 6px); gap: 4px; padding: 10px; cursor: grab; border-radius: 5px; transition: background-color 0.2s; }
        .soal-actions { display: flex; gap: 8px; align-items: center; pointer-events: auto; /* Allow buttons to be clicked even if container is disabled */ }
        .edit-btn, .save-btn, .cancel-edit-btn { font-size: 0.85em; padding: 6px 12px; font-weight: 500; }
        .save-btn { background-color: var(--success-color); }
        .save-btn:hover:not(:disabled) { background-color: var(--success-hover); }
        .delete-btn { font-size: 0.85em; padding: 6px 12px; font-weight: 500; }

        [contenteditable="true"] { outline: none; background-color: #f8f9fa; padding: 2px 4px; border-radius: 3px; }
        body.dark-mode [contenteditable="true"] { background-color: #2c2c2c; }
        [contenteditable="true"]:focus { box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.25); }
        
        [contenteditable][data-placeholder]:empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
            pointer-events: none;
            display: block;
        }

        .soal-container ul { list-style-type: none; padding-left: 0; margin-top: 15px; margin-bottom: 0; }
        .soal-container li { padding: 8px 12px; margin-bottom: 5px; border-radius: 4px; display: flex; align-items: baseline; word-break: break-word; }
        .soal-container li b { margin-right: 12px; min-width: 20px; }
        .soal-container li div, .soal-container .soal-pertanyaan { width: 100%;}
        
        .soal-kunci-jawaban { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); display: flex; align-items: center; font-weight: 700; }
        .soal-kunci-jawaban span { margin-right: 10px; color: var(--success-color); }

        .soal-container.review-mode ul {
            margin-top: 10px;
        }
        .soal-container.review-mode li {
            padding: 2px 12px;
            margin-bottom: 0;
        }
        .soal-container.review-mode .soal-kunci-jawaban {
            margin-top: 10px;
            padding-top: 10px;
        }

        .img-inline { max-height: 2.5em; width: auto; vertical-align: middle; cursor: pointer; }
        .img-block { display: block; max-width: 100%; height: auto; margin: 0.8em 0; cursor: pointer; }
        .resizable-wrapper { position: relative; display: inline-block; outline: 2px dashed var(--primary-color); line-height: 0; user-select: none; -webkit-user-select: none; vertical-align: middle; }
        .resizable-wrapper img { display: block; cursor: default !important; width: 100%; height: 100%; max-height: none; }
        
        .resizer { 
            position: absolute; 
            width: 6px;
            height: 6px;
            background-color: var(--primary-color); 
            border: 1px solid var(--card-background);
            border-radius: 2px;
            z-index: 10; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .resizer.top-left { top: -3px; left: -3px; cursor: nwse-resize; }
        .resizer.top-right { top: -3px; right: -3px; cursor: nesw-resize; }
        .resizer.bottom-left { bottom: -3px; left: -3px; cursor: nesw-resize; }
        .resizer.bottom-right { bottom: -3px; right: -3px; cursor: nwse-resize; }

        .sortable-ghost { opacity: 0.4; background-color: #c8ebfb; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s; }
        .modal-content { background-color: var(--card-background); padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; max-width: 450px; width: 90%; transform: scale(0.95); animation: zoomIn 0.3s forwards; }
        .modal-content h3 { margin-top: 0; }
        .modal-content p { margin-bottom: 25px; line-height: 1.6; }
        .modal-actions { margin-top: 20px; }
        .modal-actions button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 0 10px; }
        .btn-confirm { background-color: var(--danger-color); color: white; }
        .btn-cancel { background-color: var(--secondary-color); color: white; }
        .confirmation-input-container { margin: 20px 0; }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast { background-color: #333; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(-100%); transition: opacity 0.3s, transform 0.3s; font-size: 0.9em; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }

        .settings-btn { background: none; border: none; cursor: pointer; padding: 5px; }
        .settings-btn svg { width: 24px; height: 24px; stroke: var(--label-color); }
        .theme-options { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .theme-options button { flex-grow: 1; }
        
        #processing-modal .spinner-container p { font-size: 1.2em; color: white; font-weight: 500; }
        #processing-modal .spinner { border-top-color: white; border-left-color: white; }
        
        .instructions-box {
            background-color: var(--info-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            font-size: 0.95em;
        }
        .instructions-box h3 {
            margin-top: 0;
            color: var(--text-color);
            font-size: 1.1em;
        }
        .instructions-box ol {
            padding-left: 20px;
            margin-bottom: 0;
        }
        .instructions-box li {
            margin-bottom: 10px;
        }
        
        .editor-toolbar {
            position: absolute;
            background-color: #2D3748;
            color: white;
            border-radius: 8px;
            padding: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none; /* Initially hidden */
            align-items: center;
            gap: 4px;
            transition: opacity 0.1s;
        }
        .editor-toolbar button {
            background: transparent;
            border: none;
            color: white;
            padding: 7px;
            cursor: pointer;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .editor-toolbar button:hover {
            background-color: #4A5568;
        }
        .editor-toolbar button svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }
        .editor-toolbar .separator {
            width: 1px;
            height: 20px;
            background-color: #4A5568;
            margin: 0 4px;
        }

        @media (max-width: 768px) {
            .editor-header {
                grid-template-columns: 1fr; /* Stack columns on smaller screens */
            }
            .actions-container {
                flex-direction: row; /* Make buttons side-by-side on smaller screens */
                flex-wrap: wrap;
            }
            .actions-container .btn {
                flex-grow: 1; /* Allow buttons to grow and fill space */
            }
        }
    </style>
</head>
<body>

<div class="container">

    <div id="editor-toolbar" class="editor-toolbar">
        <button data-command="undo" title="Undo (Ctrl+Z)">
            <svg viewBox="0 0 24 24"><path d="M12.5,8C9.85,8,7.45,9,5.6,10.6L2,7V16H11L7.38,12.38C8.77,11.22,10.54,10.5,12.5,10.5C16.04,10.5,19.05,12.81,20.1,16L22.47,15.22C21.08,11.03,17.15,8,12.5,8Z" /></svg>
        </button>
        <button data-command="redo" title="Redo (Ctrl+Y)">
            <svg viewBox="0 0 24 24"><path d="M18.4,10.6C16.55,9,14.15,8,11.5,8C6.85,8,2.92,11.03,1.53,15.22L3.9,16C4.95,12.81,7.96,10.5,11.5,10.5C13.46,10.5,15.23,11.22,16.62,12.38L13,16H22V7L18.4,10.6Z" /></svg>
        </button>
        <div class="separator"></div>
        <button data-command="bold" title="Bold (Ctrl+B)">
            <svg viewBox="0 0 24 24"><path d="M15.6,10.79C16.57,10.11 17.25,9 17.25,7.75C17.25,5.72 15.73,4.25 13.75,4.25H7V19.75H14.5C16.5,19.75 18,18.25 18,16.25C18,14.75 17.1,13.5 15.6,12.82V12.79C16.58,12.09 17.25,11.04 17.25,9.75C17.25,8.55 16.55,7.5 15.6,6.89V6.86C16.23,6.5 16.75,5.86 16.75,5C16.75,3.81 15.76,2.75 14.5,2.75H7C5.9,2.75 5,3.65 5,4.75V19.75C5,20.85 5.9,21.75 7,21.75H14.5C17.28,21.75 19.5,19.53 19.5,16.75C19.5,14.56 18.2,12.73 16.24,12.06L15.6,10.79M10,6.75H13C13.83,6.75 14.5,7.42 14.5,8.25C14.5,9.08 13.83,9.75 13,9.75H10V6.75M10,12.25H13.75C14.58,12.25 15.25,12.92 15.25,13.75C15.25,14.58 14.58,15.25 13.75,15.25H10V12.25Z" /></svg>
        </button>
        <button data-command="italic" title="Italic (Ctrl+I)">
            <svg viewBox="0 0 24 24"><path d="M10,4V7H12.21L8.79,15H6V18H14V15H11.79L15.21,7H18V4H10Z" /></svg>
        </button>
        <button data-command="underline" title="Underline (Ctrl+U)">
            <svg viewBox="0 0 24 24"><path d="M12,17C15.31,17 18,14.31 18,11V3H15.5V11C15.5,12.93 13.93,14.5 12,14.5C10.07,14.5 8.5,12.93 8.5,11V3H6V11C6,14.31 8.69,17 12,17M5,19V21H19V19H5Z" /></svg>
        </button>
        <div class="separator"></div>
        <button data-command="insertImage" title="Upload Gambar">
            <svg viewBox="0 0 24 24"><path d="M21,19V5C21,3.89 20.1,3 19,3H5C3.89,3 3,3.89 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19M8.5,13.5L11,16.5L14.5,12L19,18H5L8.5,13.5Z" /></svg>
        </button>
    </div>
    <input type="file" id="toolbar-image-input" accept="image/*" style="display: none;">

    <div id="loading-view" class="view active">
        <div class="card-wrapper">
            <div class="spinner-container">
                <div class="spinner"></div>
                <p id="loading-text">Mempersiapkan Aplikasi & Login...</p>
                <p id="loading-error" class="error-message"></p>
            </div>
        </div>
    </div>

    <div id="selection-view" class="view">
        <div class="card-wrapper">
            <div class="card">
                <div class="card-header">
                    <h2>Identitas Soal</h2>
                    <p>Lengkapi semua informasi di bawah</p>
                </div>
                <form id="selection-form">
                    <div class="form-group">
                        <label for="ujian-select">Ujian</label>
                        <select id="ujian-select" class="form-control" required>
                            <option value="" disabled selected>Pilih jenis asesmen...</option>
                            <option value="ASTS 1">ASTS 1 (Asesmen Sumatif Tengah Semester 1)</option>
                            <option value="ASAT 1">ASAT 1 (Asesmen Sumatif Akhir Semester 1)</option>
                            <option value="ASTS 2">ASTS 2 (Asesmen Sumatif Tengah Semester 2)</option>
                            <option value="ASAT 2">ASAT 2 (Asesmen Sumatif Akhir Tahun)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tahun-ajaran-select">Tahun Ajaran</label>
                        <select id="tahun-ajaran-select" class="form-control" required></select>
                    </div>
                    <div class="form-group">
                        <label for="kelas-select">Kelas</label>
                        <select id="kelas-select" class="form-control" required>
                             <option value="" disabled selected>Pilih kelas...</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mapel-select">Mata Pelajaran</label>
                        <select id="mapel-select" class="form-control" required>
                            <option value="" disabled selected>Pilih mata pelajaran...</option>
                            <option>Pendidikan Agama Islam</option>
                            <option>Pendidikan Pancasila</option>
                            <option>Matematika</option>
                            <option>Bahasa Indonesia</option>
                            <option>Bahasa Inggris</option>
                            <option>IPA</option>
                            <option>IPS</option>
                            <option>PJOK</option>
                            <option>Bahasa Jawa</option>
                            <option>Seni Budaya dan Prakarya</option>
                            <option>Informatika</option>
                            <option value="Lainnya">Lainnya...</option>
                        </select>
                    </div>
                    <div class="form-group" id="mapel-lainnya-group" style="display: none;">
                        <label for="mapel-lainnya-input">Masukkan Mata Pelajaran</label>
                        <input type="text" id="mapel-lainnya-input" class="form-control">
                    </div>
                    <button id="save-selection-btn" class="btn btn-full" disabled>Simpan & Lanjutkan</button>
                </form>
            </div>
        </div>
    </div>

    <div id="editor-view" class="view">
        <div class="title-container">
            <h1 class="main-title">Editor Bank Soal</h1>
            <button class="settings-btn" id="settings-btn" title="Pengaturan Tampilan">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </div>
        
        <div class="editor-header">
            <div class="identitas-container">
                <span class="identitas-label">Ujian</span>
                <span class="identitas-value">: <strong id="info-ujian"></strong></span>
                <span class="identitas-label">Tahun Ajaran</span>
                <span class="identitas-value">: <strong id="info-ta"></strong></span>
                <span class="identitas-label">Kelas</span>
                <span class="identitas-value">: <strong id="info-kelas"></strong></span>
                <span class="identitas-label">Mata Pelajaran</span>
                <span class="identitas-value">: <strong id="info-mapel"></strong></span>
            </div>
            <div class="actions-container">
                <button id="add-soal-btn" class="btn btn-success">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                    <span>Tambah Soal</span>
                </button>
                <a href="https://drive.google.com/uc?export=download&id=1ASkItWXmUfAuJGKML-oX-4RT_2qusVD-" target="_blank" id="template-zip-btn" class="btn btn-purple">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                    <span>Template ZIP</span>
                </a>
                <button id="upload-btn" class="btn btn-primary">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg>
                    <span>Unggah ZIP</span>
                </button>
                <button id="clear-data-btn" class="btn btn-danger">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                    <span>Hapus Semua</span>
                </button>
            </div>
        </div>
        
        <input id="file-input" type="file" accept=".zip" />
        <div id="soal-list-container"></div>
        <div class="instructions-box">
            <h3>Petunjuk</h3>
            <ol>
                <li><strong>Tambah Soal:</strong> Klik untuk membuat soal baru dari awal.</li>
                <li><strong>Template ZIP:</strong> Unduh berkas ZIP yang berisi file HTML sebagai template.</li>
                <li><strong>Unggah ZIP:</strong> Unggah file ZIP yang sudah Anda perbarui untuk diproses.</li>
            </ol>
        </div>
    </div>

</div>

<div id="delete-modal" class="modal-overlay">
    <div class="modal-content">
        <p id="delete-modal-text"></p>
        <div class="confirmation-input-container" style="display: none;">
            <label for="confirmation-input">Ketik "<strong id="confirmation-word"></strong>" untuk konfirmasi:</label>
            <input type="text" id="confirmation-input" class="form-control">
        </div>
        <div class="modal-actions">
            <button id="modal-confirm-delete" class="btn-confirm">Ya, Hapus</button>
            <button id="modal-cancel-delete" class="btn-cancel">Batal</button>
        </div>
    </div>
</div>

<div id="info-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="info-modal-title"></h3>
        <p id="info-modal-text"></p>
        <div class="modal-actions">
            <button id="info-modal-close" class="btn">Saya Mengerti</button>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Pengaturan Tampilan</h3>
        <div class="theme-options">
            <button class="btn" id="light-theme-btn">Mode Terang</button>
            <button class="btn" id="dark-theme-btn">Mode Gelap</button>
        </div>
    </div>
</div>

<div id="processing-modal" class="modal-overlay">
    <div class="spinner-container">
        <div class="spinner"></div>
        <p id="processing-text">Sedang memproses...</p>
    </div>
</div>

<div id="toast-container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script type="module">
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
    
    const firebaseConfigs = {
        '7ABC': { apiKey: "AIzaSyBAKwT7JY_HGnvK6h3u30-dfgRPXfef8l8", authDomain: "abc-a13ea.firebaseapp.com", databaseURL: "https://abc-a13ea-default-rtdb.firebaseio.com", projectId: "abc-a13ea", storageBucket: "abc-a13ea.appspot.com", messagingSenderId: "1052966795599", appId: "1:1052966795599:web:d4d331199ca9081321ed3a" },
        '7DEF': { apiKey: "AIzaSyBkhBZw3oADXUAJ9FXY9-g7XBsSmQhzZVk", authDomain: "def-ab5ee.firebaseapp.com", databaseURL: "https://def-ab5ee-default-rtdb.firebaseio.com", projectId: "def-ab5ee", storageBucket: "def-ab5ee.appspot.com", messagingSenderId: "129712840107", appId: "1:129712840107:web:ab10576fed95f735dd46ee" },
        '8ABC': { apiKey: "AIzaSyAwilwwwEJ2MAdSf09BotxNH-z6RiXaHXY", authDomain: "abc-43e73.firebaseapp.com", databaseURL: "https://abc-43e73-default-rtdb.firebaseio.com", projectId: "abc-43e73", storageBucket: "abc-43e73.appspot.com", messagingSenderId: "1043754727577", appId: "1:1043754727577:web:56c3732bf2a6ac900c2008" },
        '8DEF': { apiKey: "AIzaSyBeCI57lmZ4-8DAKYJ7nvYjnXOfvy0vqrk", authDomain: "def-efcb2.firebaseapp.com", databaseURL: "https://def-efcb2-default-rtdb.firebaseio.com", projectId: "def-efcb2", storageBucket: "def-efcb2.appspot.com", messagingSenderId: "12569956361", appId: "1:12569956361:web:fea36c4e034e65f33ba8d8" },
        '9ABC': { apiKey: "AIzaSyBZ6JR3ggnUiZFQ-wdrewbfhzMUwFaGGzQ", authDomain: "abc-d272a.firebaseapp.com", databaseURL: "https://abc-d272a-default-rtdb.firebaseio.com", projectId: "abc-d272a", storageBucket: "abc-d272a.appspot.com", messagingSenderId: "1036605132828", appId: "1:1036605132828:web:2b59f91290d50afe304fd9" },
        '9DEF': { apiKey: "AIzaSyC2iwuDMWTaJIG8g464Wt0En3CXI2DZiz4", authDomain: "def-85f32.firebaseapp.com", databaseURL: "https://def-85f32-default-rtdb.firebaseio.com", projectId: "def-85f32", storageBucket: "def-85f32.appspot.com", messagingSenderId: "82670626048", appId: "1:82670626048:web:f5fdfda8fe078245b6bfe5" },
        'SETUP': { apiKey: "AIzaSyBbXJ4VuACXyHJhl2eVSB2vHiT6hrx-XnE", authDomain: "setup-73809.firebaseapp.com", databaseURL: "https://setup-73809-default-rtdb.firebaseio.com", projectId: "setup-73809", storageBucket: "setup-73809.appspot.com", messagingSenderId: "843995999446", appId: "1:843995999446:web:7fd92546f2d0bea73fed77" }
    };

    const firebaseApps = {};
    function initializeFirebaseApps() {
        for (const appName in firebaseConfigs) {
            if (!getApps().find(app => app.name === appName)) {
                firebaseApps[appName] = initializeApp(firebaseConfigs[appName], appName);
            } else {
                firebaseApps[appName] = getApp(appName);
            }
        }
    }

    const GITHUB_USERNAME = "speropa";
    const GITHUB_REPO = "gambarbanksoal";
    let githubToken = null; // Token will be fetched from Firebase

    let mainUser = null;
    let soalToDelete = null;
    let activeResizer = null;
    let currentSoalData = {}; 
    let isEditing = false; // Global state to track if any question is in edit mode

    // --- START: Toolbar variables ---
    const editorToolbar = document.getElementById('editor-toolbar');
    const toolbarImageInput = document.getElementById('toolbar-image-input');
    let lastFocusedEditable = null; // BUGFIX: Stores the last focused editable element
    let savedSelection = null;
    let imageTargetElement = null;
    // --- END: Toolbar variables ---

    const loadingView = document.getElementById('loading-view');
    const loadingText = document.getElementById('loading-text');
    const loadingError = document.getElementById('loading-error');
    const selectionView = document.getElementById('selection-view');
    const editorView = document.getElementById('editor-view');
    const selectionForm = document.getElementById('selection-form');
    const ujianSelect = document.getElementById('ujian-select');
    const tahunAjaranSelect = document.getElementById('tahun-ajaran-select');
    const kelasSelect = document.getElementById('kelas-select');
    const mapelSelect = document.getElementById('mapel-select');
    const mapelLainnyaGroup = document.getElementById('mapel-lainnya-group');
    const mapelLainnyaInput = document.getElementById('mapel-lainnya-input');
    const saveSelectionBtn = document.getElementById('save-selection-btn');
    const addSoalBtn = document.getElementById('add-soal-btn');
    const templateZipBtn = document.getElementById('template-zip-btn');
    const uploadBtn = document.getElementById('upload-btn');
    const clearDataBtn = document.getElementById('clear-data-btn');
    const fileInput = document.getElementById('file-input');
    const outputEl = document.getElementById('soal-list-container');
    const instructionsBox = document.querySelector('.instructions-box');
    const deleteModal = document.getElementById('delete-modal');
    const confirmDeleteBtn = document.getElementById('modal-confirm-delete');
    const cancelDeleteBtn = document.getElementById('modal-cancel-delete');
    const modalText = document.getElementById('delete-modal-text');
    const confirmationInputContainer = document.querySelector('.confirmation-input-container');
    const confirmationInput = document.getElementById('confirmation-input');
    const confirmationWord = document.getElementById('confirmation-word');
    const toastContainer = document.getElementById('toast-container');
    const processingModal = document.getElementById('processing-modal');
    const processingText = document.getElementById('processing-text');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const lightThemeBtn = document.getElementById('light-theme-btn');
    const darkThemeBtn = document.getElementById('dark-theme-btn');
    const infoModal = document.getElementById('info-modal');
    const infoModalTitle = document.getElementById('info-modal-title');
    const infoModalText = document.getElementById('info-modal-text');
    const infoModalCloseBtn = document.getElementById('info-modal-close');

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }
    
    function showProcessing(message) {
        processingText.textContent = message;
        processingModal.style.display = 'flex';
    }

    function hideProcessing() {
        processingModal.style.display = 'none';
    }
    
    function setGlobalActionsState(disabled) {
        addSoalBtn.disabled = disabled;
        uploadBtn.disabled = disabled;
        clearDataBtn.disabled = disabled;
        templateZipBtn.classList.toggle('disabled', disabled);
    }

    function showInfoOverlay(title, message) {
        infoModalTitle.textContent = title;
        infoModalText.innerHTML = message;
        infoModal.style.display = 'flex';
    }

    function getDbPath(data) {
        const { tahunAjaran, kelas, mapel, ujian } = data;
        const safeTA = tahunAjaran.replace(/[\.\#\$\[\]\/]/g, '-');
        const safeUjian = ujian.replace(/\s+/g, '-');
        const safeMapel = mapel.replace(/\s+/g, '-');
        return `ujian/${safeTA}/${safeUjian}/${safeMapel}/Kelas-${kelas}`;
    }

    async function fetchGithubToken() {
        try {
            const setupDb = getDatabase(firebaseApps['SETUP']);
            const tokenRef = ref(setupDb, 'github/token');
            const snapshot = await get(tokenRef);
            if (snapshot.exists()) {
                githubToken = snapshot.val();
                console.log("GitHub token successfully fetched.");
                return true;
            } else {
                throw new Error("Token GitHub tidak ditemukan di database 'SETUP'.");
            }
        } catch (error) {
            console.error("Gagal mengambil token GitHub:", error);
            loadingError.textContent = `Gagal mengambil token GitHub: ${error.message}`;
            loadingError.style.display = 'block';
            return false;
        }
    }

    async function performAutoLogin() {
        const email = "speropa@gmail.com";
        const password = "Pajangan201184*";
        loadingError.style.display = 'none';

        try {
            loadingText.textContent = 'Login ke semua layanan...';
            const loginPromises = Object.keys(firebaseApps).map(appName => {
                const appAuth = getAuth(firebaseApps[appName]);
                return signInWithEmailAndPassword(appAuth, email, password);
            });
            
            await Promise.all(loginPromises);
            console.log("Successfully logged in to all 7 projects.");

            loadingText.textContent = 'Mengambil konfigurasi keamanan...';
            const tokenFetched = await fetchGithubToken();

            if (tokenFetched) {
                showView('selection-view');
            }

        } catch (error) {
            loadingError.textContent = `Login Otomatis Gagal: ${error.message}`;
            loadingError.style.display = 'block';
            console.error("Auto-login failed:", error);
        }
    }

    function populateTahunAjaranDropdown() {
        const selectElement = document.getElementById('tahun-ajaran-select');
        const date = new Date();
        const currentYear = date.getFullYear();
        const currentMonth = date.getMonth(); // 0-11, so July is 6

        let latestAcademicYearStart = currentYear;
        if (currentMonth < 6) { 
            latestAcademicYearStart = currentYear - 1;
        }
        
        const firstYear = 2025;
        
        selectElement.innerHTML = '<option value="" disabled>Pilih tahun ajaran...</option>';

        for (let year = firstYear; year <= latestAcademicYearStart; year++) {
            const academicYearString = `${year}/${year + 1}`;
            const option = document.createElement('option');
            option.value = academicYearString;
            option.textContent = academicYearString;
            selectElement.appendChild(option);
        }

        const latestOptionValue = `${latestAcademicYearStart}/${latestAcademicYearStart + 1}`;
        selectElement.value = latestOptionValue;
    }

    function initialize() {
        populateTahunAjaranDropdown();
        initializeFirebaseApps();
        performAutoLogin();
        initializeToolbar();
    }

    function validateSelectionForm() {
        const isMapelLainnya = mapelSelect.value === 'Lainnya';
        const isMapelLainnyaFilled = mapelLainnyaInput.value.trim() !== '';
        
        let isValid = selectionForm.checkValidity();
        if (isMapelLainnya && !isMapelLainnyaFilled) {
            isValid = false;
        }
        
        saveSelectionBtn.disabled = !isValid;
    }

    selectionForm.addEventListener('input', validateSelectionForm);
    mapelSelect.addEventListener('change', () => {
        mapelLainnyaGroup.style.display = (mapelSelect.value === 'Lainnya') ? 'block' : 'none';
        mapelLainnyaInput.required = (mapelSelect.value === 'Lainnya');
        validateSelectionForm();
    });

    saveSelectionBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        validateSelectionForm();
        if (saveSelectionBtn.disabled) {
            showToast('Harap lengkapi semua isian identitas soal.', 'error');
            return;
        }

        const ujian = ujianSelect.value;
        const tahunAjaran = tahunAjaranSelect.value;
        const kelas = kelasSelect.value;
        let mapel = mapelSelect.value;
        if (mapel === 'Lainnya') {
            mapel = mapelLainnyaInput.value.trim();
        }
        
        currentSoalData = { ujian, tahunAjaran, kelas, mapel };
        
        document.getElementById('info-ujian').textContent = ujian;
        document.getElementById('info-ta').textContent = tahunAjaran;
        document.getElementById('info-kelas').textContent = kelas;
        document.getElementById('info-mapel').textContent = mapel;
        
        showView('loading-view');
        loadingText.textContent = 'Mencari data soal yang sudah ada...';
        
        await fetchAndRenderSoal();

        showView('editor-view');
    });
    
    async function fetchAndRenderSoal() {
        const dbPath = getDbPath(currentSoalData);
        
        let primaryDbName;
        if (currentSoalData.kelas == '7') primaryDbName = '7ABC';
        else if (currentSoalData.kelas == '8') primaryDbName = '8ABC';
        else if (currentSoalData.kelas == '9') primaryDbName = '9ABC';
        
        if (!primaryDbName) {
            showToast('Kelas tidak valid.', 'error');
            return;
        }
        
        const db = getDatabase(firebaseApps[primaryDbName]);
        const snapshot = await get(ref(db, dbPath));

        outputEl.innerHTML = ''; 

        if (snapshot.exists()) {
            const data = snapshot.val();
            renderSoalFromData(data);
            showToast(`Data berhasil dimuat. ${data.soal ? Object.keys(data.soal).length : 0} soal ditemukan.`, 'success');
        } else {
            showToast('Tidak ada data ditemukan. Silakan unggah file ZIP untuk memulai.', 'info');
        }
        updateUIForSoalPresence();
    }
    
    function renderSoalFromData(data) {
        if (!data.soal) return;
        
        const kunciArray = data.kunciJawaban ? data.kunciJawaban.split(',') : [];

        for (const nomor in data.soal) {
            if (data.soal.hasOwnProperty(nomor)) {
                const soalDetail = data.soal[nomor];
                const kunci = kunciArray[parseInt(nomor) - 1] || '';
                const soalDiv = createSoalElement(soalDetail, kunci, nomor);
                outputEl.appendChild(soalDiv);
            }
        }
        initializeSortable();
    }

    async function uploadImageToGithub(file, base64Content) {
        if (!githubToken) {
            showToast('Token keamanan tidak valid. Operasi dibatalkan.', 'error');
            throw new Error('GitHub token is not available.');
        }
        const fileName = `${Date.now()}-${file.name}`;
        const { tahunAjaran, kelas, mapel, ujian } = currentSoalData;
        const safePath = `${tahunAjaran.replace('/', '-')}/${kelas}/${mapel.replace(/\s+/g, '-')}/${ujian.replace(/\s+/g, '-')}`;
        const path = `${safePath}/${fileName}`;

        const data = {
            message: `Upload gambar soal: ${fileName}`,
            content: base64Content,
        };
        const response = await fetch(
            `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${path}`,
            {
                method: 'PUT',
                headers: { 'Authorization': `token ${githubToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            }
        );
        const result = await response.json();
        if (!response.ok) throw new Error(`Gagal mengunggah ke GitHub: ${result.message}`);
        return result.content.download_url;
    }

    async function deleteImageFromGithub(imageUrl) {
        if (!githubToken) {
            showToast('Token keamanan tidak valid. Operasi dibatalkan.', 'error');
            throw new Error('GitHub token is not available.');
        }
        if (!imageUrl || !imageUrl.includes('raw.githubusercontent.com')) return;
        
        const path = imageUrl.split(`${GITHUB_USERNAME}/${GITHUB_REPO}/main/`)[1];
        if (!path) return;

        try {
            const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${path}`, {
                headers: { 'Authorization': `token ${githubToken}` }
            });
            const fileData = await res.json();
            if (!res.ok) {
                if (res.status === 404) {
                     console.log(`Gambar sudah tidak ada di GitHub: ${imageUrl}`);
                     return;
                }
                throw new Error(`Gagal mendapatkan SHA file: ${fileData.message}`);
            }

            const deleteRes = await fetch(fileData.url, { // Use the API URL from the response
                method: 'DELETE',
                headers: { 'Authorization': `token ${githubToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Hapus gambar: ${fileData.name}`, sha: fileData.sha })
            });
            if (!deleteRes.ok) throw new Error(`Gagal menghapus file dari GitHub.`);
            console.log(`Gambar ${fileData.name} berhasil dihapus.`);

        } catch (error) {
            console.error(`Gagal menghapus gambar dari GitHub: ${imageUrl}`, error);
        }
    }

    async function deleteGithubDirectory(path) {
        if (!githubToken) {
            showToast('Token keamanan tidak valid. Operasi dibatalkan.', 'error');
            throw new Error('GitHub token is not available.');
        }
        try {
            const response = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${path}`, {
                headers: { 'Authorization': `token ${githubToken}` }
            });

            if (!response.ok) {
                if (response.status === 404) {
                    console.log(`Folder ${path} tidak ditemukan, tidak perlu dihapus.`);
                    return;
                }
                throw new Error(`Gagal mendapatkan konten folder: ${response.statusText}`);
            }

            const contents = await response.json();
            if (!Array.isArray(contents)) return;

            for (const item of contents) {
                if (item.type === 'dir') {
                    await deleteGithubDirectory(item.path); // Recursive call
                } else if (item.type === 'file') {
                    await deleteImageFromGithub(item.download_url); // Delete file
                }
            }
        } catch (error) {
            console.error(`Gagal memproses penghapusan folder ${path}:`, error);
        }
    }

    function validateAllSoal() {
        let isAllValid = true;
        
        function isContentEmpty(element) {
            const hasText = element.textContent.trim() !== '';
            const hasImage = element.querySelector('img') !== null;
            return !hasText && !hasImage;
        }

        document.querySelectorAll('.soal-container').forEach(soalDiv => {
            const errorMessages = [];
            const pertanyaanEl = soalDiv.querySelector('.soal-pertanyaan');
            const pilihanAEl = soalDiv.querySelector('li:nth-child(1) div');
            const pilihanBEl = soalDiv.querySelector('li:nth-child(2) div');
            const pilihanCEl = soalDiv.querySelector('li:nth-child(3) div');
            const pilihanDEl = soalDiv.querySelector('li:nth-child(4) div');
            const kunciEl = soalDiv.querySelector('.soal-kunci-jawaban div');

            if (isContentEmpty(pertanyaanEl)) errorMessages.push('Pertanyaan tidak boleh kosong.');
            if (isContentEmpty(pilihanAEl)) errorMessages.push('Pilihan A tidak boleh kosong.');
            if (isContentEmpty(pilihanBEl)) errorMessages.push('Pilihan B tidak boleh kosong.');
            if (isContentEmpty(pilihanCEl)) errorMessages.push('Pilihan C tidak boleh kosong.');
            if (isContentEmpty(pilihanDEl)) errorMessages.push('Pilihan D tidak boleh kosong.');
            if (!kunciEl.textContent.trim()) errorMessages.push('Kunci Jawaban tidak boleh kosong.');

            const errorEl = soalDiv.querySelector('.soal-validation-error');
            if (errorMessages.length > 0) {
                isAllValid = false;
                soalDiv.classList.add('invalid-soal');
                errorEl.innerHTML = errorMessages.join('<br>');
                errorEl.style.display = 'block';
            } else {
                soalDiv.classList.remove('invalid-soal');
                errorEl.style.display = 'none';
            }
        });
        return isAllValid;
    }

    async function saveAllSoalToDatabase() {
        if (!validateAllSoal()) {
            showToast('Terdapat soal yang tidak valid. Perubahan tidak disimpan.', 'error');
            const firstInvalid = document.querySelector('.invalid-soal');
            if (firstInvalid) {
                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            hideProcessing();
            return;
        }
        
        showProcessing('Menyimpan semua perubahan...');

        try {
            const soalElements = document.querySelectorAll('.soal-container');
            
            if (soalElements.length === 0) {
                 await clearAllDataFromDB();
                 showToast('Semua soal telah dihapus dan data dikosongkan.', 'success');
                 hideProcessing();
                 return;
            }

            const kunciList = [];
            const soalObject = {};
            soalElements.forEach((soalDiv, index) => {
                const nomorSoal = index + 1;
                kunciList.push(soalDiv.querySelector('.soal-kunci-jawaban div').innerHTML);
                soalObject[nomorSoal] = {
                    pertanyaan: soalDiv.querySelector('.soal-pertanyaan').innerHTML,
                    pilihanA: soalDiv.querySelector('li:nth-child(1) div').innerHTML,
                    pilihanB: soalDiv.querySelector('li:nth-child(2) div').innerHTML,
                    pilihanC: soalDiv.querySelector('li:nth-child(3) div').innerHTML,
                    pilihanD: soalDiv.querySelector('li:nth-child(4) div').innerHTML,
                };
            });

            const finalData = { ...currentSoalData, terakhirUpdate: new Date().toISOString(), soal: soalObject, kunciJawaban: kunciList.join(',') };
            const dbPath = getDbPath(finalData);
            
            const targetDbNames = [];
            if (finalData.kelas == '7') targetDbNames.push('7ABC', '7DEF');
            else if (finalData.kelas == '8') targetDbNames.push('8ABC', '8DEF');
            else if (finalData.kelas == '9') targetDbNames.push('9ABC', '9DEF');

            if (targetDbNames.length === 0) throw new Error("Kelas tidak valid.");

            const writePromises = targetDbNames.map(appName => {
                const targetDb = getDatabase(firebaseApps[appName]);
                return set(ref(targetDb, dbPath), finalData);
            });

            await Promise.all(writePromises);
            showToast('Perubahan berhasil disimpan!', 'success');
            
        } catch (error) {
            showToast(`Penyimpanan Gagal: ${error.message}`, 'error');
            console.error("Save all error:", error);
        } finally {
            hideProcessing();
        }
    }

    async function clearAllDataFromDB() {
        const dbPath = getDbPath(currentSoalData);
        const targetDbNames = [];
        if (currentSoalData.kelas == '7') targetDbNames.push('7ABC', '7DEF');
        else if (currentSoalData.kelas == '8') targetDbNames.push('8ABC', '8DEF');
        else if (currentSoalData.kelas == '9') targetDbNames.push('9ABC', '9DEF');
        
        if (targetDbNames.length === 0) return;

        const deletePromises = targetDbNames.map(appName => {
            const targetDb = getDatabase(firebaseApps[appName]);
            return remove(ref(targetDb, dbPath));
        });
        await Promise.all(deletePromises);
    }

    addSoalBtn.addEventListener('click', () => {
        if (isEditing) {
            showToast('Harap simpan atau batalkan perubahan pada soal yang sedang diedit.', 'error');
            return;
        }

        const nomorSoalBaru = document.querySelectorAll('.soal-container').length + 1;
        const soalDetailKosong = {
            pertanyaan: '',
            pilihanA: '',
            pilihanB: '',
            pilihanC: '',
            pilihanD: ''
        };
        const kunciKosong = '';

        const soalDivBaru = createSoalElement(soalDetailKosong, kunciKosong, nomorSoalBaru);
        soalDivBaru.dataset.isNew = 'true'; // Mark as a new question
        outputEl.appendChild(soalDivBaru);

        enterEditMode(soalDivBaru);
        soalDivBaru.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });

    clearDataBtn.addEventListener('click', () => {
        if (isEditing) {
            showToast('Harap simpan perubahan pada soal yang sedang diedit terlebih dahulu.', 'error');
            return;
        }
        modalText.textContent = "Apakah Anda YAKIN ingin menghapus SEMUA data dan gambar untuk ujian ini? Tindakan ini tidak bisa dibatalkan.";
        confirmationInputContainer.style.display = 'block';
        confirmationWord.textContent = "HAPUS";
        confirmationInput.value = '';
        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.onclick = executeClearData;
        deleteModal.style.display = 'flex';
    });
    
    confirmationInput.addEventListener('input', () => {
        confirmDeleteBtn.disabled = confirmationInput.value !== "HAPUS";
    });

    async function executeClearData() {
        deleteModal.style.display = 'none';
        showProcessing('Menghapus data...');

        const { tahunAjaran, kelas, mapel, ujian } = currentSoalData;
        const githubFolderPath = `${tahunAjaran.replace('/', '-')}/${kelas}/${mapel.replace(/\s+/g, '-')}/${ujian.replace(/\s+/g, '-')}`;

        try {
            processingText.textContent = 'Menghapus data dari server...';
            await clearAllDataFromDB();
            
            processingText.textContent = 'Menghapus file gambar...';
            await deleteGithubDirectory(githubFolderPath);

            showToast('Semua data dan gambar berhasil dihapus!', 'success');
            outputEl.innerHTML = ''; 
            updateUIForSoalPresence();

        } catch(error) {
            showToast(`Gagal menghapus data: ${error.message}`, 'error');
            console.error("Clear data error:", error);
        } finally {
            hideProcessing();
        }
    }

    uploadBtn.addEventListener('click', () => {
        if (isEditing) {
            showToast('Harap simpan perubahan pada soal yang sedang diedit terlebih dahulu.', 'error');
            return;
        }
        fileInput.click();
    });
    
    fileInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        showProcessing(`Memproses file: ${file.name}...`);
        await processZipFile(file);
        hideProcessing();
        
        updateUIForSoalPresence();
        if (outputEl.children.length > 0) {
            showInfoOverlay("Proses Selesai!", "Silakan review setiap butir soal. Untuk mengedit, klik tombol 'Edit Soal' pada soal yang diinginkan. Setiap perubahan akan disimpan secara otomatis.");
            await saveAllSoalToDatabase();
        }
    });

    async function processZipFile(file) {
        outputEl.innerHTML = '';
        if (activeResizer) removeResizer();

        try {
            const zip = await JSZip.loadAsync(file);
            const htmlFile = zip.file(/.+\.html?$/i)[0];
            if (!htmlFile) throw new Error("File .html tidak ditemukan di dalam ZIP.");
            
            const fileContentAsArray = await htmlFile.async('uint8array');
            const decoder = new TextDecoder('windows-1252');
            let htmlContent = decoder.decode(fileContentAsArray);
            const tempDoc = new DOMParser().parseFromString(htmlContent, 'text/html');
            
            const imagesInDoc = Array.from(tempDoc.getElementsByTagName('img'));
            
            for (const img of imagesInDoc) {
                const src = img.getAttribute('src');
                if (src && !src.startsWith('data:') && !src.startsWith('http')) {
                    try {
                        const decodedSrc = decodeURIComponent(src);
                        const imageFile = zip.file(decodedSrc);
                        if (imageFile) {
                            const base64Content = await imageFile.async('base64');
                            const extension = imageFile.name.split('.').pop().toLowerCase();
                            img.src = `data:image/${extension};base64,${base64Content}`;
                            img.dataset.fileName = imageFile.name;
                        }
                    } catch (e) { console.warn(`Gagal memuat gambar: ${src}`, e); }
                }
            }
            
            parseHtmlAndDisplay(tempDoc.body);
        } catch (err) {
            showToast("Gagal fatal saat memproses file ZIP.", 'error');
            console.error(err);
        }
    }
    
    function createSoalElement(soalDetail, kunci, nomor) {
        const soalDiv = document.createElement('div');
        soalDiv.className = 'soal-container disabled review-mode';
        
        soalDiv.innerHTML = `
            <div class="soal-header">
                <div class="soal-nomor-container">
                    <h3 class="soal-nomor" style="display: flex; align-items: center; gap: 5px;">Soal <span>${nomor}</span></h3>
                    <input type="number" class="soal-nomor-input" value="${nomor}" style="display: none;" min="1">
                </div>
                <div class="drag-handle" title="Seret untuk mengubah urutan"><span></span><span></span><span></span><span></span><span></span><span></span></div>
                <div class="soal-actions">
                    <button class="btn edit-btn">Edit Soal</button>
                    <button class="btn delete-btn btn-danger">Hapus</button>
                    <button class="btn save-btn btn-success" style="display: none;">Simpan</button>
                    <button class="btn cancel-edit-btn btn-secondary" style="display: none;">Batal</button>
                </div>
            </div>
            <div class="soal-pertanyaan" contenteditable="false" data-placeholder="Ketik pertanyaan di sini...">${soalDetail.pertanyaan}</div>
            <ul>
                <li><b>A.</b> <div contenteditable="false" dir="auto">${soalDetail.pilihanA}</div></li>
                <li><b>B.</b> <div contenteditable="false" dir="auto">${soalDetail.pilihanB}</div></li>
                <li><b>C.</b> <div contenteditable="false" dir="auto">${soalDetail.pilihanC}</div></li>
                <li><b>D.</b> <div contenteditable="false" dir="auto">${soalDetail.pilihanD}</div></li>
            </ul>
            <div class="soal-kunci-jawaban">
                <span>Kunci Jawaban:</span>
                <div contenteditable="false" dir="auto">${kunci}</div>
            </div>
            <div class="soal-validation-error"></div>
        `;
        
        classifyImages(soalDiv);
        return soalDiv;
    }

    function parseHtmlAndDisplay(bodyElement) {
        const tables = bodyElement.getElementsByTagName('table');
        if (tables.length === 0) {
            showToast("Error: Tidak ada tabel format soal ditemukan di dalam file.", 'error');
            return;
        }
        let soalDitemukan = 0;
        for (const table of tables) {
            const rows = table.rows;
            for (let i = 0; i < rows.length; i++) {
                const firstCell = rows[i]?.cells[0];
                if (!firstCell || isNaN(parseInt(firstCell.textContent.trim(), 10))) continue;
                
                const questionCell = rows[i]?.cells[1];
                if (!questionCell || !questionCell.textContent.trim()) {
                    i += 5; 
                    continue;
                }

                if (i + 5 >= rows.length) continue;

                try {
                    soalDitemukan++;
                    const soalDetail = {
                        pertanyaan: cleanHtml(questionCell, true), // Allow paragraphs
                        pilihanA: cleanHtml(rows[i+1]?.cells[1], false), // No paragraphs
                        pilihanB: cleanHtml(rows[i+2]?.cells[1], false),
                        pilihanC: cleanHtml(rows[i+3]?.cells[1], false),
                        pilihanD: cleanHtml(rows[i+4]?.cells[1], false)
                    };
                    const kunci = cleanHtml(rows[i+5]?.cells[1], false);
                    
                    const soalDiv = createSoalElement(soalDetail, kunci, soalDitemukan);
                    outputEl.appendChild(soalDiv);
                    i += 5; 
                } catch (e) { console.error(`Gagal memproses blok soal.`, e); }
            }
        }
        if (soalDitemukan > 0) {
            showToast(`Selesai! ${soalDitemukan} soal berhasil dibaca.`, 'success');
            initializeSortable();
        } else {
            showToast(`Selesai, namun tidak ada soal yang cocok formatnya atau semua soal kosong.`, 'error');
        }
    }

    function cleanHtml(element, allowParagraphs) {
        if (!element) return '';
        const clone = element.cloneNode(true);

        clone.querySelectorAll('*').forEach(child => {
            child.removeAttribute('style');
            child.removeAttribute('class');
            child.removeAttribute('lang');
            // Remove other unnecessary attributes if needed
        });
        
        if (!allowParagraphs) {
            clone.querySelectorAll('p').forEach(p => {
                if (p.innerHTML.trim() === '' || p.innerHTML.trim() === '&nbsp;') {
                    p.remove();
                } else {
                    p.replaceWith(...p.childNodes, document.createElement('br'));
                }
            });
        }
        
        let html = clone.innerHTML;
        html = html.replace(/&nbsp;/g, ' ');
        html = html.replace(/(<br\s*\/?>\s*){2,}/gi, '<br>'); 
        html = html.trim().replace(/^<br\s*\/?>|<br\s*\/?>$/gi, '').trim();

        return html;
    }

    function classifyImages(containerElement) {
        containerElement.querySelectorAll('img').forEach(img => {
            if (img.style.width || img.style.height) {
                return;
            }

            const wrapper = img.closest('.resizable-wrapper');
            const elementToCheck = wrapper || img;
            const p = elementToCheck.parentElement;

            if (!p || (p.tagName !== 'P' && p.tagName !== 'DIV')) {
                img.classList.add('img-inline');
                img.classList.remove('img-block');
                return;
            }

            const hasOtherContent = Array.from(p.childNodes).some(node => {
                if (node === elementToCheck) return false;
                if (node.nodeType === 3 && node.textContent.trim() !== '') return true;
                if (node.nodeType === 1 && node.tagName !== 'BR' && !node.contains(elementToCheck)) return true;
                return false;
            });

            if (hasOtherContent) {
                img.classList.add('img-inline');
                img.classList.remove('img-block');
            } else {
                img.classList.add('img-block');
                img.classList.remove('img-inline');
            }
        });
    }
    
    function resetSoalContainerUI(soalContainer) {
        soalContainer.classList.add('review-mode');
        soalContainer.classList.remove('is-editing');
        soalContainer.querySelectorAll('[contenteditable]').forEach(el => el.setAttribute('contenteditable', 'false'));

        soalContainer.querySelector('.soal-nomor').style.display = 'flex';
        soalContainer.querySelector('.soal-nomor-input').style.display = 'none';

        soalContainer.querySelector('.edit-btn').style.display = 'inline-flex';
        soalContainer.querySelector('.delete-btn').style.display = 'inline-flex';
        soalContainer.querySelector('.save-btn').style.display = 'none';
        soalContainer.querySelector('.cancel-edit-btn').style.display = 'none';

        document.querySelectorAll('.soal-container').forEach(container => {
            container.classList.add('disabled');
        });
    }

    function enterEditMode(soalContainer) {
        isEditing = true;
        setGlobalActionsState(true);
        soalContainer.classList.remove('review-mode');

        const nomorDisplay = soalContainer.querySelector('.soal-nomor');
        const nomorInput = soalContainer.querySelector('.soal-nomor-input');
        const totalSoal = document.querySelectorAll('.soal-container').length;

        soalContainer.dataset.originalNumber = nomorDisplay.querySelector('span').textContent;
        nomorInput.value = soalContainer.dataset.originalNumber;
        nomorInput.max = soalContainer.dataset.isNew === 'true' ? totalSoal : totalSoal;

        nomorDisplay.style.display = 'none';
        nomorInput.style.display = 'block';

        if (soalContainer.dataset.isNew !== 'true') {
            const originalContent = {
                pertanyaan: soalContainer.querySelector('.soal-pertanyaan').innerHTML,
                pilihanA: soalContainer.querySelector('li:nth-child(1) div').innerHTML,
                pilihanB: soalContainer.querySelector('li:nth-child(2) div').innerHTML,
                pilihanC: soalContainer.querySelector('li:nth-child(3) div').innerHTML,
                pilihanD: soalContainer.querySelector('li:nth-child(4) div').innerHTML,
                kunci: soalContainer.querySelector('.soal-kunci-jawaban div').innerHTML,
            };
            soalContainer.dataset.originalContent = JSON.stringify(originalContent);
        }
        
        const initialImages = Array.from(soalContainer.querySelectorAll('img')).map(img => img.src);
        soalContainer.dataset.initialImages = JSON.stringify(initialImages);

        document.querySelectorAll('.soal-container').forEach(container => {
            if (container !== soalContainer) {
                container.classList.add('disabled');
            } else {
                container.classList.remove('disabled');
                container.classList.add('is-editing');
            }
        });

        soalContainer.querySelectorAll('[contenteditable]').forEach(el => el.setAttribute('contenteditable', 'true'));
        
        soalContainer.querySelector('.edit-btn').style.display = 'none';
        soalContainer.querySelector('.delete-btn').style.display = 'none';
        soalContainer.querySelector('.save-btn').style.display = 'inline-flex';
        soalContainer.querySelector('.cancel-edit-btn').style.display = 'inline-flex';
        
        const firstEditable = soalContainer.querySelector('.soal-pertanyaan');
        if (firstEditable) {
            firstEditable.focus();
            showToolbar(firstEditable);
        }
    }

    async function exitEditMode(soalContainer) {
        if (activeResizer) removeResizer();
        
        const nomorInput = soalContainer.querySelector('.soal-nomor-input');
        const newPosition = parseInt(nomorInput.value, 10);
        const totalSoal = document.querySelectorAll('.soal-container').length;

        if (isNaN(newPosition) || newPosition < 1 || newPosition > totalSoal) {
            showToast(`Nomor soal tidak valid. Harus antara 1 dan ${totalSoal}.`, 'error');
            nomorInput.value = soalContainer.dataset.originalNumber;
            return;
        }

        const kunciJawabanEl = soalContainer.querySelector('.soal-kunci-jawaban div');
        const kunciJawaban = kunciJawabanEl.textContent.trim().toUpperCase();
        if (!['A', 'B', 'C', 'D'].includes(kunciJawaban)) {
            showToast('Kunci Jawaban tidak valid. Harap isi dengan A, B, C, atau D.', 'error');
            return;
        }
        kunciJawabanEl.textContent = kunciJawaban;

        showProcessing('Menyimpan perubahan...');

        const allSoal = Array.from(outputEl.querySelectorAll('.soal-container'));
        const originalIndex = allSoal.indexOf(soalContainer);
        if ((newPosition - 1) !== originalIndex) {
            const [movedItem] = allSoal.splice(originalIndex, 1);
            allSoal.splice(newPosition - 1, 0, movedItem);
            outputEl.innerHTML = '';
            allSoal.forEach(el => outputEl.appendChild(el));
        }

        const initialImages = JSON.parse(soalContainer.dataset.initialImages || '[]');
        const finalImages = [];

        for (const img of Array.from(soalContainer.querySelectorAll('img'))) {
            if (img.src.startsWith('data:image')) {
                const base64String = img.src.split(',')[1];
                const fileName = img.dataset.fileName || 'pasted-image.png';
                try {
                    const githubUrl = await uploadImageToGithub({ name: fileName }, base64String);
                    img.src = githubUrl;
                    finalImages.push(githubUrl);
                } catch (error) {
                    hideProcessing();
                    showToast(`Gagal mengunggah gambar: ${error.message}`, 'error');
                    return;
                }
            } else {
                finalImages.push(img.src);
            }
        }

        const imagesToDelete = initialImages.filter(src => src.includes('github') && !finalImages.includes(src));
        for (const imageUrl of imagesToDelete) {
            await deleteImageFromGithub(imageUrl);
        }
        
        renumberSoal();
        await saveAllSoalToDatabase();
        
        if (!soalContainer.classList.contains('invalid-soal')) {
            isEditing = false;
            delete soalContainer.dataset.isNew;
            resetSoalContainerUI(soalContainer);
            hideToolbar();
            setGlobalActionsState(false);
        }
    }

    function cancelEditMode(soalContainer) {
        if (activeResizer) removeResizer();

        if (soalContainer.dataset.isNew === 'true') {
            soalContainer.remove();
            renumberSoal();
        } else {
            const originalContent = JSON.parse(soalContainer.dataset.originalContent);
            soalContainer.querySelector('.soal-pertanyaan').innerHTML = originalContent.pertanyaan;
            soalContainer.querySelector('li:nth-child(1) div').innerHTML = originalContent.pilihanA;
            soalContainer.querySelector('li:nth-child(2) div').innerHTML = originalContent.pilihanB;
            soalContainer.querySelector('li:nth-child(3) div').innerHTML = originalContent.pilihanC;
            soalContainer.querySelector('li:nth-child(4) div').innerHTML = originalContent.pilihanD;
            soalContainer.querySelector('.soal-kunci-jawaban div').innerHTML = originalContent.kunci;
            resetSoalContainerUI(soalContainer);
        }
        
        isEditing = false;
        hideToolbar();
        setGlobalActionsState(false);
        updateUIForSoalPresence();
    }

    outputEl.addEventListener('click', function(e) {
        const soalContainer = e.target.closest('.soal-container');
        if (!soalContainer) return;

        const editBtn = e.target.closest('.edit-btn');
        const saveBtn = e.target.closest('.save-btn');
        const deleteBtn = e.target.closest('.delete-btn');
        const cancelBtn = e.target.closest('.cancel-edit-btn');

        if (editBtn) {
            if (isEditing) {
                showToast('Harap simpan perubahan pada soal lain terlebih dahulu.', 'error');
                return;
            }
            enterEditMode(soalContainer);
            return;
        }

        if (saveBtn) {
            exitEditMode(soalContainer);
            return;
        }
        
        if (cancelBtn) {
            cancelEditMode(soalContainer);
            return;
        }

        if (deleteBtn) {
             if (isEditing) {
                return;
             }
             soalToDelete = soalContainer;
             modalText.textContent = "Apakah Anda yakin ingin menghapus soal ini? Perubahan akan langsung disimpan.";
             confirmationInputContainer.style.display = 'none';
             confirmDeleteBtn.disabled = false;
             confirmDeleteBtn.onclick = executeDeleteSoal;
             deleteModal.style.display = 'flex';
             return;
        }

        if (soalContainer.classList.contains('disabled')) {
            return;
        }
        
        const isImage = e.target.tagName === 'IMG' && !e.target.closest('.resizable-wrapper');
        if (isImage) {
            makeImageResizable(e.target);
            e.stopPropagation();
        }
    });

    document.addEventListener('click', function(e) { if (activeResizer && !activeResizer.wrapper.contains(e.target)) removeResizer(); });
    cancelDeleteBtn.addEventListener('click', () => { deleteModal.style.display = 'none'; });
    infoModalCloseBtn.addEventListener('click', () => { infoModal.style.display = 'none'; });

    async function executeDeleteSoal() {
        if (!soalToDelete) return;
        deleteModal.style.display = 'none';
        showProcessing('Menghapus soal...');

        const imagesToDelete = Array.from(soalToDelete.querySelectorAll('img')).map(img => img.src);
        for (const imageUrl of imagesToDelete) {
            await deleteImageFromGithub(imageUrl);
        }

        soalToDelete.remove();
        renumberSoal();
        await saveAllSoalToDatabase();
        soalToDelete = null;
        updateUIForSoalPresence();
    }
    
    function makeImageResizable(img) { 
        if (activeResizer) removeResizer();
        const wrapper = document.createElement('div'); 
        wrapper.className = 'resizable-wrapper'; 
        
        wrapper.style.width = img.style.width || `${img.offsetWidth}px`;
        wrapper.style.height = img.style.height || `${img.offsetHeight}px`;

        img.parentNode.insertBefore(wrapper, img); 
        wrapper.appendChild(img); 
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.maxHeight = 'none'; 
        ['top-left', 'top-right', 'bottom-left', 'bottom-right'].forEach(c => { 
            const h = document.createElement('div'); 
            h.className = 'resizer ' + c; 
            wrapper.appendChild(h); 
            h.addEventListener('mousedown', startResize, { passive: false }); 
            h.addEventListener('touchstart', startResize, { passive: false }); 
        }); 
        activeResizer = { wrapper, img }; 
    }
    
    function removeResizer() { 
        if (activeResizer) { 
            const { wrapper, img } = activeResizer; 
            img.style.width = wrapper.style.width;
            img.style.height = wrapper.style.height; 
            img.classList.remove('img-inline', 'img-block');
            img.style.verticalAlign = 'middle';
            img.style.maxHeight = '';
            if (wrapper.parentNode) {
                wrapper.parentNode.insertBefore(img, wrapper); 
                wrapper.remove(); 
            }
            activeResizer = null; 
        } 
    }

    function startResize(e) { 
        e.preventDefault(); 
        e.stopPropagation(); 
        const { wrapper, img } = activeResizer; 
        const aspectRatio = img.naturalWidth / img.naturalHeight;
        const handle = e.target; 
        const startX = e.clientX || e.touches[0].clientX; 
        const startWidth = wrapper.offsetWidth; 
        function doResize(e) { 
            const currentX = e.clientX || e.touches[0].clientX; 
            let newWidth = handle.classList.contains('bottom-right') || handle.classList.contains('top-right') ? startWidth + (currentX - startX) : startWidth - (currentX - startX); 
            if (newWidth > 20) {
                wrapper.style.width = newWidth + 'px';
                wrapper.style.height = `${newWidth / aspectRatio}px`;
            }
        } 
        function stopResize() { 
            document.removeEventListener('mousemove', doResize); 
            document.removeEventListener('mouseup', stopResize); 
            document.removeEventListener('touchmove', doResize); 
            document.removeEventListener('touchend', stopResize); 
        } 
        document.addEventListener('mousemove', doResize); 
        document.addEventListener('mouseup', stopResize); 
        document.addEventListener('touchmove', doResize); 
        document.addEventListener('touchend', stopResize); 
    }
    function renumberSoal() {
        document.querySelectorAll('.soal-container').forEach((soal, index) => {
            const newNumber = index + 1;
            soal.querySelector('.soal-nomor span').textContent = newNumber;
            const input = soal.querySelector('.soal-nomor-input');
            if (input) {
                input.value = newNumber;
                input.max = document.querySelectorAll('.soal-container').length;
            }
            soal.dataset.originalNumber = newNumber;
        });
    }
    function initializeSortable() { 
        new Sortable(outputEl, { 
            animation: 150, 
            ghostClass: 'sortable-ghost', 
            handle: '.drag-handle', 
            onEnd: async function() {
                renumberSoal();
                await saveAllSoalToDatabase();
            } 
        }); 
    }

    function saveSelection() {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            savedSelection = selection.getRangeAt(0);
        }
    }

    function restoreSelection() {
        if (savedSelection) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(savedSelection);
        }
    }

    function showToolbar(element) {
        if (activeResizer) removeResizer();
        const rect = element.getBoundingClientRect();
        editorToolbar.style.display = 'flex';
        
        let top = window.scrollY + rect.top - editorToolbar.offsetHeight - 8;
        if (top < window.scrollY) {
            top = window.scrollY + rect.bottom + 8;
        }

        let left = window.scrollX + rect.left + (rect.width / 2) - (editorToolbar.offsetWidth / 2);
        if (left < 0) left = 5;
        if (left + editorToolbar.offsetWidth > window.innerWidth) {
            left = window.innerWidth - editorToolbar.offsetWidth - 5;
        }

        editorToolbar.style.top = `${top}px`;
        editorToolbar.style.left = `${left}px`;
    }

    function hideToolbar() {
        editorToolbar.style.display = 'none';
        lastFocusedEditable = null;
        savedSelection = null;
    }

    function initializeToolbar() {
        outputEl.addEventListener('focusin', (e) => {
            if (e.target.getAttribute('contenteditable') === 'true') {
                lastFocusedEditable = e.target;
                showToolbar(e.target);
            }
        });

        outputEl.addEventListener('focusout', (e) => {
            if (e.target.getAttribute('contenteditable') === 'true') {
                saveSelection();
            }
        });

        editorToolbar.addEventListener('mousedown', (e) => {
            e.preventDefault();
            const button = e.target.closest('button');
            if (!button) return;

            const command = button.dataset.command;
            const targetElement = lastFocusedEditable;
            
            if (!targetElement) {
                showToast('Silakan klik di dalam area teks terlebih dahulu.', 'error');
                return;
            }

            if (command === 'insertImage') {
                imageTargetElement = targetElement;
                toolbarImageInput.click();
            } else {
                targetElement.focus();
                restoreSelection();
                document.execCommand(command, false, null);
            }
        });

        toolbarImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file || !imageTargetElement) {
                imageTargetElement = null;
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                const imgHTML = `<img src="${event.target.result}" data-file-name="${file.name}">`;
                
                imageTargetElement.focus();
                restoreSelection();
                document.execCommand('insertHTML', false, imgHTML);
                
                const container = imageTargetElement.closest('.soal-container');
                if (container) {
                    classifyImages(container);
                }

                setTimeout(() => {
                    imageTargetElement.focus();
                    showToolbar(imageTargetElement);
                    imageTargetElement = null;
                }, 100);
            };
            reader.readAsDataURL(file);
            toolbarImageInput.value = '';
        });
    }

    function updateUIForSoalPresence() {
        const hasSoal = outputEl.children.length > 0;
        instructionsBox.style.display = hasSoal ? 'none' : 'block';
        clearDataBtn.disabled = !hasSoal;
    }

    settingsBtn.addEventListener('click', () => settingsModal.style.display = 'flex');
    settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) settingsModal.style.display = 'none'; });
    lightThemeBtn.addEventListener('click', () => { document.body.classList.remove('dark-mode'); localStorage.setItem('theme', 'light'); settingsModal.style.display = 'none'; });
    darkThemeBtn.addEventListener('click', () => { document.body.classList.add('dark-mode'); localStorage.setItem('theme', 'dark'); settingsModal.style.display = 'none'; });

    function loadTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') document.body.classList.add('dark-mode');
        else document.body.classList.remove('dark-mode');
    }
    
    loadTheme();
    initialize();
</script>
</body>
</html>
