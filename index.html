<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Editor Bank Soal (Universal - Support WPS/Office)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- GAYA CSS DARI VERSI UI LENGKAP --- */
        :root {
            --primary-color: #4A90E2;
            --primary-hover: #357ABD;
            --secondary-color: #6c757d;
            --secondary-hover: #5a6268;
            --success-color: #28a745;
            --success-hover: #218838;
            --purple-color: #8e44ad;
            --purple-hover: #732d91;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --info-color: #17a2b8;
            --info-hover: #138496;
            --background-color: #F7F9FC;
            --card-background: #FFFFFF;
            --text-color: #333;
            --label-color: #555;
            --border-color: #DDE2E8;
            --error-bg-color: #F8D7DA;
            --error-text-color: #721C24;
            --error-border-color: #f5c6cb;
            --info-bg-color: #e2f0ff;
            --editor-bg: #eef2f7; 
            --editor-border: #cbd5e0;
        }

        body.dark-mode {
            --background-color: #121212;
            --card-background: #1E1E1E;
            --text-color: #E0E0E0;
            --label-color: #B0B0B0;
            --border-color: #333333;
            --error-bg-color: #4d2b30;
            --error-text-color: #f4a9b0;
            --error-border-color: #6e3a41;
            --info-bg-color: #1c2a38;
            --editor-bg: #2d3748;
            --editor-border: #4a5568;
        }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            line-height: 1.6; 
            margin: 0;
            padding: 15px; 
            padding-bottom: 100px; 
            background-color: var(--background-color); 
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            width: 100%;
            max-width: 1200px; 
            margin: 0 auto;
        }
        
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease-in-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 30px);
        }
        .card {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.07);
            width: 100%;
            max-width: 450px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .card-header { text-align: center; margin-bottom: 30px; }
        .card-header h2 { margin: 0 0 10px 0; font-size: 1.6em; font-weight: 700; color: var(--text-color); }
        .card-header p { margin: 0; color: var(--label-color); }

        .spinner-container { text-align: center; }
        .spinner {
            width: 50px;
            height: 50px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner-container p { font-size: 1.1em; color: var(--label-color); }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--label-color); font-size: 0.9em; }
        .form-control {
            width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px;
            font-size: 1em; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s, color 0.3s;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .form-control:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); outline: none; }
        .form-control:disabled { background-color: #e9ecef; cursor: not-allowed; }
        body.dark-mode .form-control:disabled { background-color: #2c2f33; }

        .password-wrapper { position: relative; display: flex; align-items: center; }
        .password-wrapper input { padding-right: 40px; }
        .password-toggle-icon { position: absolute; right: 10px; cursor: pointer; color: var(--label-color); display: flex; align-items: center; justify-content: center; padding: 5px; border-radius: 50%; transition: background-color 0.2s, color 0.2s; }
        .password-toggle-icon:hover { background-color: rgba(0,0,0,0.05); color: var(--primary-color); }
        body.dark-mode .password-toggle-icon:hover { background-color: rgba(255,255,255,0.1); }
        .password-toggle-icon svg { width: 20px; height: 20px; stroke-width: 2; }

        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 10px 20px; border: none; border-radius: 8px;
            background-color: var(--primary-color); color: white; font-size: 0.9em; font-weight: 700;
            cursor: pointer; text-align: center; transition: background-color 0.3s, transform 0.2s, opacity 0.3s; text-decoration: none;
            box-sizing: border-box;
        }
        .btn:hover:not([disabled]) { background-color: var(--primary-hover); transform: translateY(-2px); }
        .btn:active:not([disabled]) { transform: translateY(0); }
        .btn-full { width: 100%; }
        
        .btn:disabled, .btn.disabled { background-color: #ccc; cursor: not-allowed; transform: none; opacity: 0.6; pointer-events: none; }
        body.dark-mode .btn:disabled, body.dark-mode .btn.disabled { background-color: #444; color: #888; }

        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--secondary-hover); }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover:not(:disabled) { background-color: var(--success-hover); }
        .btn-purple { background-color: var(--purple-color); }
        .btn-purple:hover:not(:disabled) { background-color: var(--purple-hover); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-hover); }
        .btn-info { background-color: var(--info-color); }
        .btn-info:hover:not(:disabled) { background-color: var(--info-hover); }

        .error-message { color: var(--danger-color); text-align: center; margin-top: 15px; font-size: 0.9em; display: none; }

        .title-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        #editor-view .main-title { text-align: center; font-weight: 700; font-size: 1.8em; margin: 0; flex-grow: 1; }
        .editor-top-bar { display: flex; justify-content: flex-end; align-items: center; width: 100%; gap: 10px;}
        .editor-top-bar p { margin: 0; font-size: 0.9em; color: var(--label-color);}
        
        .editor-header-grid { display: flex; gap: 20px; margin-bottom: 25px; }
        .editor-header-grid .editor-card { flex: 1; background-color: var(--card-background); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 12px; }
        .editor-header-grid .editor-card h3 { margin: 0 0 5px 0; font-size: 1.1em; font-weight: 700; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; color: var(--text-color); }
        .actions-card .header-btn { width: 100%; justify-content: center; }

        .identitas-item { font-size: 1.1em; font-weight: 500; color: var(--label-color); }
        .identitas-item strong { font-weight: 700; color: var(--text-color); }
        
        #file-input { display: none; }

        #soal-list-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; align-items: start; }
        @media (max-width: 900px) { #soal-list-container { grid-template-columns: 1fr; } }
        
        .soal-container {
            background-color: var(--card-background); 
            border: 8px solid #333; 
            border-radius: 30px; 
            padding: 20px 5mm; 
            margin-bottom: 0; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
            position: relative;
            box-sizing: border-box; 
            width: 100%;
            max-width: 100%; 
            margin: 0;
            aspect-ratio: 1 / 2; 
            overflow-y: auto; 
            overflow-x: hidden; 
            word-wrap: break-word; 
            overflow-wrap: break-word; 
            display: flex;
            flex-direction: column;
        }

        .soal-container::-webkit-scrollbar { width: 8px; }
        .soal-container::-webkit-scrollbar-track { background-color: transparent; margin-block: 20px; border-radius: 100vw; }
        .soal-container::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.2); border-radius: 100vw; border: 2px solid transparent; background-clip: content-box; transition: background-color 0.3s; }
        .soal-container::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.4); }
        body.dark-mode .soal-container::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); }
        body.dark-mode .soal-container::-webkit-scrollbar-thumb:hover { background-color: rgba(255, 255, 255, 0.4); }

        .soal-container.invalid-soal { border-color: var(--danger-color); box-shadow: 0 0 15px rgba(220, 53, 69, 0.4); }
        .soal-validation-error {
            color: var(--danger-color); font-size: 0.85em; font-weight: 500; margin-top: 15px; padding: 12px;
            background-color: var(--error-bg-color); border: 1px solid var(--error-border-color);
            border-radius: 6px; display: none; flex-shrink: 0; 
        }
        .soal-header { 
            display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border-color); 
            padding-bottom: 15px; margin-bottom: 20px; gap: 10px; flex-shrink: 0; position: sticky;
            top: -20px; background-color: var(--card-background); z-index: 10; margin-top: -10px; padding-top: 10px;
        }
        
        .soal-nomor-container { display: flex; align-items: center; gap: 5px; }
        .soal-nomor-input { 
            width: 60px; padding: 5px 8px; font-size: 1em; border: 2px solid var(--primary-color); border-radius: 8px; 
            margin-left: 8px; text-align: center; font-weight: 700; color: var(--primary-color); background-color: white;
            transition: all 0.3s; -moz-appearance: textfield; 
        }
        .soal-nomor-input::-webkit-outer-spin-button, .soal-nomor-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .soal-nomor-input:focus { outline: none; background-color: var(--primary-color); color: white; box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.2); }

        .drag-handle { display: grid; grid-template-columns: repeat(3, 6px); gap: 4px; padding: 10px; cursor: grab; border-radius: 5px; transition: background-color 0.2s; }
        .soal-actions { display: flex; gap: 8px; align-items: center; pointer-events: auto; }
        .delete-btn { font-size: 0.85em; padding: 6px 12px; font-weight: 500; }

        [contenteditable="true"] { 
            outline: none; background-color: var(--editor-bg); border: 1px solid var(--editor-border); 
            padding: 8px 10px; border-radius: 6px; transition: border-color 0.2s, background-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box; 
        }
        [contenteditable="true"]:focus { background-color: #ffffff; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15); }
        [contenteditable][data-placeholder]:empty:before { content: attr(data-placeholder); color: #9ca3af; pointer-events: none; display: block; }

        .soal-container ul { list-style-type: none; padding-left: 0; margin-top: 15px; margin-bottom: 0; }
        .soal-container li { padding: 8px 5px; margin-bottom: 5px; border-radius: 4px; display: flex; align-items: baseline; word-break: break-word; }
        .soal-container li b { margin-right: 8px; min-width: 18px; }
        .soal-container li div { width: 100%; max-width: 100%; }
        .soal-container .soal-pertanyaan { width: auto; max-width: 100%; margin-right: 5px; }
        
        .soal-kunci-jawaban { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); display: flex; align-items: center; font-weight: 700; }
        .soal-kunci-jawaban span { margin-right: 10px; color: var(--success-color); }

        .img-inline { max-height: 2.5em; width: auto; vertical-align: middle; cursor: pointer; max-width: 100%; }
        .img-block { display: block; height: auto; margin: 0.8em 0; cursor: pointer; max-width: 100%; }
        .resizable-wrapper { position: relative; display: inline-block; outline: 2px dashed var(--primary-color); line-height: 0; user-select: none; -webkit-user-select: none; vertical-align: middle; max-width: 100%; }
        .resizable-wrapper img { display: block; cursor: default !important; width: 100%; height: 100%; max-height: none; }
        
        .resizer { position: absolute; width: 6px; height: 6px; background-color: var(--primary-color); border: 1px solid var(--card-background); border-radius: 2px; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .resizer.top-left { top: -3px; left: -3px; cursor: nwse-resize; }
        .resizer.top-right { top: -3px; right: -3px; cursor: nesw-resize; }
        .resizer.bottom-left { bottom: -3px; left: -3px; cursor: nesw-resize; }
        .resizer.bottom-right { bottom: -3px; right: -3px; cursor: nwse-resize; }

        .sortable-ghost { opacity: 0.4; background-color: #c8ebfb; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s; }
        .modal-content { background-color: var(--card-background); padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: left; max-width: 450px; width: 90%; transform: scale(0.95); animation: zoomIn 0.3s forwards; }
        .modal-content h3 { margin-top: 0; text-align: center; }
        .modal-content p { margin-bottom: 25px; line-height: 1.6; white-space: pre-wrap; }
        .modal-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-actions button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 0; }
        .btn-confirm { background-color: var(--danger-color); color: white; }
        .btn-cancel { background-color: var(--secondary-color); color: white; }
        .confirmation-input-container { margin: 20px 0; }
        #delete-modal .modal-content { text-align: center; }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast { background-color: #333; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(-100%); transition: opacity 0.3s, transform 0.3s; font-size: 0.9em; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }

        .settings-btn { background: none; border: none; cursor: pointer; padding: 5px; }
        .settings-btn svg { width: 24px; height: 24px; stroke: var(--label-color); }
        .theme-options { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .theme-options button { flex-grow: 1; }
        
        #processing-modal .spinner-container p { font-size: 1.2em; color: white; font-weight: 500; }
        #processing-modal .spinner { border-top-color: white; border-left-color: white; }
        
        .instructions-box { background-color: var(--info-bg-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-top: 30px; font-size: 0.95em; }
        .instructions-box h3 { margin-top: 0; color: var(--text-color); font-size: 1.1em; }
        .instructions-box ol { padding-left: 20px; margin-bottom: 0; }
        .instructions-box li { margin-bottom: 10px; }
        
        .editor-toolbar {
            position: absolute; background-color: #2D3748; color: white; border-radius: 8px;
            padding: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1001;
            display: none; align-items: center; gap: 4px; transition: opacity 0.1s;
        }
        .editor-toolbar button { background: transparent; border: none; color: white; padding: 7px; cursor: pointer; border-radius: 5px; display: flex; align-items: center; justify-content: center; }
        .editor-toolbar button:hover { background-color: #4A5568; }
        .editor-toolbar button svg { width: 20px; height: 20px; fill: currentColor; }
        .editor-toolbar .separator { width: 1px; height: 20px; background-color: #4A5568; margin: 0 4px; }

        #global-save-container {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); z-index: 999;
            width: auto; min-width: 320px; background-color: var(--card-background);
            border: 1px solid var(--border-color); border-radius: 50px; padding: 10px 20px; margin: 0;
            text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            animation: slideUpFade 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes slideUpFade { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        #global-save-btn { font-size: 1em; padding: 10px 24px; border-radius: 30px; box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2); }

        @media (max-width: 768px) {
            .editor-header-grid { flex-direction: column; }
            #global-save-container { width: 90%; min-width: auto; bottom: 15px; }
        }
    </style>
</head>
<body>

<div class="container">

    <div id="editor-toolbar" class="editor-toolbar">
        <button data-command="undo" title="Undo (Ctrl+Z)"><svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg></button>
        <button data-command="redo" title="Redo (Ctrl+Y)"><svg viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 9 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.72.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg></button>
        <div class="separator"></div>
        <button data-command="bold" title="Bold (Ctrl+B)"><svg viewBox="0 0 24 24"><path d="M15.6 10.79c.97-.67 1.65-1.77 1.65-2.79 0-2.26-1.75-4-4-4H7v14h7.04c2.09 0 3.71-1.7 3.71-3.79 0-1.52-.86-2.82-2.15-3.42zM10 6.5h3c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-3v-3zm3.5 9H10v-3h3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z"/></svg></button>
        <button data-command="italic" title="Italic (Ctrl+I)"><svg viewBox="0 0 24 24"><path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z"/></svg></button>
        <button data-command="underline" title="Underline (Ctrl+U)"><svg viewBox="0 0 24 24"><path d="M12 17c3.31 0 6-2.69 6-6V3h-2.5v8c0 1.93-1.57 3.5-3.5 3.5S8.5 12.93 8.5 11V3H6v8c0 3.31 2.69 6 6 6zm-7 2v2h14v-2H5z"/></svg></button>
        <div class="separator"></div>
        <button data-command="insertImage" title="Upload Gambar"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></button>
    </div>
    <input type="file" id="toolbar-image-input" accept="image/*" style="display: none;">

    <!-- UI: Loading -->
    <div id="loading-view" class="view active">
        <div class="card-wrapper">
            <div class="spinner-container">
                <div class="spinner"></div>
                <p id="loading-text">Mempersiapkan Aplikasi & Login...</p>
                <p id="loading-error" class="error-message"></p>
            </div>
        </div>
    </div>

    <!-- UI: Login -->
    <div id="guru-login-view" class="view">
        <div class="card-wrapper">
            <div class="card">
                <div class="card-header">
                    <h2>LOGIN GURU</h2>
                    <p>Silakan masuk menggunakan akun Anda</p>
                </div>
                <form id="guru-login-form">
                    <div class="form-group">
                        <label for="guru-username">Username</label>
                        <input type="text" id="guru-username" class="form-control" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="guru-password">Password</label>
                        <div class="password-wrapper">
                            <input type="password" id="guru-password" class="form-control" required autocomplete="current-password">
                            <span id="toggle-password-btn" class="password-toggle-icon" title="Lihat Password">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            </span>
                        </div>
                    </div>
                    <button id="guru-login-btn" type="submit" class="btn btn-full">Login</button>
                    <p id="guru-login-error" class="error-message"></p>
                </form>
            </div>
        </div>
    </div>

    <!-- UI: Selection -->
    <div id="selection-view" class="view">
        <div class="card-wrapper">
            <div class="card">
                <div class="card-header">
                    <h2>IDENTITAS SOAL</h2>
                    <p>Lengkapi semua informasi di bawah</p>
                </div>
                <form id="selection-form">
                    <div class="form-group">
                        <label for="tahun-ajaran-select">Tahun Ajaran</label>
                        <select id="tahun-ajaran-select" class="form-control" required></select>
                    </div>
                    <div class="form-group">
                        <label for="ujian-select">Ujian</label>
                        <select id="ujian-select" class="form-control" required>
                            <option value="" disabled selected>Pilih jenis asesmen...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="kelas-select">Kelas</label>
                        <select id="kelas-select" class="form-control" required>
                             <option value="" disabled selected>Pilih kelas...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mapel-select">Mata Pelajaran</label>
                        <select id="mapel-select" class="form-control" required>
                            <option value="" disabled selected>Pilih mata pelajaran...</option>
                        </select>
                    </div>
                    <button id="save-selection-btn" class="btn btn-full" disabled>Simpan & Lanjutkan</button>
                </form>
            </div>
        </div>
    </div>

    <!-- UI: Editor Utama -->
    <div id="editor-view" class="view">
        <div class="title-container">
            <h1 class="main-title">EDITOR BANK SOAL</h1>
            <div class="editor-top-bar">
                <p>Login sebagai: <strong id="guru-name-display"></strong></p>
                <button id="back-to-selection-btn" class="btn btn-info">Ganti Data Ujian</button>
                <button id="logout-btn" class="btn btn-secondary">Logout</button>
                <button class="settings-btn" id="settings-btn" title="Pengaturan Tampilan"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
            </div>
        </div>
        
        <div class="editor-header-grid">
            <div class="editor-card identitas-card">
                <h3>Data Ujian</h3>
                <div class="identitas-item">Ujian: <strong id="info-ujian"></strong></div>
                <div class="identitas-item">Tahun Ajaran: <strong id="info-ta"></strong></div>
                <div class="identitas-item">Kelas: <strong id="info-kelas"></strong></div>
                <div class="identitas-item">Mata Pelajaran: <strong id="info-mapel"></strong></div>
            </div>
            <div class="editor-card actions-card">
                 <h3>Aksi Global</h3>
                 <button id="add-soal-btn" class="btn btn-success header-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg><span>Tambah Soal</span></button>
                 <a href="https://drive.google.com/uc?export=download&id=11J15X750WGz3QeXO8sxcWSzRyfoDkJLb" target="_blank" id="template-zip-btn" class="btn btn-purple header-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg><span>Template Word</span></a>
                 <button id="upload-btn" class="btn btn-primary header-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg><span>Unggah ZIP (Word/WPS)</span></button>
                 <button id="clear-data-btn" class="btn btn-danger header-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg><span>Hapus Semua</span></button>
            </div>
        </div>

        <input id="file-input" type="file" accept=".zip" />
        
        <div id="global-save-container" style="display: none;">
            <button id="global-save-btn" class="btn btn-success" disabled title="Harap perbaiki semua soal yang tidak valid sebelum mengirim.">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8.5 1.5A.5.5 0 0 1 9 2v4.5A1.5 1.5 0 0 1 7.5 8h-1A1.5 1.5 0 0 1 5 6.5V2a.5.5 0 0 1 .5-.5h3z"/><path d="M14.354 4.354a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7 11.293l6.646-6.647a.5.5 0 0 1 .708 0z"/><path d="M.5 1a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1H.5z"/></svg>
                <span>Kirim & Simpan Semua ke Server</span>
            </button>
        </div>

        <div id="soal-list-container"></div>

        <div class="instructions-box">
            <h3>Petunjuk</h3>
            <ol>
                <li><strong>Universal Upload:</strong> Fitur unggah ZIP sekarang mendukung file dari WPS Office, Microsoft Word (semua versi), dan Windows versi lama. Sistem akan otomatis memperbaiki karakter aneh dan mendeteksi daftar soal otomatis.</li>
                <li><strong>Template Word:</strong> Gunakan template yang disediakan untuk hasil terbaik, tapi file hasil "Save as Web Page" biasa juga bisa diterima.</li>
                <li><strong>Simpan:</strong> Pastikan tidak ada soal berwarna merah sebelum menekan tombol Kirim & Simpan.</li>
            </ol>
        </div>
    </div>
</div>

<!-- Modal dan Overlay (Tetap sama) -->
<div id="confirm-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="confirm-modal-title">Konfirmasi</h3>
        <p id="confirm-modal-text">Apakah Anda yakin?</p>
        <div class="modal-actions">
            <button id="modal-cancel-confirm" class="btn-cancel">Batal</button>
            <button id="modal-confirm-action" class="btn-confirm">Ya, Lanjutkan</button>
        </div>
    </div>
</div>

<div id="delete-modal" class="modal-overlay">
    <div class="modal-content">
        <p id="delete-modal-text"></p>
        <div class="confirmation-input-container" style="display: none;">
            <label for="confirmation-input">Ketik "<strong id="confirmation-word"></strong>" untuk konfirmasi:</label>
            <input type="text" id="confirmation-input" class="form-control">
        </div>
        <div class="modal-actions">
            <button id="modal-confirm-delete" class="btn-confirm">Ya, Hapus</button>
            <button id="modal-cancel-delete" class="btn-cancel">Batal</button>
        </div>
    </div>
</div>

<div id="info-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="info-modal-title"></h3>
        <p id="info-modal-text"></p>
        <div class="modal-actions">
            <button id="info-modal-close" class="btn">Saya Mengerti</button>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Pengaturan Tampilan</h3>
        <div class="theme-options">
            <button class="btn" id="light-theme-btn">Mode Terang</button>
            <button class="btn" id="dark-theme-btn">Mode Gelap</button>
        </div>
    </div>
</div>

<div id="processing-modal" class="modal-overlay">
    <div class="spinner-container">
        <div class="spinner"></div>
        <p id="processing-text">Sedang memproses...</p>
    </div>
</div>

<div id="toast-container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDatabase, ref, set, get, remove, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
    
    // KONFIGURASI FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyBbXJ4VuACXyHJhl2eVSB2vHiT6hrx-XnE",
        authDomain: "setup-73809.firebaseapp.com",
        databaseURL: "https://setup-73809-default-rtdb.firebaseio.com",
        projectId: "setup-73809",
        storageBucket: "setup-73809.firebasestorage.app",
        messagingSenderId: "843995999446",
        appId: "1:843995999446:web:7fd92546f2d0bea73fed77"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const GITHUB_USERNAME = "speropa";
    const GITHUB_REPO = "gambarbanksoal";
    let githubToken = null;
    let loggedInGuru = null;

    let soalToDelete = null;
    let activeResizer = null;
    let currentSoalData = {};
    let initialSoalSnapshots = {};
    let ujiansDataCache = null;
    let aksesDataCache = null;

    // --- VARIABEL UI ---
    const editorToolbar = document.getElementById('editor-toolbar');
    const toolbarImageInput = document.getElementById('toolbar-image-input');
    let lastFocusedEditable = null;
    let savedSelection = null;
    let imageTargetElement = null;

    const loadingView = document.getElementById('loading-view');
    const loadingText = document.getElementById('loading-text');
    const loadingError = document.getElementById('loading-error');
    const guruLoginView = document.getElementById('guru-login-view');
    const guruLoginForm = document.getElementById('guru-login-form');
    const guruUsernameInput = document.getElementById('guru-username');
    const guruPasswordInput = document.getElementById('guru-password');
    const guruLoginBtn = document.getElementById('guru-login-btn');
    const guruLoginError = document.getElementById('guru-login-error');
    const togglePasswordBtn = document.getElementById('toggle-password-btn');

    const selectionView = document.getElementById('selection-view');
    const editorView = document.getElementById('editor-view');
    const selectionForm = document.getElementById('selection-form');
    const ujianSelect = document.getElementById('ujian-select');
    const tahunAjaranSelect = document.getElementById('tahun-ajaran-select');
    const kelasSelect = document.getElementById('kelas-select');
    const mapelSelect = document.getElementById('mapel-select');
    const saveSelectionBtn = document.getElementById('save-selection-btn');
    const guruNameDisplay = document.getElementById('guru-name-display');
    const logoutBtn = document.getElementById('logout-btn');
    const backToSelectionBtn = document.getElementById('back-to-selection-btn');

    const addSoalBtn = document.getElementById('add-soal-btn');
    const templateZipBtn = document.getElementById('template-zip-btn');
    const uploadBtn = document.getElementById('upload-btn');
    const clearDataBtn = document.getElementById('clear-data-btn');
    const fileInput = document.getElementById('file-input');
    const outputEl = document.getElementById('soal-list-container');
    const instructionsBox = document.querySelector('.instructions-box');
    const globalSaveContainer = document.getElementById('global-save-container');
    const globalSaveBtn = document.getElementById('global-save-btn');
    
    // --- MODAL VARIABEL ---
    const confirmModal = document.getElementById('confirm-modal');
    const confirmModalTitle = document.getElementById('confirm-modal-title');
    const confirmModalText = document.getElementById('confirm-modal-text');
    const confirmActionBtn = document.getElementById('modal-confirm-action');
    const cancelConfirmBtn = document.getElementById('modal-cancel-confirm');
    
    const deleteModal = document.getElementById('delete-modal');
    const confirmDeleteBtn = document.getElementById('modal-confirm-delete');
    const cancelDeleteBtn = document.getElementById('modal-cancel-delete');
    const modalText = document.getElementById('delete-modal-text');
    const confirmationInputContainer = document.querySelector('.confirmation-input-container');
    const confirmationInput = document.getElementById('confirmation-input');
    const confirmationWord = document.getElementById('confirmation-word');
    
    const toastContainer = document.getElementById('toast-container');
    const processingModal = document.getElementById('processing-modal');
    const processingText = document.getElementById('processing-text');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const lightThemeBtn = document.getElementById('light-theme-btn');
    const darkThemeBtn = document.getElementById('dark-theme-btn');
    const infoModal = document.getElementById('info-modal');
    const infoModalTitle = document.getElementById('info-modal-title');
    const infoModalText = document.getElementById('info-modal-text');
    const infoModalCloseBtn = document.getElementById('info-modal-close');

    // --- HELPER FUNCTIONS ---
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }
    
    function showProcessing(message) {
        processingText.textContent = message;
        processingModal.style.display = 'flex';
    }

    function hideProcessing() {
        processingModal.style.display = 'none';
    }
        
    let confirmCallback = null;
    function showConfirmModal(title, text, confirmText, confirmClass, callback) {
        confirmModalTitle.textContent = title;
        confirmModalText.textContent = text;
        confirmActionBtn.textContent = confirmText;
        
        confirmActionBtn.className = 'btn';
        confirmActionBtn.classList.add(confirmClass);

        confirmCallback = callback;
        confirmModal.style.display = 'flex';
    }

    function showInfoOverlay(title, text) {
        infoModalTitle.textContent = title;
        infoModalText.textContent = text;
        infoModal.style.display = 'flex';
    }

    function getDbPath(data) {
        const { tahunAjaran, ujian, kelas, mapel } = data;
        const safeTA = tahunAjaran.replace(/[\.\#\$\[\]\/]/g, '-');
        const safeUjian = ujian.replace(/\s+/g, '-');
        const safeMapel = mapel.replace(/\s+/g, '-');
        return `ujian/${safeTA}/${safeUjian}/Kelas-${kelas}/${safeMapel}`;
    }

    // --- FIREBASE & AUTH LOGIC ---
    async function fetchGithubToken() {
        try {
            const tokenRef = ref(db, 'github/token');
            const snapshot = await get(tokenRef);
            if (snapshot.exists()) {
                githubToken = snapshot.val();
                console.log("GitHub token successfully fetched.");
                return true;
            } else {
                throw new Error("Token GitHub tidak ditemukan di database.");
            }
        } catch (error) {
            console.error("Gagal mengambil token GitHub:", error);
            loadingError.textContent = `Gagal mengambil token GitHub: ${error.message}`;
            loadingError.style.display = 'block';
            return false;
        }
    }

    async function performAutoLogin() {
        const email = "speropa@gmail.com";
        const password = "Pajangan201184*";
        loadingError.style.display = 'none';

        try {
            loadingText.textContent = 'Login ke sistem...';
            await signInWithEmailAndPassword(auth, email, password);
            console.log("Successfully logged in.");

            loadingText.textContent = 'Mengambil konfigurasi keamanan...';
            const tokenFetched = await fetchGithubToken();
            if (tokenFetched) {
                showView('guru-login-view');
            }

        } catch (error) {
            loadingError.textContent = `Login Otomatis Gagal: ${error.message}`;
            loadingError.style.display = 'block';
            console.error("Auto-login failed:", error);
        }
    }
    
    // --- EVENT LISTENERS UI ---
    if (togglePasswordBtn) {
        togglePasswordBtn.addEventListener('click', () => {
            const type = guruPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            guruPasswordInput.setAttribute('type', type);
            if (type === 'text') {
                togglePasswordBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`;
                togglePasswordBtn.setAttribute('title', 'Sembunyikan Password');
            } else {
                togglePasswordBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
                togglePasswordBtn.setAttribute('title', 'Lihat Password');
            }
        });
    }

    guruLoginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = guruUsernameInput.value.trim();
        const password = guruPasswordInput.value;
        guruLoginError.style.display = 'none';
        
        guruLoginBtn.disabled = true;
        guruLoginBtn.textContent = 'Mencoba Login...';

        try {
            const gurusRef = ref(db, 'gurus');
            const snapshot = await get(gurusRef);

            if (!snapshot.exists()) throw new Error("Tidak ada data guru yang ditemukan.");

            const gurusData = snapshot.val();
            let foundGuru = null;

            for (const [id, guru] of Object.entries(gurusData)) {
                if (guru.username === username && guru.password === password) {
                    foundGuru = { id, ...guru };
                    break;
                }
            }

            if (foundGuru) {
                loggedInGuru = foundGuru;
                guruNameDisplay.textContent = loggedInGuru.nama;
                showToast(`Selamat datang, ${loggedInGuru.nama}!`, 'success');
                showView('loading-view');
                loadingText.textContent = 'Memuat data hak akses...';
                await populateSelectionDropdowns();
                showView('selection-view');
            } else {
                throw new Error("Username atau Password salah.");
            }

        } catch (error) {
            guruLoginError.textContent = error.message;
            guruLoginError.style.display = 'block';
        } finally {
            guruLoginBtn.disabled = false;
            guruLoginBtn.textContent = 'Login';
        }
    });

    // --- ZIP PROCESSING LOGIC (NEW UNIVERSAL) ---
    // Logika ini menggantikan processZipFile lama agar bisa baca WPS/Word List
    
    uploadBtn.addEventListener('click', () => fileInput.click() );
    
    fileInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        showProcessing(`Memproses file universal: ${file.name}...`);
        try {
            await processZipFileUniversal(file);
            updateUIForSoalPresence();
        } catch (error) {
            console.error("Gagal memproses file ZIP:", error);
            showToast(`Gagal: ${error.message}`, 'error');
        } finally {
            fileInput.value = '';
            hideProcessing();
        }
    });

    async function processZipFileUniversal(file) {
        outputEl.innerHTML = '';
        initialSoalSnapshots = {};
        if (activeResizer) removeResizer();

        const zip = await JSZip.loadAsync(file);
        
        // 1. Cari File HTML
        const htmlFiles = Object.keys(zip.files).filter(name => name.match(/\.(htm|html)$/i) && !name.startsWith('__MACOSX'));
        if (htmlFiles.length === 0) throw new Error("Tidak ada file HTML dalam ZIP.");

        // Prioritaskan file di root (biasanya bukan file header/footer)
        htmlFiles.sort((a, b) => a.split('/').length - b.split('/').length);
        
        let questions = [];
        let validHtmlFound = false;

        for (const htmlFileName of htmlFiles) {
            // 2. Smart Encoding Detection
            const fileData = await zip.file(htmlFileName).async('uint8array');
            let htmlContent = new TextDecoder('windows-1252').decode(fileData);
            
            // Jika encoding salah (simbol aneh), coba UTF-8
            if (htmlContent.includes('') || !htmlContent.match(/<table/i)) {
                const textUtf8 = new TextDecoder('utf-8').decode(fileData);
                if (textUtf8.match(/<table/i)) {
                    htmlContent = textUtf8;
                }
            }

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            
            // 3. Proses Gambar (Pre-load Base64)
            const images = doc.getElementsByTagName('img');
            for (let img of images) {
                const src = img.getAttribute('src');
                if (src && !src.startsWith('data:') && !src.startsWith('http')) {
                    const imgFileName = src.split('/').pop(); 
                    const zipImgPath = Object.keys(zip.files).find(n => n.endsWith(imgFileName));
                    
                    if (zipImgPath) {
                        const imgExt = zipImgPath.split('.').pop().toLowerCase();
                        const imgData = await zip.file(zipImgPath).async('base64');
                        let mime = 'image/jpeg';
                        if (imgExt === 'png') mime = 'image/png';
                        else if (imgExt === 'gif') mime = 'image/gif';
                        
                        img.src = `data:${mime};base64,${imgData}`;
                        img.dataset.fileName = imgFileName; // Simpan nama asli untuk referensi upload
                    }
                }
                // Hapus style bawaan word agar responsif
                img.removeAttribute('width');
                img.removeAttribute('height');
                img.style.width = '';
                img.style.height = '';
                img.style.maxWidth = '100%';
            }

            // 4. Ekstraksi Soal (Universal Logic)
            const extracted = extractQuestionsUniversal(doc.body);
            if (extracted.length > 0) {
                questions = extracted;
                validHtmlFound = true;
                break; 
            }
        }

        if (!validHtmlFound) throw new Error("Tidak ditemukan format soal yang valid (Tabel Soal & Kunci).");

        // 5. Render ke UI
        questions.forEach(q => {
            const soalDiv = createSoalElement(q.detail, q.kunci, q.nomor);
            soalDiv.dataset.isNew = 'true';
            outputEl.appendChild(soalDiv);
        });
        
        createInitialSnapshots();
        prioritizeInvalidSoal();
        checkAllValidityAndUpdateSaveButton();
        initializeSortable();
        showToast(`Berhasil memuat ${questions.length} soal!`, 'success');
    }

    function extractQuestionsUniversal(body) {
        const results = [];
        const tables = body.getElementsByTagName('table');
        let questionCounter = 0;

        for (let t = 0; t < tables.length; t++) {
            const rows = tables[t].rows;
            
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].cells;
                let contentCell = null;
                
                // Cari sel yang berisi Konten Soal (teks panjang atau gambar atau list)
                for (let c = 0; c < cells.length; c++) {
                    const txt = cells[c].textContent.trim();
                    const hasImg = cells[c].querySelector('img');
                    const hasList = cells[c].querySelector('ol, ul');
                    
                    // Asumsi: Sel soal punya konten > 5 char ATAU punya gambar ATAU punya list
                    // Dan bukan sel nomor (biasanya sempit dan cuma angka)
                    if ((txt.length > 5 || hasImg || hasList) && !txt.match(/^\d+$/)) {
                        contentCell = cells[c];
                        break; 
                    }
                }

                if (!contentCell) continue;

                // Validasi: Apakah ini baris soal PG? Harus ada opsi A,B,C,D
                const innerHTML = contentCell.innerHTML;
                const hasManualOptions = innerHTML.match(/[A-Da-d][\.\)]/); // A. atau A)
                const hasList = contentCell.querySelector('ol, ul');
                
                if (!hasManualOptions && !hasList) continue; // Skip jika tidak ada tanda-tanda PG

                // Cari Kunci Jawaban di baris berikutnya (i+1)
                let kunci = '';
                if (i + 1 < rows.length) {
                    const nextRowText = rows[i+1].textContent.trim();
                    const matchKunci = nextRowText.match(/(?:Kunci|Jawaban|Key)\s*[:]?\s*([A-D])/i) || nextRowText.match(/^\s*([A-D])\s*$/i);
                    if (matchKunci) {
                        kunci = matchKunci[1].toUpperCase();
                        i++; // Skip baris kunci agar tidak diproses ulang
                    }
                }

                // Parsing Konten
                const parsed = parseQuestionContent(contentCell);
                
                // Minimal ada pertanyaan dan 2 opsi
                if (parsed.opsi.length >= 2) {
                    questionCounter++;
                    
                    const soalDetail = {
                        pertanyaan: parsed.soal,
                        pilihanA: parsed.opsi[0] || '',
                        pilihanB: parsed.opsi[1] || '',
                        pilihanC: parsed.opsi[2] || '',
                        pilihanD: parsed.opsi[3] || ''
                    };

                    results.push({
                        detail: soalDetail,
                        kunci: kunci,
                        nomor: questionCounter
                    });
                }
            }
        }
        return results;
    }

    function parseQuestionContent(cell) {
        const div = document.createElement('div');
        div.innerHTML = cell.innerHTML; // Clone content

        const options = [];
        let currentOptIdx = 0;

        // 1. Cek LIST AUTOMATIC (OL/UL) - Ini yg sering dipakai Word modern/WPS
        const lists = div.querySelectorAll('ol, ul');
        lists.forEach(list => {
            const items = list.querySelectorAll('li');
            // Cek apakah list ini berisi opsi (pendek-pendek atau jumlahnya 4-5)
            // Asumsi: List di dalam soal biasanya adalah opsi jawaban
            items.forEach(li => {
                if (currentOptIdx < 5) {
                    options.push(cleanHtml(li.innerHTML));
                    currentOptIdx++;
                }
                li.remove(); // Hapus dari konten pertanyaan
            });
            list.remove();
        });

        // 2. Cek LIST MANUAL (A. Teks...) - Untuk Word lama/Manual typing
        if (options.length === 0) {
            const children = Array.from(div.children); // p, div, etc
            const manualOptRegex = /^\s*([A-Ea-e])[\.\)]\s+(.*)/;

            children.forEach(child => {
                const text = child.textContent.trim();
                const match = text.match(manualOptRegex);
                
                if (match) {
                    // Simpan teks opsinya saja (tanpa huruf A.)
                    options.push(cleanHtml(match[2] || child.innerHTML.replace(/^[A-Ea-e][\.\)]/, '')));
                    child.remove(); // Hapus dari konten pertanyaan
                }
            });
        }

        // Sisa konten di 'div' adalah Pertanyaan
        let questionHtml = cleanHtml(div.innerHTML);

        return {
            soal: questionHtml,
            opsi: options
        };
    }

    function cleanHtml(html) {
        if (!html) return "";
        // Sanitasi dasar untuk menghapus style Word yang mengganggu layout
        return html
            .replace(/class="[^"]*"/g, "") // Hapus class word
            .replace(/style="[^"]*"/g, "") // Hapus inline style word (font-family, margin aneh)
            .replace(/<span[^>]*>/g, "<span>")
            .replace(/<p>\s*<\/p>/g, "")
            .replace(/&nbsp;/g, " ")
            .trim();
    }

    // --- END UNIVERSAL LOGIC ---

    // --- FUNGSI EXISTING (Firebase Save, UI, dll) TETAP SAMA ---
    // (Bagian di bawah ini sama dengan kode sebelumnya untuk menjaga fitur)
    
    async function populateSelectionDropdowns() {
        try {
            if (!ujiansDataCache || !aksesDataCache) {
                const customUjiansRef = ref(db, 'customUjians');
                const aksesRef = ref(db, `akses/${loggedInGuru.id}`);

                const [ujiansSnapshot, aksesSnapshot] = await Promise.all([
                    get(customUjiansRef),
                    get(aksesRef)
                ]);
                
                if (!ujiansSnapshot.exists()) throw new Error("Data Ujian tidak ditemukan.");
                if (!aksesSnapshot.exists()) throw new Error("Data hak akses untuk guru ini tidak ditemukan.");
                
                ujiansDataCache = ujiansSnapshot.val();
                aksesDataCache = aksesSnapshot.val();
            }

            tahunAjaranSelect.innerHTML = '<option value="" disabled selected>Pilih tahun ajaran...</option>';
            ujianSelect.innerHTML = '<option value="" disabled selected>Pilih jenis asesmen...</option>';
            kelasSelect.innerHTML = '<option value="" disabled selected>Pilih kelas...</option>';
            mapelSelect.innerHTML = '<option value="" disabled selected>Pilih mata pelajaran...</option>';
            
            ujianSelect.disabled = true;
            kelasSelect.disabled = true;
            mapelSelect.disabled = true;

            Object.keys(ujiansDataCache).sort().reverse().forEach(tahun => {
                const examsInYear = ujiansDataCache[tahun];
                const hasActiveExam = Object.values(examsInYear).some(exam => exam.active === true);
                if (hasActiveExam) {
                    const option = document.createElement('option');
                    option.value = tahun;
                    option.textContent = tahun;
                    tahunAjaranSelect.appendChild(option);
                }
            });
            tahunAjaranSelect.disabled = false;
            
        } catch (error) {
            console.error("Gagal memuat dropdown:", error);
            showToast(`Error: ${error.message}`, "error");
            showView('guru-login-view');
        }
    }

    function initializeSelectionListeners() {
        tahunAjaranSelect.addEventListener('change', () => {
            const selectedTahun = tahunAjaranSelect.value;
            ujianSelect.innerHTML = '<option value="" disabled selected>Pilih jenis asesmen...</option>';
            ujianSelect.value = '';
            ujianSelect.disabled = true;

            if (selectedTahun && ujiansDataCache[selectedTahun]) {
                const examsInYear = ujiansDataCache[selectedTahun];
                Object.values(examsInYear).forEach(exam => {
                    if (exam.active === true) {
                        const option = document.createElement('option');
                        option.value = exam.name;
                        option.textContent = exam.name;
                        ujianSelect.appendChild(option);
                    }
                });
                ujianSelect.disabled = false;
            }
            
            kelasSelect.value = '';
            mapelSelect.innerHTML = '<option value="" disabled selected>Pilih mata pelajaran...</option>';
            kelasSelect.disabled = true;
            mapelSelect.disabled = true;
            validateSelectionForm();
        });

        ujianSelect.addEventListener('change', () => {
            kelasSelect.innerHTML = '<option value="" disabled selected>Pilih kelas...</option>';
            if (ujianSelect.value) {
                const uniqueKelas = [...new Set(aksesDataCache.map(item => item.kelas))].sort();
                uniqueKelas.forEach(kelas => {
                    const option = document.createElement('option');
                    option.value = kelas;
                    option.textContent = kelas;
                    kelasSelect.appendChild(option);
                });
                kelasSelect.disabled = false;
            } else {
                 kelasSelect.disabled = true;
            }
            mapelSelect.innerHTML = '<option value="" disabled selected>Pilih mata pelajaran...</option>';
            mapelSelect.disabled = true;
            validateSelectionForm();
        });

        kelasSelect.addEventListener('change', () => {
            const selectedKelas = kelasSelect.value;
            mapelSelect.innerHTML = '<option value="" disabled selected>Pilih mata pelajaran...</option>';
            mapelSelect.value = '';
            mapelSelect.disabled = true;

            if (selectedKelas) {
                const mapelForKelas = aksesDataCache
                    .filter(item => item.kelas === selectedKelas)
                    .map(item => item.mapel)
                    .sort();
                
                mapelForKelas.forEach(mapel => {
                    const option = document.createElement('option');
                    option.value = mapel;
                    option.textContent = mapel;
                    mapelSelect.appendChild(option);
                });
                mapelSelect.disabled = false;
            }
            validateSelectionForm();
        });
    }

    function validateSelectionForm() {
        saveSelectionBtn.disabled = !selectionForm.checkValidity();
    }

    selectionForm.addEventListener('input', validateSelectionForm);

    saveSelectionBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        validateSelectionForm();
        if (saveSelectionBtn.disabled) {
            showToast('Harap lengkapi semua isian identitas soal.', 'error');
            return;
        }

        const ujian = ujianSelect.value;
        const tahunAjaran = tahunAjaranSelect.value;
        const kelas = kelasSelect.value;
        const mapel = mapelSelect.value;
        
        currentSoalData = { ujian, tahunAjaran, kelas, mapel };
        
        document.getElementById('info-ujian').textContent = ujian;
        document.getElementById('info-ta').textContent = tahunAjaran;
        document.getElementById('info-kelas').textContent = kelas;
        document.getElementById('info-mapel').textContent = mapel;
        
        showView('loading-view');
        loadingText.textContent = 'Mencari data soal yang sudah ada...';
        
        await fetchAndRenderSoal();

        showView('editor-view');
    });
    
    async function fetchAndRenderSoal() {
        const dbPath = getDbPath(currentSoalData);
        const snapshot = await get(ref(db, dbPath));

        outputEl.innerHTML = ''; 

        if (snapshot.exists()) {
            const data = snapshot.val();
            renderSoalFromData(data);
            showToast(`Data berhasil dimuat. ${data.soal ? Object.keys(data.soal).length : 0} soal ditemukan.`, 'success');
        } else {
            showToast('Tidak ada data ditemukan. Silakan unggah file ZIP untuk memulai.', 'info');
        }
        updateUIForSoalPresence();
    }
    
    function renderSoalFromData(data) {
        if (!data.soal) return;

        Object.keys(data.soal).sort((a, b) => parseInt(a) - parseInt(b)).forEach(nomor => {
            const soalDetail = data.soal[nomor];
            const kunci = soalDetail.kunciJawaban || '';
            const soalDiv = createSoalElement(soalDetail, kunci, nomor);
            outputEl.appendChild(soalDiv);
        });

        createInitialSnapshots();
        prioritizeInvalidSoal();
        checkAllValidityAndUpdateSaveButton();
        initializeSortable();
    }

    // --- IMAGE & GITHUB ---
    async function uploadImageToGithub(file, base64Content) {
        if (!githubToken) {
            showToast('Token keamanan tidak valid.', 'error');
            throw new Error('GitHub token is not available.');
        }
        const fileName = `${Date.now()}-${file.name}`;
        const { tahunAjaran, ujian, kelas, mapel } = currentSoalData;
        const safeTA = tahunAjaran.replace('/', '-');
        const safeUjian = ujian.replace(/\s+/g, '-');
        const safeMapel = mapel.replace(/\s+/g, '-');
        const safePath = `${safeTA}/${safeUjian}/Kelas-${kelas}/${safeMapel}`;
        const path = `${safePath}/${fileName}`;

        const data = {
            message: `Upload gambar soal: ${fileName}`,
            content: base64Content,
        };
        const response = await fetch(
            `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${path}`,
            {
                method: 'PUT',
                headers: { 'Authorization': `token ${githubToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            }
        );
        const result = await response.json();
        if (!response.ok) throw new Error(`Gagal mengunggah: ${result.message}`);
        return result.content.download_url;
    }

    async function deleteImageFromGithub(imageUrl) {
        if (!githubToken || !imageUrl || !imageUrl.includes('raw.githubusercontent.com')) return;
        const path = imageUrl.split(`${GITHUB_USERNAME}/${GITHUB_REPO}/main/`)[1];
        if (!path) return;

        try {
            const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${path}`, {
                headers: { 'Authorization': `token ${githubToken}` }
            });
            const fileData = await res.json();
            if (!res.ok) {
                if (res.status === 404) return;
                throw new Error(`Gagal mendapatkan SHA file: ${fileData.message}`);
            }

            await fetch(fileData.url, {
                method: 'DELETE',
                headers: { 'Authorization': `token ${githubToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Hapus gambar: ${fileData.name}`, sha: fileData.sha })
            });
        } catch (error) {
            console.error(`Gagal menghapus gambar: ${imageUrl}`, error);
        }
    }
    
    // --- SOAL DOM MANIPULATION ---
    function createSoalElement(soalDetail, kunci, nomor) {
        const soalDiv = document.createElement('div');
        soalDiv.className = 'soal-container';
        soalDiv.dataset.nomor = nomor;
        
        soalDiv.innerHTML = `
            <div class="soal-header">
                <div class="soal-nomor-container">
                    <h3 class="soal-nomor">Soal 
                        <input type="number" class="soal-nomor-input" value="${nomor}" min="1">
                    </h3>
                </div>
                <div class="drag-handle"><span></span><span></span><span></span><span></span><span></span><span></span></div>
                <div class="soal-actions">
                    <button class="btn delete-btn btn-danger">Hapus</button>
                </div>
            </div>
            <div class="soal-pertanyaan" contenteditable="true" data-placeholder="Ketik pertanyaan di sini...">${soalDetail.pertanyaan}</div>
            <ul>
                <li><b>A.</b> <div contenteditable="true" dir="auto">${soalDetail.pilihanA}</div></li>
                <li><b>B.</b> <div contenteditable="true" dir="auto">${soalDetail.pilihanB}</div></li>
                <li><b>C.</b> <div contenteditable="true" dir="auto">${soalDetail.pilihanC}</div></li>
                <li><b>D.</b> <div contenteditable="true" dir="auto">${soalDetail.pilihanD}</div></li>
            </ul>
            <div class="soal-kunci-jawaban">
                <span>Kunci Jawaban:</span>
                <div contenteditable="true" dir="auto">${kunci}</div>
            </div>
            <div class="soal-validation-error"></div>
        `;
        
        const nomorInput = soalDiv.querySelector('.soal-nomor-input');
        nomorInput.addEventListener('change', sortSoalByInput);
        
        classifyImages(soalDiv);
        return soalDiv;
    }

    function sortSoalByInput() {
        const container = document.getElementById('soal-list-container');
        const items = Array.from(container.children);
        items.sort((a, b) => {
            const valA = parseFloat(a.querySelector('.soal-nomor-input').value) || 0;
            const valB = parseFloat(b.querySelector('.soal-nomor-input').value) || 0;
            return valA - valB;
        });
        items.forEach(item => container.appendChild(item));
        renumberSoalDOM();
        showToast("Urutan soal diperbarui.", "info");
    }

    function classifyImages(containerElement) {
        containerElement.querySelectorAll('img').forEach(img => {
            if (img.style.width) {
                if (!img.style.height) img.style.height = 'auto';
                return;
            }
            img.classList.add('img-block');
            img.style.maxWidth = '100%';
        });
    }

    outputEl.addEventListener('click', function(e) {
        const soalContainer = e.target.closest('.soal-container');
        if (!soalContainer) return;

        const deleteBtn = e.target.closest('.delete-btn');
        if (deleteBtn) {
             soalToDelete = soalContainer;
             modalText.textContent = "Apakah Anda yakin ingin menghapus soal ini?";
             confirmationInputContainer.style.display = 'none';
             confirmDeleteBtn.disabled = false;
             confirmDeleteBtn.onclick = executeDeleteSoal;
             deleteModal.style.display = 'flex';
             return;
        }
        
        const isImage = e.target.tagName === 'IMG' && !e.target.closest('.resizable-wrapper');
        if (isImage) {
            makeImageResizable(e.target);
            e.stopPropagation();
        }
    });

    document.addEventListener('click', function(e) { if (activeResizer && !activeResizer.wrapper.contains(e.target)) removeResizer(); });
    cancelDeleteBtn.addEventListener('click', () => { deleteModal.style.display = 'none'; });
    infoModalCloseBtn.addEventListener('click', () => { infoModal.style.display = 'none'; });

    function executeDeleteSoal() {
        if (!soalToDelete) return;
        deleteModal.style.display = 'none';
        const nomorSoal = soalToDelete.dataset.nomor;
        soalToDelete.remove();
        delete initialSoalSnapshots[nomorSoal];
        renumberSoalDOM();
        updateUIForSoalPresence();
        checkAllValidityAndUpdateSaveButton();
    }
    
    function makeImageResizable(img) { 
        if (activeResizer) removeResizer();
        const wrapper = document.createElement('div'); 
        wrapper.className = 'resizable-wrapper'; 
        wrapper.style.width = img.style.width || `${img.offsetWidth}px`;
        wrapper.style.height = img.style.height || `${img.offsetHeight}px`;
        img.parentNode.insertBefore(wrapper, img); 
        wrapper.appendChild(img); 
        img.style.width = '100%'; img.style.height = '100%';
        ['top-left', 'top-right', 'bottom-left', 'bottom-right'].forEach(c => { 
            const h = document.createElement('div'); 
            h.className = 'resizer ' + c; wrapper.appendChild(h); 
            h.addEventListener('mousedown', startResize); 
            h.addEventListener('touchstart', startResize); 
        }); 
        activeResizer = { wrapper, img }; 
    }
    
    function removeResizer() { 
        if (activeResizer) { 
            const { wrapper, img } = activeResizer; 
            img.style.width = wrapper.style.width; img.style.height = wrapper.style.height; 
            img.classList.remove('img-inline', 'img-block');
            if (wrapper.parentNode) { wrapper.parentNode.insertBefore(img, wrapper); wrapper.remove(); }
            activeResizer = null; 
        } 
    }

    function startResize(e) { 
        e.preventDefault(); e.stopPropagation(); 
        const { wrapper, img } = activeResizer; 
        const aspectRatio = img.naturalWidth / img.naturalHeight;
        const startX = e.clientX || e.touches[0].clientX; 
        const startWidth = wrapper.offsetWidth; 
        function doResize(e) { 
            const currentX = e.clientX || e.touches[0].clientX; 
            let newWidth = startWidth + (currentX - startX); 
            if (newWidth > 20) { wrapper.style.width = newWidth + 'px'; wrapper.style.height = `${newWidth / aspectRatio}px`; }
        } 
        function stopResize() { 
            document.removeEventListener('mousemove', doResize); document.removeEventListener('mouseup', stopResize); 
            document.removeEventListener('touchmove', doResize); document.removeEventListener('touchend', stopResize); 
        } 
        document.addEventListener('mousemove', doResize); document.addEventListener('mouseup', stopResize); 
        document.addEventListener('touchmove', doResize); document.addEventListener('touchend', stopResize); 
    }
    
    function renumberSoalDOM() {
        document.querySelectorAll('#soal-list-container .soal-container').forEach((soalDiv, index) => {
            const newNumber = index + 1;
            const inputNomor = soalDiv.querySelector('.soal-nomor-input');
            if (inputNomor) inputNomor.value = newNumber;
            soalDiv.dataset.nomor = newNumber;
        });
    }

    function initializeSortable() { 
        new Sortable(outputEl, { 
            animation: 150, ghostClass: 'sortable-ghost', handle: '.drag-handle', 
            onEnd: function() { renumberSoalDOM(); checkAllValidityAndUpdateSaveButton(); showToast("Urutan soal diubah.", "info"); } 
        }); 
    }

    // --- TOOLBAR & EXECCOMMAND ---
    function saveSelection() {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) savedSelection = selection.getRangeAt(0);
    }

    function restoreSelection() {
        if (savedSelection) {
            const selection = window.getSelection();
            selection.removeAllRanges(); selection.addRange(savedSelection);
        }
    }

    // Fungsi sembunyikan toolbar
    function hideToolbar() {
        editorToolbar.style.display = 'none';
    }

    function showToolbar(element) {
        if (activeResizer) removeResizer();
        const rect = element.getBoundingClientRect();
        editorToolbar.style.display = 'flex';
        let top = window.scrollY + rect.top - editorToolbar.offsetHeight - 8;
        if (top < window.scrollY) top = window.scrollY + rect.bottom + 8;
        let left = window.scrollX + rect.left;
        editorToolbar.style.top = `${top}px`;
        editorToolbar.style.left = `${left}px`;
    }

    function initializeToolbar() {
        outputEl.addEventListener('focusin', (e) => {
            if (e.target.getAttribute('contenteditable') === 'true') {
                lastFocusedEditable = e.target;
                showToolbar(e.target);
            }
        });
        outputEl.addEventListener('focusout', (e) => { if (e.target.getAttribute('contenteditable') === 'true') saveSelection(); });

        // LOGIKA BARU: Klik di luar area editor/toolbar = tutup toolbar
        document.addEventListener('mousedown', (e) => {
            const clickedToolbar = editorToolbar.contains(e.target);
            const clickedEditable = e.target.closest('[contenteditable="true"]');
            const clickedInput = e.target === toolbarImageInput;

            // Jika klik bukan di toolbar, bukan di text editor, dan bukan input gambar -> Sembunyikan
            if (!clickedToolbar && !clickedEditable && !clickedInput) {
                hideToolbar();
            }
        });

        editorToolbar.addEventListener('mousedown', (e) => {
            e.preventDefault();
            const button = e.target.closest('button');
            if (!button) return;
            const command = button.dataset.command;
            const targetElement = lastFocusedEditable;
            if (!targetElement) return;

            if (command === 'insertImage') {
                imageTargetElement = targetElement;
                toolbarImageInput.click();
            } else {
                targetElement.focus();
                restoreSelection();
                document.execCommand(command, false, null);
            }
        });

        toolbarImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file || !imageTargetElement) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const imgHTML = `<img src="${event.target.result}" data-file-name="${file.name}">`;
                imageTargetElement.focus(); restoreSelection(); document.execCommand('insertHTML', false, imgHTML);
                classifyImages(imageTargetElement.closest('.soal-container'));
            };
            reader.readAsDataURL(file);
            toolbarImageInput.value = '';
        });
    }

    // --- SAVE LOGIC ---
    function updateUIForSoalPresence() {
        const hasSoal = outputEl.children.length > 0;
        instructionsBox.style.display = hasSoal ? 'none' : 'block';
        clearDataBtn.disabled = !hasSoal;
        globalSaveContainer.style.display = hasSoal ? 'block' : 'none';
        uploadBtn.disabled = hasSoal;
    }

    function getSoalSnapshot(soalDiv) {
        const extractImages = (element) => Array.from(element.querySelectorAll('img')).map(img => img.src);
        return {
            pertanyaan: soalDiv.querySelector('.soal-pertanyaan').innerHTML,
            pilihanA: soalDiv.querySelector('li:nth-child(1) div').innerHTML,
            pilihanB: soalDiv.querySelector('li:nth-child(2) div').innerHTML,
            pilihanC: soalDiv.querySelector('li:nth-child(3) div').innerHTML,
            pilihanD: soalDiv.querySelector('li:nth-child(4) div').innerHTML,
            kunci: soalDiv.querySelector('.soal-kunci-jawaban div').innerHTML,
            images: extractImages(soalDiv)
        };
    }

    function createInitialSnapshots() {
        initialSoalSnapshots = {};
        document.querySelectorAll('.soal-container').forEach(soalDiv => {
            const nomor = soalDiv.dataset.nomor;
            initialSoalSnapshots[nomor] = getSoalSnapshot(soalDiv);
        });
    }

    function validateSoal(soalDiv) {
        const errorMessages = [];
        const isContentEmpty = (el) => !el.textContent.trim() && !el.querySelector('img');

        if (isContentEmpty(soalDiv.querySelector('.soal-pertanyaan'))) errorMessages.push('Pertanyaan kosong.');
        if (isContentEmpty(soalDiv.querySelector('li:nth-child(1) div'))) errorMessages.push('Pilihan A kosong.');
        // ... cek pilihan lain ...
        const kunci = soalDiv.querySelector('.soal-kunci-jawaban div').textContent.trim().toUpperCase();
        if (!kunci || !['A','B','C','D'].includes(kunci)) errorMessages.push('Kunci harus A/B/C/D.');

        const errorEl = soalDiv.querySelector('.soal-validation-error');
        if (errorMessages.length > 0) {
            soalDiv.classList.add('invalid-soal');
            errorEl.innerHTML = `<strong>Masalah:</strong><br>${errorMessages.join('<br>')}`;
            errorEl.style.display = 'block';
            return false;
        } else {
            soalDiv.classList.remove('invalid-soal');
            errorEl.style.display = 'none';
            return true;
        }
    }

    function checkAllValidityAndUpdateSaveButton() {
        let allValid = true;
        document.querySelectorAll('.soal-container').forEach(soalDiv => {
            if (!validateSoal(soalDiv)) allValid = false;
        });
        globalSaveBtn.disabled = !allValid;
    }

    function prioritizeInvalidSoal() {
        const container = document.getElementById('soal-list-container');
        const items = Array.from(container.children);
        items.sort((a, b) => {
            const aInvalid = a.classList.contains('invalid-soal');
            const bInvalid = b.classList.contains('invalid-soal');
            if (aInvalid && !bInvalid) return -1;
            if (!aInvalid && bInvalid) return 1;
            return parseInt(a.dataset.nomor) - parseInt(b.dataset.nomor);
        });
        items.forEach(el => container.appendChild(el));
    }

    async function executeGlobalSave() {
        showProcessing('Menganalisis perubahan...');
        try {
            // 1. Delete Old Images Logic
            const currentSoalIds = new Set(Array.from(document.querySelectorAll('.soal-container')).map(el => el.dataset.nomor));
            const imagesToDelete = new Set();
            
            Object.keys(initialSoalSnapshots).forEach(nomor => {
                if (!currentSoalIds.has(nomor)) {
                    initialSoalSnapshots[nomor].images.forEach(img => { if (img.includes('github')) imagesToDelete.add(img); });
                }
            });

            // 2. Upload New Images Logic
            const soalElements = document.querySelectorAll('.soal-container');
            for (const soalDiv of soalElements) {
                const imgs = soalDiv.querySelectorAll('img');
                for (const img of imgs) {
                    if (img.src.startsWith('data:image')) {
                        const base64 = img.src.split(',')[1];
                        const name = img.dataset.fileName || 'image.png';
                        const url = await uploadImageToGithub({name}, base64);
                        img.src = url;
                    }
                }
            }

            // 3. Save to Firebase
            const soalObject = {};
            soalElements.forEach(soalDiv => {
                const nomor = soalDiv.dataset.nomor;
                soalObject[nomor] = {
                    pertanyaan: soalDiv.querySelector('.soal-pertanyaan').innerHTML,
                    pilihanA: soalDiv.querySelector('li:nth-child(1) div').innerHTML,
                    pilihanB: soalDiv.querySelector('li:nth-child(2) div').innerHTML,
                    pilihanC: soalDiv.querySelector('li:nth-child(3) div').innerHTML,
                    pilihanD: soalDiv.querySelector('li:nth-child(4) div').innerHTML,
                    kunciJawaban: soalDiv.querySelector('.soal-kunci-jawaban div').textContent.trim().toUpperCase()
                };
            });

            const allKunjab = Object.keys(soalObject).sort((a,b)=>a-b).map(n => soalObject[n].kunciJawaban).join(',');
            const finalData = { ...currentSoalData, soal: soalObject, kunjab: allKunjab, terakhirUpdate: new Date().toISOString() };
            
            await set(ref(db, getDbPath(currentSoalData)), finalData);

            // 4. Execute Delete
            for (const url of imagesToDelete) await deleteImageFromGithub(url);

            showToast('Berhasil disimpan!', 'success');
            createInitialSnapshots();
            
        } catch (error) {
            showToast(`Gagal: ${error.message}`, 'error');
        } finally {
            hideProcessing();
        }
    }

    addSoalBtn.addEventListener('click', () => {
        const nomor = document.querySelectorAll('.soal-container').length + 1;
        const div = createSoalElement({pertanyaan:'',pilihanA:'',pilihanB:'',pilihanC:'',pilihanD:''}, '', nomor);
        outputEl.appendChild(div);
        div.scrollIntoView({behavior:'smooth'});
        updateUIForSoalPresence();
        checkAllValidityAndUpdateSaveButton();
    });

    clearDataBtn.addEventListener('click', () => {
        modalText.textContent = "Hapus SEMUA data?";
        confirmationInputContainer.style.display = 'block';
        confirmationWord.textContent = "HAPUS";
        confirmationInput.value = '';
        confirmDeleteBtn.onclick = async () => {
            deleteModal.style.display = 'none';
            showProcessing('Menghapus...');
            try {
                await remove(ref(db, getDbPath(currentSoalData)));
                outputEl.innerHTML = '';
                showToast('Terhapus.', 'success');
                updateUIForSoalPresence();
            } catch(e) { showToast(e.message, 'error'); } 
            finally { hideProcessing(); }
        };
        deleteModal.style.display = 'flex';
    });

    settingsBtn.addEventListener('click', () => settingsModal.style.display = 'flex');
    settingsModal.addEventListener('click', (e) => { if(e.target===settingsModal) settingsModal.style.display='none'; });
    lightThemeBtn.addEventListener('click', () => { document.body.classList.remove('dark-mode'); localStorage.setItem('theme', 'light'); });
    darkThemeBtn.addEventListener('click', () => { document.body.classList.add('dark-mode'); localStorage.setItem('theme', 'dark'); });

    // --- INITIALIZATION ---
    function initialize() {
        performAutoLogin();
        initializeToolbar();
        initializeSelectionListeners();
        
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') document.body.classList.add('dark-mode');

        confirmActionBtn.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmModal.style.display = 'none';
        });
        cancelConfirmBtn.addEventListener('click', () => confirmModal.style.display = 'none');
        
        outputEl.addEventListener('input', (e) => {
            if (e.target.closest('[contenteditable]')) checkAllValidityAndUpdateSaveButton();
        });

        globalSaveBtn.addEventListener('click', () => {
            showConfirmModal('Simpan?', 'Data akan dikirim ke server.', 'Ya', 'btn-success', executeGlobalSave);
        });
    }

    initialize();
</script>
</body>
</html>
